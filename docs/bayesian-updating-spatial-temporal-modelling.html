<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Bayesian Updating &amp; Spatial Temporal Modelling | GEOG0125: Advanced Topics in Social Geographic Data Science</title>
  <meta name="description" content="6 Bayesian Updating &amp; Spatial Temporal Modelling | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Bayesian Updating &amp; Spatial Temporal Modelling | GEOG0125: Advanced Topics in Social Geographic Data Science" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="6 Bayesian Updating &amp; Spatial Temporal Modelling | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  <meta name="github-repo" content="UCLPG-MSC-SGDS/GEOG0125" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Bayesian Updating &amp; Spatial Temporal Modelling | GEOG0125: Advanced Topics in Social Geographic Data Science" />
  
  <meta name="twitter:description" content="6 Bayesian Updating &amp; Spatial Temporal Modelling | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian-spatial-modelling-for-areal-data-in-stan.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/vembedr-0.1.5/css/vembedr.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="assets/custom.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo">
<a href="https://www.ucl.ac.uk/module-catalogue/modules/advanced-topics-in-social-and-geographic-data-science-GEOG0125"><img src="images/general/ucl_logo.png">
</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#description"><i class="fa fa-check"></i>Description</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#timetable-and-key-locations"><i class="fa fa-check"></i>Timetable and key locations</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contact-details"><i class="fa fa-check"></i>Contact details</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html"><i class="fa fa-check"></i>Reading List for GEOG0125</a>
<ul>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-1-introduction-to-bayesian-inference"><i class="fa fa-check"></i>Week 1: Introduction to Bayesian Inference</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-2-bayesian-generalised-linear-models-glms"><i class="fa fa-check"></i>Week 2: Bayesian Generalised Linear Models (GLMs)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-3-bayesian-hierarchical-models"><i class="fa fa-check"></i>Week 3: Bayesian Hierarchical Models</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-4-spatial-risk-models-part-i"><i class="fa fa-check"></i>Week 4: Spatial Risk Models (Part I)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-5-spatiotemproal-risk-models-bayesian-updating-part-ii"><i class="fa fa-check"></i>Week 5: Spatiotemproal Risk Models &amp; Bayesian Updating (Part II)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#an-excellent-incredibly-useful-set-of-tutorial-videos-for-learning-stan-code"><i class="fa fa-check"></i>An Excellent &amp; Incredibly Useful Set of Tutorial Videos for Learning Stan Code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>1</b> Getting started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="getting-started.html"><a href="getting-started.html#what-is-stan"><i class="fa fa-check"></i><b>1.1</b> What is Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="getting-started.html"><a href="getting-started.html#installation-of-r-rstudio"><i class="fa fa-check"></i><b>1.2</b> Installation of R &amp; RStudio</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="getting-started.html"><a href="getting-started.html#installation-process-for-mac-users"><i class="fa fa-check"></i><b>1.2.1</b> Installation process for MAC users</a></li>
<li class="chapter" data-level="1.2.2" data-path="getting-started.html"><a href="getting-started.html#installation-process-for-windows-users"><i class="fa fa-check"></i><b>1.2.2</b> Installation process for Windows users</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="getting-started.html"><a href="getting-started.html#installation-of-rstan-or-stan"><i class="fa fa-check"></i><b>1.3</b> Installation of <code>rstan</code> (or Stan)</a></li>
<li class="chapter" data-level="1.4" data-path="getting-started.html"><a href="getting-started.html#installation-of-other-relevant-r-packages-needed-in-geog0125"><i class="fa fa-check"></i><b>1.4</b> Installation of other relevant R-packages needed in GEOG0125</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html"><i class="fa fa-check"></i><b>2</b> Introduction to Bayesian Inference</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#lecture-recording-length-10002-minutes"><i class="fa fa-check"></i><b>2.1</b> Lecture recording (Length: 1:00:02 minutes)</a></li>
<li class="chapter" data-level="2.2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#introduction"><i class="fa fa-check"></i><b>2.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#learning-outcomes"><i class="fa fa-check"></i><b>2.2.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#demonstration-recording-length-15950-minutes"><i class="fa fa-check"></i><b>2.2.2</b> Demonstration recording (Length: 1:59:50 minutes)</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#datasets-setting-up-the-work-directory"><i class="fa fa-check"></i><b>2.2.3</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="2.2.4" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#loading-the-appropriate-packages"><i class="fa fa-check"></i><b>2.2.4</b> Loading the appropriate packages</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-i-about-stan-programming"><i class="fa fa-check"></i><b>2.3</b> Basic building blocks I: About Stan Programming</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#opening-a-stan-script-in-rstudio"><i class="fa fa-check"></i><b>2.3.1</b> Opening a Stan Script in RStudio</a></li>
<li class="chapter" data-level="2.3.2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-structure-of-a-stan-script-in-rstudio"><i class="fa fa-check"></i><b>2.3.2</b> Basic structure of a Stan script in RStudio</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-ii-data-types-and-constraint-declarations"><i class="fa fa-check"></i><b>2.4</b> Basic building blocks II: Data types and constraint declarations</a></li>
<li class="chapter" data-level="2.5" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-iii-developing-our-model"><i class="fa fa-check"></i><b>2.5</b> Basic building blocks III: Developing our model</a></li>
<li class="chapter" data-level="2.6" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-iv-compiling-our-stan-code-in-rstudio"><i class="fa fa-check"></i><b>2.6</b> Basic building blocks IV: Compiling our Stan code in RStudio</a></li>
<li class="chapter" data-level="2.7" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-v-extract-posterior-samples-and-interpretation"><i class="fa fa-check"></i><b>2.7</b> Basic building blocks V: Extract posterior samples and interpretation</a></li>
<li class="chapter" data-level="2.8" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-vi-updating-our-prediction-with-new-information"><i class="fa fa-check"></i><b>2.8</b> Basic building blocks VI: Updating our prediction with new information</a></li>
<li class="chapter" data-level="2.9" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#tasks"><i class="fa fa-check"></i><b>2.9</b> Tasks</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#task-1---low-level-arsenic-poisoning-in-cornwall-uk"><i class="fa fa-check"></i><b>2.9.1</b> Task 1 - Low-level arsenic poisoning in Cornwall, UK</a></li>
<li class="chapter" data-level="2.9.2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#task-2---body-mass-index-bmi-problem"><i class="fa fa-check"></i><b>2.9.2</b> Task 2 - Body mass index (BMI) problem</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html"><i class="fa fa-check"></i><b>3</b> Bayesian Generalised Linear Models (GLMs)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#lecture-recording-length-10002-minutes-1"><i class="fa fa-check"></i><b>3.1</b> Lecture recording (Length: 1:00:02 minutes)</a></li>
<li class="chapter" data-level="3.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#introduction-1"><i class="fa fa-check"></i><b>3.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#demonstration-recording-length-15949"><i class="fa fa-check"></i><b>3.2.1</b> Demonstration recording (Length: 1:59:49)</a></li>
<li class="chapter" data-level="3.2.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#datasets-setting-up-the-work-directory-1"><i class="fa fa-check"></i><b>3.2.2</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="3.2.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#loading-and-installing-packages"><i class="fa fa-check"></i><b>3.2.3</b> Loading and installing packages</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#poisson-regression-modelling"><i class="fa fa-check"></i><b>3.3</b> Poisson Regression Modelling</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#selecting-the-appropriate-poisson-model"><i class="fa fa-check"></i><b>3.3.1</b> Selecting the appropriate Poisson model</a></li>
<li class="chapter" data-level="3.3.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan"><i class="fa fa-check"></i><b>3.3.2</b> Data preparation and set-up for Bayesian analysis in Stan</a></li>
<li class="chapter" data-level="3.3.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#creating-a-script-to-run-a-negative-binomial-poisson-regression-in-stan"><i class="fa fa-check"></i><b>3.3.3</b> Creating a script to run a Negative Binomial Poisson regression in Stan</a></li>
<li class="chapter" data-level="3.3.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#compiling-our-stan-code-in-rstudio-and-results"><i class="fa fa-check"></i><b>3.3.4</b> Compiling our Stan code in RStudio and Results</a></li>
<li class="chapter" data-level="3.3.5" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#model-with-categorical-variables"><i class="fa fa-check"></i><b>3.3.5</b> Model with categorical variables</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#tasks-1"><i class="fa fa-check"></i><b>3.4</b> Tasks</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#task-1---obesity-and-fastfoods-in-london"><i class="fa fa-check"></i><b>3.4.1</b> Task 1 - Obesity and Fastfoods in London</a></li>
<li class="chapter" data-level="3.4.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#task-2---factors-affecting-house-prices-in-london-2015"><i class="fa fa-check"></i><b>3.4.2</b> Task 2 - Factors affecting house prices in London (2015)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html"><i class="fa fa-check"></i><b>4</b> Bayesian Hierarchical Regression Models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#lecture-recording-length-10002-minutes-2"><i class="fa fa-check"></i><b>4.1</b> Lecture recording (Length: 1:00:02 minutes)</a></li>
<li class="chapter" data-level="4.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#introduction-2"><i class="fa fa-check"></i><b>4.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#demonstration-recording-length-15034"><i class="fa fa-check"></i><b>4.2.1</b> Demonstration recording (Length: 1:50:34)</a></li>
<li class="chapter" data-level="4.2.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#datasets-setting-up-the-work-directory-2"><i class="fa fa-check"></i><b>4.2.2</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="4.2.3" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#loading-packages"><i class="fa fa-check"></i><b>4.2.3</b> Loading packages</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan-1"><i class="fa fa-check"></i><b>4.3</b> Data preparation and set-up for Bayesian analysis in Stan</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#creating-a-script-to-run-a-2-level-multilevel-linear-regression-in-stan"><i class="fa fa-check"></i><b>4.3.1</b> Creating a script to run a 2-level Multilevel linear regression in Stan</a></li>
<li class="chapter" data-level="4.3.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#compiling-our-stan-code-for-hierarchical-modelling"><i class="fa fa-check"></i><b>4.3.2</b> Compiling our Stan code for Hierarchical Modelling</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#task"><i class="fa fa-check"></i><b>4.4</b> Task</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html"><i class="fa fa-check"></i><b>5</b> Bayesian Spatial Modelling for Areal Data in Stan</a>
<ul>
<li class="chapter" data-level="5.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#introduction-3"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#learning-outcomes-1"><i class="fa fa-check"></i><b>5.2</b> Learning outcomes</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#loading-and-installing-packages-1"><i class="fa fa-check"></i><b>5.2.1</b> Loading and installing packages</a></li>
<li class="chapter" data-level="5.2.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#datasets-setting-up-the-work-directory-3"><i class="fa fa-check"></i><b>5.2.2</b> Datasets &amp; setting up the work directory</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#data-preparation-in-rstudio"><i class="fa fa-check"></i><b>5.3</b> Data preparation in RStudio</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#calculation-for-expected-numbers"><i class="fa fa-check"></i><b>5.3.1</b> Calculation for expected numbers</a></li>
<li class="chapter" data-level="5.3.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#converting-the-spatial-adjacency-matrix-to-nodes-edges"><i class="fa fa-check"></i><b>5.3.2</b> Converting the spatial adjacency matrix to nodes &amp; edges</a></li>
<li class="chapter" data-level="5.3.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#create-the-dataset-to-be-compiled-in-stan"><i class="fa fa-check"></i><b>5.3.3</b> Create the dataset to be compiled in Stan</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#creating-the-script-for-the-spatial-icar-model"><i class="fa fa-check"></i><b>5.4</b> Creating the script for the Spatial ICAR model</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#data-block"><i class="fa fa-check"></i><b>5.4.1</b> Data block</a></li>
<li class="chapter" data-level="5.4.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#transformed-data-block"><i class="fa fa-check"></i><b>5.4.2</b> Transformed data block</a></li>
<li class="chapter" data-level="5.4.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#parameters-block"><i class="fa fa-check"></i><b>5.4.3</b> Parameters block</a></li>
<li class="chapter" data-level="5.4.4" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#transformed-parameters-block"><i class="fa fa-check"></i><b>5.4.4</b> Transformed parameters block</a></li>
<li class="chapter" data-level="5.4.5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#model-block"><i class="fa fa-check"></i><b>5.4.5</b> Model block</a></li>
<li class="chapter" data-level="5.4.6" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#generated-quantities-block"><i class="fa fa-check"></i><b>5.4.6</b> Generated quantities block</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#compiling-stan-code-for-the-spatial-icar-risk-modelling"><i class="fa fa-check"></i><b>5.5</b> Compiling Stan code for the Spatial ICAR risk modelling</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#printing-of-the-global-results"><i class="fa fa-check"></i><b>5.5.1</b> Printing of the global results</a></li>
<li class="chapter" data-level="5.5.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#rapid-diagnostics-of-the-rhats"><i class="fa fa-check"></i><b>5.5.2</b> Rapid diagnostics of the rHATs</a></li>
<li class="chapter" data-level="5.5.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#extraction-of-the-area-specific-relative-risks"><i class="fa fa-check"></i><b>5.5.3</b> Extraction of the area-specific relative risks</a></li>
<li class="chapter" data-level="5.5.4" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#mapping-of-rr-and-significance"><i class="fa fa-check"></i><b>5.5.4</b> Mapping of RR and significance</a></li>
<li class="chapter" data-level="5.5.5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#extracting-and-mapping-of-the-exceedance-probabilities"><i class="fa fa-check"></i><b>5.5.5</b> Extracting and mapping of the exceedance probabilities</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#task-1"><i class="fa fa-check"></i><b>5.6</b> Task</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html"><i class="fa fa-check"></i><b>6</b> Bayesian Updating &amp; Spatial Temporal Modelling</a>
<ul>
<li class="chapter" data-level="6.1" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#introduction-4"><i class="fa fa-check"></i><b>6.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#loading-and-installing-packages-2"><i class="fa fa-check"></i><b>6.1.1</b> Loading and installing packages</a></li>
<li class="chapter" data-level="6.1.2" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#datasets-setting-up-the-work-directory-4"><i class="fa fa-check"></i><b>6.1.2</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="6.1.3" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#data-preparation-in-rstudio-1"><i class="fa fa-check"></i><b>6.1.3</b> Data preparation in RStudio</a></li>
<li class="chapter" data-level="6.1.4" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#full-stan-script-for-the-spatial-icar-model"><i class="fa fa-check"></i><b>6.1.4</b> Full Stan script for the Spatial ICAR model</a></li>
<li class="chapter" data-level="6.1.5" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#compiling-stan-code-for-the-baseline-icar-model"><i class="fa fa-check"></i><b>6.1.5</b> Compiling Stan code for the Baseline ICAR model</a></li>
<li class="chapter" data-level="6.1.6" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#apply-the-bayesian-updating-on-subsequent-data-sets"><i class="fa fa-check"></i><b>6.1.6</b> Apply the Bayesian updating on subsequent data sets</a></li>
<li class="chapter" data-level="6.1.7" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#list-of-key-outputs"><i class="fa fa-check"></i><b>6.1.7</b> List of key outputs</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#finished"><i class="fa fa-check"></i><b>6.2</b> Finished!</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">GEOG0125: Advanced Topics in Social Geographic Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="bayesian-updating-spatial-temporal-modelling" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">6</span> Bayesian Updating &amp; Spatial Temporal Modelling<a href="bayesian-updating-spatial-temporal-modelling.html#bayesian-updating-spatial-temporal-modelling" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-4" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Introduction<a href="bayesian-updating-spatial-temporal-modelling.html#introduction-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This week’s practical will show you how to perform <strong>Bayesian Updating</strong>. This approach is excellent for analysing new information that is received in separate streams either on a ‘regular’ or ‘irregular’ basis. It approach is highly suitable within a <strong>repeated cross-sectional</strong> analytical framework. The definition of <strong>Bayesian Updating</strong> is a statistical method for revising the estimated probabilities of events you have observed previously, and this revision is based on new evidence (i.e., new data).</p>
<p>The learning outcomes for this section, we will see how to apply this technique to mosquito surveillance data to provide the following:</p>
<ul>
<li>An update on the risk profile of neighbourhoods;</li>
<li>See how the risk parameters evolve in the face of new data;</li>
<li>The main goal is show you the process of updating and data managing aspects;</li>
</ul>
<div id="loading-and-installing-packages-2" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Loading and installing packages<a href="bayesian-updating-spatial-temporal-modelling.html#loading-and-installing-packages-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now, lets load all packages needed specifically for this computer practical:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-1" tabindex="-1"></a><span class="co"># Load the packages with library()</span></span>
<span id="cb111-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;sf&quot;</span>)</span>
<span id="cb111-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-3" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tmap&quot;</span>)</span>
<span id="cb111-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;spdep&quot;</span>)</span>
<span id="cb111-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-5" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;rstan&quot;</span>)</span>
<span id="cb111-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-6" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;geostan&quot;</span>)</span>
<span id="cb111-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-7" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;SpatialEpi&quot;</span>)</span>
<span id="cb111-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-8" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidybayes&quot;</span>)</span>
<span id="cb111-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb111-9" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</span></code></pre></div>
<p>As usual, upon loading the <code>rstan</code> package, it is highly recommended to run this code to configure the settings in RStudio:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb112-1" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb112-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb112-2" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="datasets-setting-up-the-work-directory-4" class="section level3 hasAnchor" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Datasets &amp; setting up the work directory<a href="bayesian-updating-spatial-temporal-modelling.html#datasets-setting-up-the-work-directory-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Set your work directory to <strong>Week 5’s</strong> folder. For example, for Windows users, the code for setting the work directory will be:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb113-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/Users/AccountName/Desktop/GEOG0125/Week 5&quot;</span>)</span></code></pre></div>
<p>For MAC, the code for setting the work directory will be:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb114-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;/Users/AccountName/Desktop/GEOG0125/Week 5&quot;</span>)</span></code></pre></div>
<p>The dataset for this section of the practical are:</p>
<ul>
<li><code>Lira_January_2017.csv</code></li>
<li><code>Lira_April_2017.csv</code></li>
<li><code>Lira_July_2017.csv</code></li>
<li><code>Campina_Grande_Lira2017.shp</code></li>
</ul>
<p>The surveillance and environmental information are contained in monthly LIRA files. The spatial configuration is the shape file for Campina Grande (Brazil).</p>
<ul>
<li>The Campina Grande shape file contains 47 neighbourhoods. The unique identifiers, neighbourhood number and names are defined under the columns <code>osmID</code>, <code>NeighbNum</code> and <code>NeighbNam</code> respectively;</li>
<li>Across the January, April and July dataset for LIRA 2017. It contains the following variables: <code>osmID</code>, <code>NeighbNum</code> and <code>NeighbNam</code> to link with the shape file. The <code>InfestedNum</code> is the <strong>dependent variable</strong> that represents the total number of households identified as infested with mosquito breeding habitats in a neighbourhood. The column <code>Total</code> is the total number of households in a neighbourhood. This denominators serves as the reference population. Hence, it is used to compute the <strong>expected number</strong> of infested households in neighbourhoods. This will be used as an offset in the Bayesian model.</li>
<li>Lastly, the following <code>Temperature</code>, <code>Precipitation</code>, <code>NDVI</code> and <code>Urbanisation</code> are the <strong>independent</strong> variables that will be modelling continuously against the incident number of infested households.</li>
</ul>
<p>Let us load these dataset to memory:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb115-1" tabindex="-1"></a><span class="co"># load the data sets</span></span>
<span id="cb115-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb115-2" tabindex="-1"></a>Lira2017_1 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;Lira_January_2017.csv&quot;</span>)</span>
<span id="cb115-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb115-3" tabindex="-1"></a>Lira2017_2 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;Lira_April_2017.csv&quot;</span>)</span>
<span id="cb115-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb115-4" tabindex="-1"></a>Lira2017_3 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;Lira_July_2017.csv&quot;</span>)</span>
<span id="cb115-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb115-5" tabindex="-1"></a></span>
<span id="cb115-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb115-6" tabindex="-1"></a><span class="co"># load the shapefile</span></span>
<span id="cb115-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb115-7" tabindex="-1"></a>campina_grande_neighbourhoods <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;Campina_Grande_Lira2017.shp&quot;</span>)</span></code></pre></div>
</div>
<div id="data-preparation-in-rstudio-1" class="section level3 hasAnchor" number="6.1.3">
<h3><span class="header-section-number">6.1.3</span> Data preparation in RStudio<a href="bayesian-updating-spatial-temporal-modelling.html#data-preparation-in-rstudio-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="converting-the-spatial-adjacency-matrix-to-nodes-edges-1" class="section level4 hasAnchor" number="6.1.3.1">
<h4><span class="header-section-number">6.1.3.1</span> Converting the spatial adjacency matrix to nodes &amp; edges<a href="bayesian-updating-spatial-temporal-modelling.html#converting-the-spatial-adjacency-matrix-to-nodes-edges-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We will need to derive a set list of nodes and edges accordingly as Stan can only identify a spatial adjacency with a set of paired nodes with edges that connect them all together. For instance, <code>node1</code> represents the index area and <code>node2</code> is a list of neighbouring areas connected to the index region defined in <code>node1</code> (see <a href="https://uclpg-msc-sgds.github.io/GEOG0125/bayesian-spatial-modelling-for-areal-data-in-stan.html#converting-the-spatial-adjacency-matrix-to-nodes-edges"><strong>section 5.3.2, Week 4</strong></a>).</p>
<p>We can perform this spatial operation by first coercing the <code>sf</code> simple features object (i.e., <code>campina_grande_neighbourhoods</code>) to be to the spatial object <code>sp</code>.</p>
<p>Here is the code:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb116-1" tabindex="-1"></a><span class="co"># coerced to a &quot;sp&quot; object</span></span>
<span id="cb116-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb116-2" tabindex="-1"></a>campina_grande_neighb_spobject <span class="ot">&lt;-</span> <span class="fu">as</span>(campina_grande_neighbourhoods, <span class="st">&quot;Spatial&quot;</span>)</span></code></pre></div>
<p>Now, we are going to derive the <strong>nodes</strong> and <strong>edges</strong> from the <code>campina_grande_neighb_spobject</code> using the <code>shape2mat()</code> function - this changes it into a matrix object. From the matrix object, we will be able to prepare the data from spatial ICAR model using the <code>prep_icar_data()</code> function. Here, is the code:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb117-1" tabindex="-1"></a><span class="co"># coerced into a &quot;matrix&quot; object</span></span>
<span id="cb117-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb117-2" tabindex="-1"></a>adjacencyMatrix <span class="ot">&lt;-</span> <span class="fu">shape2mat</span>(campina_grande_neighb_spobject)</span>
<span id="cb117-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb117-3" tabindex="-1"></a><span class="co"># we will need to extract the components for the ICAR model when setting up the data set for Stan</span></span>
<span id="cb117-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb117-4" tabindex="-1"></a>extractComponents <span class="ot">&lt;-</span> <span class="fu">prep_icar_data</span>(adjacencyMatrix)</span></code></pre></div>
<p>From the <code>extractComponents</code> object, we will need to extract the following contents:</p>
<ul>
<li><code>$group_size</code> this is the number of areal units under observation listed in the shapefile (should be the same in the LIRA dataset)</li>
<li><code>$node1</code> are index neighbourhood of interest</li>
<li><code>$node2</code> are the other neighbouring neighbourhoods that are connected to the index neighbourhood of interest listed in <code>node1</code></li>
<li><code>$n_edges</code> creates the network as show area is connected to what neighbourhood. It is still an adjacency matrix using the queen contiguity matrix but as a network since Stan can only use this structure.</li>
</ul>
<p>Here is the code for performing the extraction:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb118-1" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(extractComponents<span class="sc">$</span>group_size)</span>
<span id="cb118-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb118-2" tabindex="-1"></a>nod1 <span class="ot">&lt;-</span> extractComponents<span class="sc">$</span>node1</span>
<span id="cb118-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb118-3" tabindex="-1"></a>nod2 <span class="ot">&lt;-</span> extractComponents<span class="sc">$</span>node2</span>
<span id="cb118-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb118-4" tabindex="-1"></a>n_edges <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(extractComponents<span class="sc">$</span>n_edges)</span></code></pre></div>
<p>Note that the information needed to be compiled in Stan are stored in <code>n</code>, <code>nod1</code>, <code>nod2</code> and <code>n_edges</code>.</p>
</div>
<div id="creating-the-baseline-set-of-data-for-stan" class="section level4 hasAnchor" number="6.1.3.2">
<h4><span class="header-section-number">6.1.3.2</span> Creating the baseline set of data for Stan<a href="bayesian-updating-spatial-temporal-modelling.html#creating-the-baseline-set-of-data-for-stan" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Next the step, we will need to prepare the data as a list object and define the <strong>dependent</strong> and <strong>independent</strong> variables needed to be compiled in Stan. The outcome <code>InfestedNum</code> is going to be made passed as <code>y</code>. The set of independent variables i.e., <code>Temperature</code>, <code>Precipitation</code>, <code>NDVI</code> and <code>Urbanisation</code> is going to be made as a <strong>matrix</strong> object called <code>x</code>, <code>K</code> is going to contain the number of independent variables i.e., 4, and the offset variable from the <code>Expected</code> will be extracted as <code>e</code>.</p>
<p>Here is the code:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb119-1" tabindex="-1"></a>y<span class="ot">=</span>Lira2017_1<span class="sc">$</span>InfestedNum</span>
<span id="cb119-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb119-2" tabindex="-1"></a>x<span class="ot">=</span>Lira2017_1[,<span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>,<span class="dv">12</span>)]</span>
<span id="cb119-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb119-3" tabindex="-1"></a>e<span class="ot">=</span>Lira2017_1<span class="sc">$</span>Expected</span></code></pre></div>
<p>Now, we create our dataset for Stan:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb120-1" tabindex="-1"></a><span class="co"># put all components into a list object</span></span>
<span id="cb120-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb120-2" tabindex="-1"></a>stan.spatial.baseline <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N=</span>n, <span class="at">N_edges=</span>n_edges, <span class="at">node1=</span>nod1, <span class="at">node2=</span>nod2, <span class="at">Y=</span>y, <span class="at">X=</span>x, <span class="at">K=</span><span class="fu">length</span>(x), <span class="at">off_set=</span>e)</span></code></pre></div>
<p>The above information is going to be passed to <code>data block</code> in Stan for compilation.</p>
</div>
</div>
<div id="full-stan-script-for-the-spatial-icar-model" class="section level3 hasAnchor" number="6.1.4">
<h3><span class="header-section-number">6.1.4</span> Full Stan script for the Spatial ICAR model<a href="bayesian-updating-spatial-temporal-modelling.html#full-stan-script-for-the-spatial-icar-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will use full script for executing the <strong>spatial intrinsic conditional auto-regressive (ICAR) model</strong>. This will be performed on the baseline dataset <code>stan.spatial.baseline</code>.</p>
<p>Please open a new Stan file and use the following codes:</p>
<pre class="text"><code>// Stan script: Spatial ICAR Poisson model

data {
  int&lt;lower=0&gt; N;                                                        // number of spatial units or neighbourhoods in Campina Grande
  int&lt;lower=0&gt; N_edges;                                                  // number of edges connecting adjacent areas using Queens contiguity
  array[N_edges] int&lt;lower=1, upper=N&gt; node1;                            // list of index areas showing which spatial units are neighbours
  array[N_edges] int&lt;lower=1, upper=N&gt; node2;                            // list of neighbouring areas showing the connection to index spatial unit
  array[N] int&lt;lower=0&gt; Y;                                               // dependent variable i.e., number of households infested
  vector&lt;lower=1&gt;[N] offset;                                             // total number of houses in neoighbourhoods are used as an offset variable
  int&lt;lower=1&gt; K;                                                        // number of independent variables i.e., K = 4
  matrix[N, K] X;                                                        // independent variables in matrix form i.e., temp, prec, ndvi, and urban
}

transformed data {
    vector[N] log_offset = log(offset);
}

parameters {
  real alpha;                                                            // intercept
  vector[K] beta;                                                        // covariates
  real&lt;lower=0&gt; sigma;                                                   // overall standard deviation
  real&lt;lower=0, upper=1&gt; rho;                                            // proportion unstructured vs. spatially structured variance
  vector[N] theta;                                                       // unstructure random effects (heterogeneous)
  vector[N] phi;                                                         // spatial random effects
}

transformed parameters {
  vector[N] combined;                                                    // combined random effect i.e., unstructure and structured

  combined = sqrt(1 - rho) * theta + sqrt(rho) * phi;                    // formulation for the combined random effect i.e., unstructure and structured
}

model {
  Y ~ poisson_log(log_offset + alpha + X * beta + combined * sigma);     // likelihood function: multivariable Poisson ICAR regression model
  alpha ~ normal(0.0, 1.0);                                              // prior for alpha: weakly informative
  beta ~ normal(0.0, 1.0);                                               // prior for betas: weakly informative
  theta ~ normal(0.0, 1.0);                                              // prior for theta: weakly informative
  sigma ~ normal(0.0, 1.0);                                              // prior for sigma: weakly informative
  rho ~ beta(0.5, 0.5);                                                  // prior for rho: pulled for literature

  target += -0.5 * dot_self(phi[node1] - phi[node2]);                    // prior for phi: using a conditional autoregressive distribution
  sum(phi) ~ normal(0, 0.001 * N);                                       // soft sum-to-zero constraint on phi, and its the equivalent to mean(phi) ~ normal(0,0.001)
}

generated quantities {
  vector[N] eta = alpha + X * beta + combined * sigma;                  // compute eta and exponentiate into mu                   
  vector[N] rr_mu = exp(eta);                                           // output the neighbourhood-specific relative risks in mu
  vector[K] rr_beta = exp(beta);                                        // output the risk ratios for each coefficient for the independent variables
  real rr_alpha = exp(alpha);                                           // output the risk ratios for the intercept
}</code></pre>
<p>Make sure to save the Stan script as <code>ICAR_model_baseline.stan</code> the working directory.</p>
</div>
<div id="compiling-stan-code-for-the-baseline-icar-model" class="section level3 hasAnchor" number="6.1.5">
<h3><span class="header-section-number">6.1.5</span> Compiling Stan code for the Baseline ICAR model<a href="bayesian-updating-spatial-temporal-modelling.html#compiling-stan-code-for-the-baseline-icar-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now, let us turn our attention back to RStudio. Use the <code>stan()</code> function to compile the saved script to obtain the posterior estimation of the parameters from our baseline model:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-1" tabindex="-1"></a><span class="co"># starts timer</span></span>
<span id="cb122-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-2" tabindex="-1"></a>ptm <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb122-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-3" tabindex="-1"></a></span>
<span id="cb122-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-4" tabindex="-1"></a><span class="co"># Bayesian model</span></span>
<span id="cb122-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-5" tabindex="-1"></a>Bayesian.model.baseline <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">&quot;ICAR_model_baseline.stan&quot;</span>, </span>
<span id="cb122-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-6" tabindex="-1"></a>    <span class="at">data=</span>stan.spatial.baseline, </span>
<span id="cb122-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-7" tabindex="-1"></a>    <span class="at">iter=</span><span class="dv">10000</span>, <span class="at">chains=</span><span class="dv">6</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>, </span>
<span id="cb122-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-8" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_treedepth =</span> <span class="dv">12</span>))</span>
<span id="cb122-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-9" tabindex="-1"></a></span>
<span id="cb122-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-10" tabindex="-1"></a><span class="co"># stops and calculates how long the model took to process with 10000 iterations on 6 cores</span></span>
<span id="cb122-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb122-11" tabindex="-1"></a><span class="fu">proc.time</span>() <span class="sc">-</span> ptm</span></code></pre></div>
<div id="rapid-diagnostics" class="section level4 hasAnchor" number="6.1.5.1">
<h4><span class="header-section-number">6.1.5.1</span> Rapid diagnostics<a href="bayesian-updating-spatial-temporal-modelling.html#rapid-diagnostics" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="first-check-rhats-are-less-than-1.05" class="section level5 hasAnchor" number="6.1.5.1.1">
<h5><span class="header-section-number">6.1.5.1.1</span> First check: <strong>rHATs</strong> are <strong>less than 1.05</strong><a href="bayesian-updating-spatial-temporal-modelling.html#first-check-rhats-are-less-than-1.05" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Before interpreting the overall risks, as well as mapping them, we must check if there are any parameter estimatess i.e., <code>alpha</code>, <code>beta</code>, <code>rr_alpha</code>, <code>rr_beta</code>, <code>sigma</code>, all <code>phi</code> and <code>lp__</code> whose <strong>rHAT</strong> exceed the threshold value of <strong>1.05</strong>. This is an indication that the iterations did not perform well if an <code>rHAT</code> for a parameter is above <code>1.05</code> meaning that samples did not converge to a (plausible) value. We can do a rapid checks to see which parameters are valid, or not valid, by creating a binary variable of <code>1</code>’s (i.e., Valid if <code>rHAT</code> &lt; 1.05), otherwise <code>0</code>’s (Not valid).</p>
<p>For instance, running this code would should the summary table to its fullest:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb123-1" tabindex="-1"></a><span class="co"># print full table to avoid some rows from being omitted.</span></span>
<span id="cb123-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb123-2" tabindex="-1"></a><span class="fu">options</span>(<span class="at">max.print =</span> <span class="dv">100000</span>)</span>
<span id="cb123-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb123-3" tabindex="-1"></a></span>
<span id="cb123-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb123-4" tabindex="-1"></a><span class="co"># print the all results for quick diagnostics</span></span>
<span id="cb123-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb123-5" tabindex="-1"></a><span class="fu">print</span>(Bayesian.model.baseline, </span>
<span id="cb123-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb123-6" tabindex="-1"></a>    <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;rr_alpha&quot;</span>, <span class="st">&quot;rr_beta&quot;</span>, <span class="st">&quot;rr_mu&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;lp__&quot;</span>), </span>
<span id="cb123-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb123-7" tabindex="-1"></a>    <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb123-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb123-8" tabindex="-1"></a>    )</span></code></pre></div>
<p>You can eyeball the column with the <code>rHAT</code> values in the printed output. Or, you can use the code to tabulate it to see the numbers - if its only a frequency for the value of 1, then you are fine:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-1" tabindex="-1"></a><span class="co"># diagnostic check on the rHats - put everything into a data frame</span></span>
<span id="cb124-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-2" tabindex="-1"></a>diagnostic.checks <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(</span>
<span id="cb124-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-3" tabindex="-1"></a>    <span class="fu">summary</span>(Bayesian.model.baseline, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;rr_alpha&quot;</span>, <span class="st">&quot;rr_beta&quot;</span>, <span class="st">&quot;rr_mu&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;lp__&quot;</span>), </span>
<span id="cb124-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-4" tabindex="-1"></a>        <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary</span>
<span id="cb124-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-5" tabindex="-1"></a>    )</span>
<span id="cb124-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-6" tabindex="-1"></a></span>
<span id="cb124-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-7" tabindex="-1"></a><span class="co"># create binary variable</span></span>
<span id="cb124-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-8" tabindex="-1"></a>diagnostic.checks<span class="sc">$</span>valid <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(diagnostic.checks<span class="sc">$</span>Rhat <span class="sc">&lt;</span> <span class="fl">1.05</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb124-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-9" tabindex="-1"></a></span>
<span id="cb124-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-10" tabindex="-1"></a><span class="co"># tabulate and check the rHATs is below 1.05 for all parameter estimates</span></span>
<span id="cb124-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-11" tabindex="-1"></a><span class="fu">table</span>(diagnostic.checks<span class="sc">$</span>valid)</span>
<span id="cb124-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-12" tabindex="-1"></a><span class="co"># if there is a frequency for `0` than the test has failed</span></span>
<span id="cb124-13"><a href="bayesian-updating-spatial-temporal-modelling.html#cb124-13" tabindex="-1"></a><span class="co"># you must perform the MCMC sampling again with a bigger number of iterations</span></span></code></pre></div>
<p>Everything is okay - all outputted parameters have an <code>rHAT &lt; 1.05</code>.</p>
</div>
<div id="second-check-make-sure-that-allmost-samples-have-converged" class="section level5 hasAnchor" number="6.1.5.1.2">
<h5><span class="header-section-number">6.1.5.1.2</span> Second check: Make sure that all/most samples have converged<a href="bayesian-updating-spatial-temporal-modelling.html#second-check-make-sure-that-allmost-samples-have-converged" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In my computer, we computed a total of 60,000 iterations across the 6 chains (i.e., 10,000 iterations), of which half the number is discarded. Hence, we have a sample of 30,000 samples generated for each parameter. Now, we need to check for samples that did not converge and ensure that <strong>does not</strong> exceed 10%.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-1" tabindex="-1"></a><span class="co"># check across each chains for samples that have diverged (should not exceed 10% of the total 30000)</span></span>
<span id="cb125-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-2" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.baseline, <span class="at">inc_warmup =</span> F)[[<span class="dv">1</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 1</span></span>
<span id="cb125-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-3" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.baseline, <span class="at">inc_warmup =</span> F)[[<span class="dv">2</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 2</span></span>
<span id="cb125-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-4" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.baseline, <span class="at">inc_warmup =</span> F)[[<span class="dv">3</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 3</span></span>
<span id="cb125-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-5" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.baseline, <span class="at">inc_warmup =</span> F)[[<span class="dv">4</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 4</span></span>
<span id="cb125-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-6" tabindex="-1"></a>d5 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.baseline, <span class="at">inc_warmup =</span> F)[[<span class="dv">5</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 5</span></span>
<span id="cb125-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-7" tabindex="-1"></a>d6 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.baseline, <span class="at">inc_warmup =</span> F)[[<span class="dv">6</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 6</span></span>
<span id="cb125-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-8" tabindex="-1"></a></span>
<span id="cb125-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-9" tabindex="-1"></a><span class="co"># tells you how many samples per chain did not converged (i.e., diverged)</span></span>
<span id="cb125-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-10" tabindex="-1"></a>d1</span>
<span id="cb125-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-11" tabindex="-1"></a>d2</span>
<span id="cb125-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-12" tabindex="-1"></a>d3</span>
<span id="cb125-13"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-13" tabindex="-1"></a>d4</span>
<span id="cb125-14"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-14" tabindex="-1"></a>d5</span>
<span id="cb125-15"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-15" tabindex="-1"></a>d6</span>
<span id="cb125-16"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-16" tabindex="-1"></a></span>
<span id="cb125-17"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-17" tabindex="-1"></a><span class="co"># Check the proportion of diverged samples is greater than 10</span></span>
<span id="cb125-18"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-18" tabindex="-1"></a>(d1<span class="sc">+</span>d2<span class="sc">+</span>d3<span class="sc">+</span>d4<span class="sc">+</span>d5<span class="sc">+</span>d6)<span class="sc">/</span><span class="dv">30000</span> <span class="sc">*</span> <span class="dv">100</span> <span class="sc">&gt;</span> <span class="dv">10</span></span>
<span id="cb125-19"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-19" tabindex="-1"></a><span class="co"># if `TRUE` than the test has failed</span></span>
<span id="cb125-20"><a href="bayesian-updating-spatial-temporal-modelling.html#cb125-20" tabindex="-1"></a><span class="co"># you must perform the MCMC sampling again with a bigger number of iterations</span></span></code></pre></div>
<p>Everything is okay - it shows <strong>FALSE</strong> so most samples have converged. We can now proceed to the extraction of our results!</p>
<div class="note">
<p><strong>NOTES</strong>: To avoid such complications, it is always to best to run about <code>10000</code>, <code>15000</code> or more iterations with the argument <code>control = list(max_treedepth = 12)</code> included in the <code>stan()</code> function. Usually, shorter iterations yield low effective sample sizes after warm-up samples are discarded, which in turn, may lead to complications that may cause the <code>rHAT</code> to be above 1.05, or samples that won’t converge. Notice, how today we have used up to <code>10000</code> iterations!</p>
</div>
</div>
</div>
<div id="extraction-of-results-to-user-friendly-format" class="section level4 hasAnchor" number="6.1.5.2">
<h4><span class="header-section-number">6.1.5.2</span> Extraction of results to user-friendly format<a href="bayesian-updating-spatial-temporal-modelling.html#extraction-of-results-to-user-friendly-format" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We are going to extract the results from the baseline model object. Pay close attention to this section - it shows how to extract all the necessary information and building the results into a table to be inserted into a document.</p>
<div id="extract-the-global-results-for-relative-risks-and-exceedence-probabilities" class="section level5 hasAnchor" number="6.1.5.2.1">
<h5><span class="header-section-number">6.1.5.2.1</span> Extract the global results for relative risks and exceedence probabilities<a href="bayesian-updating-spatial-temporal-modelling.html#extract-the-global-results-for-relative-risks-and-exceedence-probabilities" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>This section computes and extracts the exceedance probabilities for the baseline relative risk for the intercept, and for each independent variable in the order of <code>Temperature</code>, <code>Precipitation</code>, <code>NDVI</code> and <code>Urbanisation</code>:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-1" tabindex="-1"></a><span class="co"># print summary table</span></span>
<span id="cb126-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-2" tabindex="-1"></a><span class="fu">print</span>(Bayesian.model.baseline, </span>
<span id="cb126-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-3" tabindex="-1"></a>    <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;rr_alpha&quot;</span>, <span class="st">&quot;rr_beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>), </span>
<span id="cb126-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-4" tabindex="-1"></a>    <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb126-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-5" tabindex="-1"></a>)</span>
<span id="cb126-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-6" tabindex="-1"></a></span>
<span id="cb126-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-7" tabindex="-1"></a><span class="co"># compute exceedance probability for the intercept/baseline risk is bigger null value 1</span></span>
<span id="cb126-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-8" tabindex="-1"></a>threshold.intercept <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb126-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-9" tabindex="-1"></a>rr_alpha.exc.probs <span class="ot">&lt;-</span> Bayesian.model.baseline <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(rr_alpha) <span class="sc">%&gt;%</span> </span>
<span id="cb126-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-10" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">rr_alpha=</span><span class="fu">threshold.intercept</span>(rr_alpha)) <span class="sc">%&gt;%</span></span>
<span id="cb126-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-11" tabindex="-1"></a>    <span class="fu">pull</span>(rr_alpha)</span>
<span id="cb126-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-12" tabindex="-1"></a></span>
<span id="cb126-13"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-13" tabindex="-1"></a><span class="co"># compute exceedance probability for each of the independent variables/risk are bigger than 1</span></span>
<span id="cb126-14"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-14" tabindex="-1"></a>threshold.coefficients <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb126-15"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-15" tabindex="-1"></a>rr_beta.exc.probs <span class="ot">&lt;-</span> Bayesian.model.baseline <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(rr_beta[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb126-16"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-16" tabindex="-1"></a>    <span class="fu">group_by</span>(i) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">rr_beta=</span><span class="fu">threshold.coefficients</span>(rr_beta)) <span class="sc">%&gt;%</span></span>
<span id="cb126-17"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-17" tabindex="-1"></a>    <span class="fu">pull</span>(rr_beta)</span>
<span id="cb126-18"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-18" tabindex="-1"></a></span>
<span id="cb126-19"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-19" tabindex="-1"></a><span class="co"># reports exceedance probabilities</span></span>
<span id="cb126-20"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-20" tabindex="-1"></a>rr_alpha.exc.probs</span>
<span id="cb126-21"><a href="bayesian-updating-spatial-temporal-modelling.html#cb126-21" tabindex="-1"></a>rr_beta.exc.probs</span></code></pre></div>
</div>
<div id="building-a-table-of-results-for-the-baseline-regression-model" class="section level5 hasAnchor" number="6.1.5.2.2">
<h5><span class="header-section-number">6.1.5.2.2</span> Building a table of results for the baseline regression model<a href="bayesian-updating-spatial-temporal-modelling.html#building-a-table-of-results-for-the-baseline-regression-model" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>This is good’ol data management code to prepare the results into something that’s user-friendly:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-1" tabindex="-1"></a><span class="co"># creating a table</span></span>
<span id="cb127-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-2" tabindex="-1"></a><span class="co"># step 1: create the names in the appropriate order as there were modeled in Stan</span></span>
<span id="cb127-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-3" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Baseline Risk&quot;</span>, <span class="st">&quot;Temperature&quot;</span>, <span class="st">&quot;Precipitation&quot;</span>, <span class="st">&quot;NDVI&quot;</span>, <span class="st">&quot;Urbanisation&quot;</span>)</span>
<span id="cb127-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-4" tabindex="-1"></a></span>
<span id="cb127-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-5" tabindex="-1"></a><span class="co"># step 2: now, pull all global relative risk results into the object called &#39;results&#39;</span></span>
<span id="cb127-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-6" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(Bayesian.model.baseline, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;rr_alpha&quot;</span>, <span class="st">&quot;rr_beta&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb127-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-7" tabindex="-1"></a>results<span class="sc">$</span>variables <span class="ot">&lt;-</span> names</span>
<span id="cb127-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-8" tabindex="-1"></a><span class="fu">row.names</span>(results) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)</span>
<span id="cb127-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-9" tabindex="-1"></a></span>
<span id="cb127-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-10" tabindex="-1"></a><span class="co"># step 3: fudge with the results to make it look clean</span></span>
<span id="cb127-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-11" tabindex="-1"></a>results <span class="ot">&lt;-</span> results[,<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>)]</span>
<span id="cb127-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-12" tabindex="-1"></a>results<span class="sc">$</span>mean <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>mean, <span class="dv">4</span>)</span>
<span id="cb127-13"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-13" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;coefficient&quot;</span></span>
<span id="cb127-14"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-14" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;lower95&quot;</span></span>
<span id="cb127-15"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-15" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&quot;upper95&quot;</span></span>
<span id="cb127-16"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-16" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ess&quot;</span></span>
<span id="cb127-17"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-17" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rhat&quot;</span></span>
<span id="cb127-18"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-18" tabindex="-1"></a>results<span class="sc">$</span>lower95<span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>lower95, <span class="dv">4</span>)</span>
<span id="cb127-19"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-19" tabindex="-1"></a>results<span class="sc">$</span>upper95 <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>upper95, <span class="dv">4</span>)</span>
<span id="cb127-20"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-20" tabindex="-1"></a>results<span class="sc">$</span>ess <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>ess, <span class="dv">0</span>)</span>
<span id="cb127-21"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-21" tabindex="-1"></a>results<span class="sc">$</span>rhat <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>rhat, <span class="dv">4</span>)</span>
<span id="cb127-22"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-22" tabindex="-1"></a></span>
<span id="cb127-23"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-23" tabindex="-1"></a><span class="co"># step 4: stitch the credibility results as text so it reads as (95% CrI: XXX to XXX) using the paste() function</span></span>
<span id="cb127-24"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-24" tabindex="-1"></a>results<span class="sc">$</span>beta_95CrI <span class="ot">&lt;-</span> <span class="fu">paste</span>(results<span class="sc">$</span>coefficient, <span class="st">&quot; (95% CrI: &quot;</span>, results<span class="sc">$</span>lower95, <span class="st">&quot; to &quot;</span>, results<span class="sc">$</span>upper95, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb127-25"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-25" tabindex="-1"></a></span>
<span id="cb127-26"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-26" tabindex="-1"></a><span class="co"># step 5: pull the exceedance probabilities into the result table</span></span>
<span id="cb127-27"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-27" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">c</span>(rr_alpha.exc.probs, rr_beta.exc.probs)</span>
<span id="cb127-28"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-28" tabindex="-1"></a>results<span class="sc">$</span>ExceedanceProb <span class="ot">&lt;-</span> <span class="fu">round</span>(a, <span class="dv">4</span>)</span>
<span id="cb127-29"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-29" tabindex="-1"></a>results<span class="sc">$</span>Uncertainty <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Prob = &quot;</span>, results<span class="sc">$</span>ExceedanceProb, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb127-30"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-30" tabindex="-1"></a></span>
<span id="cb127-31"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-31" tabindex="-1"></a><span class="co"># Step 6: finally, more fudging around with the results to make it look cleaner and done!</span></span>
<span id="cb127-32"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-32" tabindex="-1"></a>final.output <span class="ot">&lt;-</span> results[,<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">5</span>, <span class="dv">6</span>)]</span>
<span id="cb127-33"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-33" tabindex="-1"></a></span>
<span id="cb127-34"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-34" tabindex="-1"></a><span class="co"># view final output and... presto! not too shabby!</span></span>
<span id="cb127-35"><a href="bayesian-updating-spatial-temporal-modelling.html#cb127-35" tabindex="-1"></a>final.output</span></code></pre></div>
<p>The table with global results should look something like:</p>
<pre class="text"><code>      variables                         beta_95CrI   Uncertainty   ess   rhat
1 Baseline Risk  1.467 (95% CrI: 0.1215 to 6.3608) Prob = 0.4597 29443 1.0001
2   Temperature 0.9307 (95% CrI: 0.8295 to 1.0414) Prob = 0.1030 10581 1.0004
3 Precipitation 1.1547 (95% CrI: 1.0353 to 1.2855) Prob = 0.9944  8654 1.0006
4          NDVI  0.929 (95% CrI: 0.6228 to 1.3344) Prob = 0.3102 14313 1.0001
5  Urbanisation 1.1793 (95% CrI: 0.5638 to 2.1582) Prob = 0.6279 13990 0.9999</code></pre>
<p>Now, preserve this <strong>Global</strong> regression result in a spreadsheet:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb129-1" tabindex="-1"></a><span class="co"># Now export Global table results into a .csv file</span></span>
<span id="cb129-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb129-2" tabindex="-1"></a><span class="fu">write.csv</span>(final.output, <span class="at">file =</span> <span class="st">&quot;Global_Result_January_2017.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="mapping-the-relative-risk-and-significance-for-the-baseline-result" class="section level5 hasAnchor" number="6.1.5.2.3">
<h5><span class="header-section-number">6.1.5.2.3</span> Mapping the relative risk and significance for the baseline result<a href="bayesian-updating-spatial-temporal-modelling.html#mapping-the-relative-risk-and-significance-for-the-baseline-result" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Same approach covered in Week 4’s computer practical (sections <a href="https://uclpg-msc-sgds.github.io/GEOG0125/bayesian-spatial-modelling-for-areal-data-in-stan.html#extraction-of-the-area-specific-relative-risks"><strong>5.5.3</strong></a>, <a href="https://uclpg-msc-sgds.github.io/GEOG0125/bayesian-spatial-modelling-for-areal-data-in-stan.html#mapping-of-rr-and-significance"><strong>5.5.4</strong></a> and <a href="https://uclpg-msc-sgds.github.io/GEOG0125/bayesian-spatial-modelling-for-areal-data-in-stan.html#extracting-and-mapping-of-the-exceedance-probabilities"><strong>5.5.5</strong></a>).</p>
<p>Extract the area-specific relative risks for the neighbourhoods:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-1" tabindex="-1"></a><span class="co"># extraction key posterior results for the generated quantities </span></span>
<span id="cb130-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-2" tabindex="-1"></a>relativeRisk.results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(Bayesian.model.baseline, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;rr_mu&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb130-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-3" tabindex="-1"></a><span class="co"># now cleaning up this table up</span></span>
<span id="cb130-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-4" tabindex="-1"></a><span class="co"># first, insert clean row numbers to new data frame</span></span>
<span id="cb130-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-5" tabindex="-1"></a><span class="fu">row.names</span>(relativeRisk.results) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(relativeRisk.results)</span>
<span id="cb130-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-6" tabindex="-1"></a><span class="co"># second, rearrange the columns into order</span></span>
<span id="cb130-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-7" tabindex="-1"></a>relativeRisk.results <span class="ot">&lt;-</span> relativeRisk.results[, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>)]</span>
<span id="cb130-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-8" tabindex="-1"></a><span class="co"># third, rename the columns appropriately</span></span>
<span id="cb130-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-9" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rr&quot;</span></span>
<span id="cb130-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-10" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rrlower&quot;</span></span>
<span id="cb130-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-11" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rrupper&quot;</span></span>
<span id="cb130-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb130-12" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rHAT&quot;</span></span></code></pre></div>
<p>Merge the results to the shapefile:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb131-1" tabindex="-1"></a><span class="co"># template for merging spatial risk data</span></span>
<span id="cb131-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb131-2" tabindex="-1"></a>spatial.data <span class="ot">&lt;-</span> campina_grande_neighbourhoods</span>
<span id="cb131-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb131-3" tabindex="-1"></a><span class="co"># now, we proceed to generate our risk maps</span></span>
<span id="cb131-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb131-4" tabindex="-1"></a><span class="co"># align the results to the areas in shapefile</span></span>
<span id="cb131-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb131-5" tabindex="-1"></a>spatial.data<span class="sc">$</span>rr <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rr&quot;</span>]</span>
<span id="cb131-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb131-6" tabindex="-1"></a>spatial.data<span class="sc">$</span>rrlower <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rrlower&quot;</span>]</span>
<span id="cb131-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb131-7" tabindex="-1"></a>spatial.data<span class="sc">$</span>rrupper <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rrupper&quot;</span>]</span></code></pre></div>
<p>Create the significance categories:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-1" tabindex="-1"></a><span class="co"># create categories to define if an area has significant increase or decrease in risk, or nothing all </span></span>
<span id="cb132-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-2" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb132-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-3" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&gt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>    <span class="co"># NOT SIGNIFICANT</span></span>
<span id="cb132-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-4" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># NOT SIGNIFICANT</span></span>
<span id="cb132-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-5" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&gt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>    <span class="co"># SIGNIFICANT INCREASE</span></span>
<span id="cb132-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-6" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&lt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span>   <span class="co"># SIGNIFICANT DECREASE</span></span>
<span id="cb132-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-7" tabindex="-1"></a></span>
<span id="cb132-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-8" tabindex="-1"></a><span class="co"># use these functions to understand the distribution of these risk estimates</span></span>
<span id="cb132-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-9" tabindex="-1"></a><span class="fu">summary</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb132-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-10" tabindex="-1"></a><span class="fu">hist</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb132-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb132-11" tabindex="-1"></a><span class="fu">table</span>(spatial.data<span class="sc">$</span>Significance)</span></code></pre></div>
<p>Compute the exceedance probabilities for the areas and categorise them in bands of 10s with their map labels:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-1" tabindex="-1"></a><span class="co"># compute the exceedance probabilities for the areas</span></span>
<span id="cb133-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-2" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb133-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-3" tabindex="-1"></a>excProbrr <span class="ot">&lt;-</span> Bayesian.model.baseline <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(rr_mu[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb133-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-4" tabindex="-1"></a>    <span class="fu">group_by</span>(i) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">rr_mu=</span><span class="fu">threshold</span>(rr_mu)) <span class="sc">%&gt;%</span></span>
<span id="cb133-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-5" tabindex="-1"></a>    <span class="fu">pull</span>(rr_mu)</span>
<span id="cb133-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-6" tabindex="-1"></a></span>
<span id="cb133-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-7" tabindex="-1"></a><span class="co"># insert the exceedance values into the spatial data frame</span></span>
<span id="cb133-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-8" tabindex="-1"></a>spatial.data<span class="sc">$</span>excProb <span class="ot">&lt;-</span> excProbrr</span>
<span id="cb133-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-9" tabindex="-1"></a></span>
<span id="cb133-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-10" tabindex="-1"></a><span class="co"># categorising the probabilities in bands of 10s</span></span>
<span id="cb133-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-11" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb133-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-12" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="dv">0</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.01</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb133-13"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-13" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.01</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.10</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb133-14"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-14" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.10</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.20</span>] <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb133-15"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-15" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.20</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.30</span>] <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb133-16"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-16" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.30</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.40</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb133-17"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-17" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.40</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.50</span>] <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb133-18"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-18" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.50</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.60</span>] <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb133-19"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-19" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.60</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.70</span>] <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb133-20"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-20" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.70</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.80</span>] <span class="ot">&lt;-</span> <span class="dv">9</span></span>
<span id="cb133-21"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-21" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.80</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.90</span>] <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb133-22"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-22" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.90</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">1.00</span>] <span class="ot">&lt;-</span> <span class="dv">11</span></span>
<span id="cb133-23"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-23" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb <span class="sc">==</span> <span class="fl">1.00</span>] <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb133-24"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-24" tabindex="-1"></a></span>
<span id="cb133-25"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-25" tabindex="-1"></a><span class="co"># create the map labels for the probabilities</span></span>
<span id="cb133-26"><a href="bayesian-updating-spatial-temporal-modelling.html#cb133-26" tabindex="-1"></a>ProbCategorylist <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;&lt;0.01&quot;</span>, <span class="st">&quot;0.01-0.09&quot;</span>, <span class="st">&quot;0.10-0.19&quot;</span>, <span class="st">&quot;0.20-0.29&quot;</span>, <span class="st">&quot;0.30-0.39&quot;</span>, <span class="st">&quot;0.40-0.49&quot;</span>,<span class="st">&quot;0.50-0.59&quot;</span>, <span class="st">&quot;0.60-0.69&quot;</span>, <span class="st">&quot;0.70-0.79&quot;</span>, <span class="st">&quot;0.80-0.89&quot;</span>, <span class="st">&quot;0.90-0.99&quot;</span>, <span class="st">&quot;1.00&quot;</span>)</span></code></pre></div>
<p>Checking the labels and getting a feel of its distribution - to inform how I will be build my maps and whether there is balance in the labels etc:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb134-1" tabindex="-1"></a><span class="co"># use these functions to understand the distribution of these risk estimates</span></span>
<span id="cb134-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb134-2" tabindex="-1"></a><span class="fu">summary</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb134-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb134-3" tabindex="-1"></a><span class="fu">hist</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb134-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb134-4" tabindex="-1"></a><span class="fu">table</span>(spatial.data<span class="sc">$</span>Significance)</span>
<span id="cb134-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb134-5" tabindex="-1"></a></span>
<span id="cb134-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb134-6" tabindex="-1"></a><span class="co"># check to see if legend scheme is balanced</span></span>
<span id="cb134-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb134-7" tabindex="-1"></a><span class="fu">table</span>(spatial.data<span class="sc">$</span>ProbCat)</span></code></pre></div>
<pre class="text"><code>&gt; summary(spatial.data$rr)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.7028  1.2050  1.8056  1.7339  2.3294  2.9316 
&gt; hist(spatial.data$rr)
&gt; table(spatial.data$Significance)

-1  0  1 
 4 10 33 
&gt; 
&gt; # check to see if legend scheme is balanced
&gt; table(spatial.data$ProbCat)

 1  2  3 10 11 12 
 3  5  1  4  8 26</code></pre>
<div class="note">
<p><strong>NOTES</strong>: The relative estimates basically ranges from 0.70 to 2.93. There are 4 neighbourhoods with a reduced risk that’s significant. About 10 neighbourhoods that is not significant and 33 neighbourhoods with a significant increase risk. In terms of exceedance probabilities, there are 26 neighbourhoods predicted to have 100% chance of having increased risk of infestation. 8 neighbourhoods predicted to have 90-99% chance of having an increased risk of infestation, 4 with 80-89% chance, 1 neighbourhood with 10-19% chance, 8 neighbourhoods in total with &lt;1-9% chances of infestation.</p>
</div>
<p>Create the maps and save as .png format:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-1" tabindex="-1"></a><span class="co"># map of relative risk</span></span>
<span id="cb136-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-2" tabindex="-1"></a>rr_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb136-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-3" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;Risk_LiraA_2017_1&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cont&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Relavtive Risk [RR]&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;OrRd&quot;</span>) <span class="sc">+</span></span>
<span id="cb136-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-4" tabindex="-1"></a>    <span class="fu">tm_shape</span>(campina_grande_neighbourhoods) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.10</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;NeighNum&quot;</span>) <span class="sc">+</span></span>
<span id="cb136-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-5" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb136-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-6" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb136-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-7" tabindex="-1"></a></span>
<span id="cb136-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-8" tabindex="-1"></a><span class="co"># map of significance regions</span></span>
<span id="cb136-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-9" tabindex="-1"></a>sg_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb136-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-10" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;Sign_LiraA_2017_1&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cat&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Significance Categories&quot;</span>, </span>
<span id="cb136-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-11" tabindex="-1"></a>        <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&quot;#33a6fe&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;#fe0000&quot;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Significantly low&quot;</span>, <span class="st">&quot;Not Significant&quot;</span>, <span class="st">&quot;Significantly high&quot;</span>)) <span class="sc">+</span></span>
<span id="cb136-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-12" tabindex="-1"></a>    <span class="fu">tm_shape</span>(campina_grande_neighbourhoods) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.10</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;NeighNum&quot;</span>) <span class="sc">+</span></span>
<span id="cb136-13"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-13" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">1.2</span>, <span class="at">legend.text.size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb136-14"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-14" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb136-15"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-15" tabindex="-1"></a></span>
<span id="cb136-16"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-16" tabindex="-1"></a><span class="fu">tmap_save</span>(rr_map, <span class="st">&quot;rr_2017-1.png&quot;</span>, <span class="at">height =</span> <span class="dv">12</span>)</span>
<span id="cb136-17"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-17" tabindex="-1"></a><span class="fu">tmap_save</span>(sg_map, <span class="st">&quot;sign_2017-1.png&quot;</span>, <span class="at">height =</span> <span class="dv">12</span>)</span>
<span id="cb136-18"><a href="bayesian-updating-spatial-temporal-modelling.html#cb136-18" tabindex="-1"></a><span class="fu">tmap_save</span>(ep_map, <span class="st">&quot;ep_2017-1.png&quot;</span>, <span class="at">height =</span> <span class="dv">12</span>)</span></code></pre></div>
<p>We have completed the first part of the analysis with the baseline model. We are now going to implement the Bayesian updating with the April and July data set. Before we do any thing - make sure to save these results to avoid losing this work. We will the data set and use them later to chart the trajectory of risks to see if certain areas have sustained risk across all surveys periods.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb137-1" tabindex="-1"></a><span class="co"># retain dataset for future</span></span>
<span id="cb137-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb137-2" tabindex="-1"></a>baseline_result <span class="ot">&lt;-</span> <span class="fu">st_drop_geometry</span>(spatial.data)</span>
<span id="cb137-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb137-3" tabindex="-1"></a><span class="co"># save initial results</span></span>
<span id="cb137-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb137-4" tabindex="-1"></a><span class="fu">write.csv</span>(baseline_result, <span class="at">file =</span> <span class="st">&quot;Baseline 2017-1.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
</div>
</div>
<div id="apply-the-bayesian-updating-on-subsequent-data-sets" class="section level3 hasAnchor" number="6.1.6">
<h3><span class="header-section-number">6.1.6</span> Apply the Bayesian updating on subsequent data sets<a href="bayesian-updating-spatial-temporal-modelling.html#apply-the-bayesian-updating-on-subsequent-data-sets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We are going to implement the Bayesian updating on the following data frames: 1.) <code>Lira_2017_2</code> and <code>Lira_2017_3</code>. Therefore, we will need to create the subsequent data sets for the updating in the same manner as shown in <strong>section 7.2.3.2</strong>. Let’s start with <code>Lira_2017_2</code> and create a new list object called <code>stan.dataset.2017_2</code>.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb138-1" tabindex="-1"></a>y<span class="ot">=</span>Lira2017_2<span class="sc">$</span>InfestedNum</span>
<span id="cb138-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb138-2" tabindex="-1"></a>x<span class="ot">=</span>Lira2017_2[,<span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>,<span class="dv">12</span>)]</span>
<span id="cb138-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb138-3" tabindex="-1"></a>e<span class="ot">=</span>Lira2017_2<span class="sc">$</span>Expected</span>
<span id="cb138-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb138-4" tabindex="-1"></a></span>
<span id="cb138-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb138-5" tabindex="-1"></a>stan.dataset<span class="fl">.2017</span>_2<span class="ot">=</span><span class="fu">list</span>(<span class="at">N=</span>n, <span class="at">N_edges=</span>n_edges, <span class="at">node1=</span>nod1, <span class="at">node2=</span>nod2, <span class="at">Y=</span>y, <span class="at">X=</span>x, <span class="at">K=</span><span class="fu">length</span>(x), <span class="at">offset=</span>e)</span></code></pre></div>
<div class="note">
<p><strong>NOTES</strong>: The <code>y</code>, <code>x</code> and <code>e</code> will be overwritten.</p>
</div>
<p>Now, in the <code>stan()</code> function, instead of calling the Stan script for compilation - we will use the previous model object <code>Bayesian.model.baseline</code> in the <code>fit=</code> argument. The new dataset will be passed on to the <code>data=</code> argument. The updated posterior estimates for the relative risk will be passed into a new object called <code>Bayesian.model.updated1.2017_2</code>.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb139-1" tabindex="-1"></a><span class="co"># Start the clock and time duration</span></span>
<span id="cb139-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb139-2" tabindex="-1"></a>ptm <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb139-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb139-3" tabindex="-1"></a><span class="co"># Updated Bayesian model</span></span>
<span id="cb139-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb139-4" tabindex="-1"></a>Bayesian.model.updated1<span class="fl">.2017</span>_2 <span class="ot">=</span> <span class="fu">stan</span>(<span class="at">fit=</span>Bayesian.model.baseline, <span class="at">data=</span>stan.dataset<span class="fl">.2017</span>_2, <span class="at">iter=</span><span class="dv">60000</span>, <span class="at">chains=</span><span class="dv">6</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_treedepth =</span> <span class="dv">12</span>))</span>
<span id="cb139-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb139-5" tabindex="-1"></a><span class="co"># Stop the clock and report duration</span></span>
<span id="cb139-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb139-6" tabindex="-1"></a><span class="fu">proc.time</span>() <span class="sc">-</span> ptm</span></code></pre></div>
<p>Repeated the updating process again using the data set <code>Lira_2017_3</code> and previous model <code>Bayesian.model.updated1.2017_2</code>. The updated posterior estimates for the relative risk will be passed into a new object called <code>Bayesian.model.updated2.2017_3</code>.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-1" tabindex="-1"></a>y<span class="ot">=</span>Lira2017_3<span class="sc">$</span>InfestedNum</span>
<span id="cb140-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-2" tabindex="-1"></a>x<span class="ot">=</span>Lira2017_3[,<span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>,<span class="dv">12</span>)]</span>
<span id="cb140-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-3" tabindex="-1"></a>e<span class="ot">=</span>Lira2017_3<span class="sc">$</span>Expected</span>
<span id="cb140-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-4" tabindex="-1"></a></span>
<span id="cb140-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-5" tabindex="-1"></a>stan.dataset<span class="fl">.2017</span>_3<span class="ot">=</span><span class="fu">list</span>(<span class="at">N=</span>n, <span class="at">N_edges=</span>n_edges, <span class="at">node1=</span>nod1, <span class="at">node2=</span>nod2, <span class="at">Y=</span>y, <span class="at">X=</span>x, <span class="at">K=</span><span class="fu">length</span>(x), <span class="at">offset=</span>e)</span>
<span id="cb140-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-6" tabindex="-1"></a></span>
<span id="cb140-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-7" tabindex="-1"></a>ptm <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb140-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-8" tabindex="-1"></a>Bayesian.model.updated2<span class="fl">.2017</span>_3 <span class="ot">=</span> <span class="fu">stan</span>(<span class="at">fit=</span>Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">data=</span>stan.dataset<span class="fl">.2017</span>_3, <span class="at">iter=</span><span class="dv">60000</span>, <span class="at">chains=</span><span class="dv">6</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_treedepth =</span> <span class="dv">12</span>))</span>
<span id="cb140-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb140-9" tabindex="-1"></a><span class="fu">proc.time</span>() <span class="sc">-</span> ptm</span></code></pre></div>
<div id="extraction-of-updated-results-to-a-user-friendly-format" class="section level4 hasAnchor" number="6.1.6.1">
<h4><span class="header-section-number">6.1.6.1</span> Extraction of updated results to a user-friendly format<a href="bayesian-updating-spatial-temporal-modelling.html#extraction-of-updated-results-to-a-user-friendly-format" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The code for extraction is essentially the same as what’s shown in section 7.2.5. Here is the code for extracting the updated results from object <code>Bayesian.model.updated1.2017_2</code>:</p>
<details>
<summary>
<strong>[Click here to see code]:</strong>
</summary>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-1" tabindex="-1"></a><span class="co"># repeat the data management - Bayesian.model.updated1.2017_2</span></span>
<span id="cb141-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-2" tabindex="-1"></a><span class="co"># replace all key objects with Bayesian.model.updated1.2017_2</span></span>
<span id="cb141-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-3" tabindex="-1"></a></span>
<span id="cb141-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-4" tabindex="-1"></a><span class="co"># diagnostics</span></span>
<span id="cb141-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-5" tabindex="-1"></a><span class="co"># diagnostic check on the rHats - put everything into a data frame</span></span>
<span id="cb141-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-6" tabindex="-1"></a>diagnostic.checks <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb141-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-7" tabindex="-1"></a><span class="co"># create binary variable</span></span>
<span id="cb141-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-8" tabindex="-1"></a>diagnostic.checks<span class="sc">$</span>valid <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(diagnostic.checks<span class="sc">$</span>Rhat <span class="sc">&lt;</span> <span class="fl">1.05</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb141-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-9" tabindex="-1"></a><span class="co"># tabulate it</span></span>
<span id="cb141-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-10" tabindex="-1"></a><span class="fu">table</span>(diagnostic.checks<span class="sc">$</span>valid)</span>
<span id="cb141-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-11" tabindex="-1"></a></span>
<span id="cb141-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-12" tabindex="-1"></a><span class="co"># check rHAT &lt; 1.05</span></span>
<span id="cb141-13"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-13" tabindex="-1"></a><span class="co"># check chains for samples that diverged (should not exceed 10% of the total 180000)</span></span>
<span id="cb141-14"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-14" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">inc_warmup =</span> F)[[<span class="dv">1</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 1</span></span>
<span id="cb141-15"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-15" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">inc_warmup =</span> F)[[<span class="dv">2</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 2</span></span>
<span id="cb141-16"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-16" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">inc_warmup =</span> F)[[<span class="dv">3</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 3</span></span>
<span id="cb141-17"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-17" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">inc_warmup =</span> F)[[<span class="dv">4</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 4</span></span>
<span id="cb141-18"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-18" tabindex="-1"></a>d5 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">inc_warmup =</span> F)[[<span class="dv">5</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 5</span></span>
<span id="cb141-19"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-19" tabindex="-1"></a>d6 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">inc_warmup =</span> F)[[<span class="dv">6</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 6</span></span>
<span id="cb141-20"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-20" tabindex="-1"></a>(d1<span class="sc">+</span>d2<span class="sc">+</span>d3<span class="sc">+</span>d4<span class="sc">+</span>d5<span class="sc">+</span>d6)<span class="sc">/</span><span class="dv">180000</span> <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb141-21"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-21" tabindex="-1"></a></span>
<span id="cb141-22"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-22" tabindex="-1"></a><span class="co"># extract the exceedance probabilities for the intercept &amp; each beta coefficient</span></span>
<span id="cb141-23"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-23" tabindex="-1"></a><span class="co"># note: the previous alpha.exc.probs and beta.exc.probs will be overwritten!</span></span>
<span id="cb141-24"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-24" tabindex="-1"></a>threshold.intercept <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">0.00</span>)}</span>
<span id="cb141-25"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-25" tabindex="-1"></a>alpha.exc.probs <span class="ot">&lt;-</span> Bayesian.model.updated1<span class="fl">.2017</span>_2 <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(alpha) <span class="sc">%&gt;%</span> </span>
<span id="cb141-26"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-26" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">alpha=</span><span class="fu">threshold.intercept</span>(alpha)) <span class="sc">%&gt;%</span></span>
<span id="cb141-27"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-27" tabindex="-1"></a>    <span class="fu">pull</span>(alpha)</span>
<span id="cb141-28"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-28" tabindex="-1"></a></span>
<span id="cb141-29"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-29" tabindex="-1"></a>threshold.coefficients <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">0.00</span>)}</span>
<span id="cb141-30"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-30" tabindex="-1"></a>beta.exc.probs <span class="ot">&lt;-</span> Bayesian.model.updated1<span class="fl">.2017</span>_2 <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(beta[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb141-31"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-31" tabindex="-1"></a>    <span class="fu">group_by</span>(i) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">beta=</span><span class="fu">threshold.coefficients</span>(beta)) <span class="sc">%&gt;%</span></span>
<span id="cb141-32"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-32" tabindex="-1"></a>    <span class="fu">pull</span>(beta)</span>
<span id="cb141-33"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-33" tabindex="-1"></a></span>
<span id="cb141-34"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-34" tabindex="-1"></a><span class="co"># reports updated exceedance probabilities from Bayesian.model.updated1.2017_2</span></span>
<span id="cb141-35"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-35" tabindex="-1"></a>alpha.exc.probs</span>
<span id="cb141-36"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-36" tabindex="-1"></a>beta.exc.probs</span>
<span id="cb141-37"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-37" tabindex="-1"></a></span>
<span id="cb141-38"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-38" tabindex="-1"></a><span class="co"># Step 1: create the names in the appropriate order as there were modelled in Stan</span></span>
<span id="cb141-39"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-39" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Intercept&quot;</span>, <span class="st">&quot;Temperature&quot;</span>, <span class="st">&quot;Precipitation&quot;</span>, <span class="st">&quot;NDVI&quot;</span>, <span class="st">&quot;Urbanisation&quot;</span>)</span>
<span id="cb141-40"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-40" tabindex="-1"></a></span>
<span id="cb141-41"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-41" tabindex="-1"></a><span class="co"># Step 2: now, pull all global relative risk results into the object called &#39;results&#39;</span></span>
<span id="cb141-42"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-42" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;rr_alpha&quot;</span>, <span class="st">&quot;rr_beta&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb141-43"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-43" tabindex="-1"></a>results<span class="sc">$</span>variables <span class="ot">&lt;-</span> names</span>
<span id="cb141-44"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-44" tabindex="-1"></a><span class="fu">row.names</span>(results) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)</span>
<span id="cb141-45"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-45" tabindex="-1"></a></span>
<span id="cb141-46"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-46" tabindex="-1"></a><span class="co"># Step 3: fudge with the results to make it look clean</span></span>
<span id="cb141-47"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-47" tabindex="-1"></a>results <span class="ot">&lt;-</span> results[,<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>)]</span>
<span id="cb141-48"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-48" tabindex="-1"></a>results<span class="sc">$</span>mean <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>mean, <span class="dv">4</span>)</span>
<span id="cb141-49"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-49" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;coefficient&quot;</span></span>
<span id="cb141-50"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-50" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;lower95&quot;</span></span>
<span id="cb141-51"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-51" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&quot;upper95&quot;</span></span>
<span id="cb141-52"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-52" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ess&quot;</span></span>
<span id="cb141-53"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-53" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rhat&quot;</span></span>
<span id="cb141-54"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-54" tabindex="-1"></a>results<span class="sc">$</span>lower95<span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>lower95, <span class="dv">4</span>)</span>
<span id="cb141-55"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-55" tabindex="-1"></a>results<span class="sc">$</span>upper95 <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>upper95, <span class="dv">4</span>)</span>
<span id="cb141-56"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-56" tabindex="-1"></a>results<span class="sc">$</span>ess <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>ess, <span class="dv">0</span>)</span>
<span id="cb141-57"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-57" tabindex="-1"></a>results<span class="sc">$</span>rhat <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>rhat, <span class="dv">4</span>)</span>
<span id="cb141-58"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-58" tabindex="-1"></a></span>
<span id="cb141-59"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-59" tabindex="-1"></a><span class="co"># Step 4: stitch the credibility results as text so it reads as (95% CrI: XXX to XXX)</span></span>
<span id="cb141-60"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-60" tabindex="-1"></a>results<span class="sc">$</span>beta_95CrI <span class="ot">&lt;-</span> <span class="fu">paste</span>(results<span class="sc">$</span>coefficient, <span class="st">&quot; (95% CrI: &quot;</span>, results<span class="sc">$</span>lower95, <span class="st">&quot; to &quot;</span>, results<span class="sc">$</span>upper95, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb141-61"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-61" tabindex="-1"></a></span>
<span id="cb141-62"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-62" tabindex="-1"></a><span class="co"># Step 5: pull the exceedance probabilities into the result table</span></span>
<span id="cb141-63"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-63" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">c</span>(alpha.exc.probs, beta.exc.probs)</span>
<span id="cb141-64"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-64" tabindex="-1"></a>results<span class="sc">$</span>ExceedanceProb <span class="ot">&lt;-</span> <span class="fu">round</span>(a, <span class="dv">4</span>)</span>
<span id="cb141-65"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-65" tabindex="-1"></a>results<span class="sc">$</span>Uncertainty <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Prob = &quot;</span>, results<span class="sc">$</span>ExceedanceProb, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb141-66"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-66" tabindex="-1"></a></span>
<span id="cb141-67"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-67" tabindex="-1"></a><span class="co"># Step 6: finally, more fudging around with the results to make it look cleaner and done!</span></span>
<span id="cb141-68"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-68" tabindex="-1"></a>final.output <span class="ot">&lt;-</span> results[,<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">5</span>, <span class="dv">6</span>)]</span>
<span id="cb141-69"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-69" tabindex="-1"></a></span>
<span id="cb141-70"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-70" tabindex="-1"></a><span class="co"># view final output and... presto! not too shabby!</span></span>
<span id="cb141-71"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-71" tabindex="-1"></a>final.output</span>
<span id="cb141-72"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-72" tabindex="-1"></a></span>
<span id="cb141-73"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-73" tabindex="-1"></a><span class="co"># Now export regression results into a .csv file</span></span>
<span id="cb141-74"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-74" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: Update this line of code and save the file with a different name</span></span>
<span id="cb141-75"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-75" tabindex="-1"></a><span class="fu">write.csv</span>(final.output, <span class="at">file =</span> <span class="st">&quot;Updated_Result_April_2017.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb141-76"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-76" tabindex="-1"></a></span>
<span id="cb141-77"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-77" tabindex="-1"></a><span class="co"># spatial maps of relative risks</span></span>
<span id="cb141-78"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-78" tabindex="-1"></a></span>
<span id="cb141-79"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-79" tabindex="-1"></a><span class="co"># extraction of key updated posterior results for the generated quantities </span></span>
<span id="cb141-80"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-80" tabindex="-1"></a>relativeRisk.results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(Bayesian.model.updated1<span class="fl">.2017</span>_2, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;rr_mu&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb141-81"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-81" tabindex="-1"></a><span class="co"># now cleaning up this table up</span></span>
<span id="cb141-82"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-82" tabindex="-1"></a><span class="co"># first, insert clean row numbers to new data frame</span></span>
<span id="cb141-83"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-83" tabindex="-1"></a><span class="fu">row.names</span>(relativeRisk.results) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(relativeRisk.results)</span>
<span id="cb141-84"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-84" tabindex="-1"></a><span class="co"># second, rearrange the columns into order</span></span>
<span id="cb141-85"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-85" tabindex="-1"></a>relativeRisk.results <span class="ot">&lt;-</span> relativeRisk.results[, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>)]</span>
<span id="cb141-86"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-86" tabindex="-1"></a><span class="co"># third, rename the columns appropriately</span></span>
<span id="cb141-87"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-87" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rr&quot;</span></span>
<span id="cb141-88"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-88" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rrlower&quot;</span></span>
<span id="cb141-89"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-89" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rrupper&quot;</span></span>
<span id="cb141-90"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-90" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rHAT&quot;</span></span>
<span id="cb141-91"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-91" tabindex="-1"></a></span>
<span id="cb141-92"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-92" tabindex="-1"></a><span class="co"># template for merging spatial risk data</span></span>
<span id="cb141-93"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-93" tabindex="-1"></a>spatial.data <span class="ot">&lt;-</span> campina_grande_neighbourhoods</span>
<span id="cb141-94"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-94" tabindex="-1"></a><span class="co"># now, we proceed to generate our risk maps</span></span>
<span id="cb141-95"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-95" tabindex="-1"></a><span class="co"># align the results to the areas in shapefile</span></span>
<span id="cb141-96"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-96" tabindex="-1"></a>spatial.data<span class="sc">$</span>rr <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rr&quot;</span>]</span>
<span id="cb141-97"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-97" tabindex="-1"></a>spatial.data<span class="sc">$</span>rrlower <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rrlower&quot;</span>]</span>
<span id="cb141-98"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-98" tabindex="-1"></a>spatial.data<span class="sc">$</span>rrupper <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rrupper&quot;</span>]</span>
<span id="cb141-99"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-99" tabindex="-1"></a></span>
<span id="cb141-100"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-100" tabindex="-1"></a><span class="co"># create categories to define if an area has significant increase or decrease in risk, or nothing all </span></span>
<span id="cb141-101"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-101" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb141-102"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-102" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&gt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>    <span class="co"># NOT SIGNIFICANT</span></span>
<span id="cb141-103"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-103" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># NOT SIGNIFICANT</span></span>
<span id="cb141-104"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-104" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&gt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>    <span class="co"># SIGNIFICANT INCREASE</span></span>
<span id="cb141-105"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-105" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&lt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span>   <span class="co"># SIGNIFICANT DECREASE</span></span>
<span id="cb141-106"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-106" tabindex="-1"></a></span>
<span id="cb141-107"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-107" tabindex="-1"></a><span class="fu">summary</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb141-108"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-108" tabindex="-1"></a><span class="fu">hist</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb141-109"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-109" tabindex="-1"></a><span class="fu">table</span>(spatial.data<span class="sc">$</span>Significance)</span>
<span id="cb141-110"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-110" tabindex="-1"></a></span>
<span id="cb141-111"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-111" tabindex="-1"></a><span class="co"># we create these column to preserve this result for the updates from April</span></span>
<span id="cb141-112"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-112" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;_2&#39; to show its for April</span></span>
<span id="cb141-113"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-113" tabindex="-1"></a><span class="fu">colnames</span>(spatial.data)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Risk_LiraA_2017_2&quot;</span></span>
<span id="cb141-114"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-114" tabindex="-1"></a><span class="fu">colnames</span>(spatial.data)[<span class="dv">8</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Sign_LiraA_2017_2&quot;</span></span>
<span id="cb141-115"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-115" tabindex="-1"></a>spatial.data<span class="sc">$</span>LiraA_2017_2 <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">round</span>(spatial.data<span class="sc">$</span>Risk_LiraA_2017_2,<span class="dv">2</span>), <span class="st">&quot; (95% CrI:&quot;</span>, <span class="fu">round</span>(spatial.data<span class="sc">$</span>rrlower,<span class="dv">2</span>), <span class="st">&quot;,&quot;</span>, <span class="fu">round</span>(spatial.data<span class="sc">$</span>rrupper,<span class="dv">2</span>), <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb141-116"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-116" tabindex="-1"></a></span>
<span id="cb141-117"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-117" tabindex="-1"></a>campina_grande_neighbourhoods<span class="sc">$</span>NeighNum <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(campina_grande_neighbourhoods<span class="sc">$</span>NeighNum)</span>
<span id="cb141-118"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-118" tabindex="-1"></a><span class="co"># map of relative risk</span></span>
<span id="cb141-119"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-119" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;_2&#39; to show its for April</span></span>
<span id="cb141-120"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-120" tabindex="-1"></a>rr_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb141-121"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-121" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;Risk_LiraA_2017_2&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cont&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Relavtive Risk [RR]&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;OrRd&quot;</span>) <span class="sc">+</span></span>
<span id="cb141-122"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-122" tabindex="-1"></a>    <span class="fu">tm_shape</span>(campina_grande_neighbourhoods) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.10</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;NeighNum&quot;</span>) <span class="sc">+</span></span>
<span id="cb141-123"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-123" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb141-124"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-124" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb141-125"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-125" tabindex="-1"></a></span>
<span id="cb141-126"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-126" tabindex="-1"></a><span class="co"># map of significance regions</span></span>
<span id="cb141-127"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-127" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;_2&#39; to show its for April</span></span>
<span id="cb141-128"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-128" tabindex="-1"></a>sg_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb141-129"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-129" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;Sign_LiraA_2017_2&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cat&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Significance Categories&quot;</span>, </span>
<span id="cb141-130"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-130" tabindex="-1"></a>        <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&quot;#33a6fe&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;#fe0000&quot;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Significantly low&quot;</span>, <span class="st">&quot;Not Significant&quot;</span>, <span class="st">&quot;Significantly high&quot;</span>)) <span class="sc">+</span></span>
<span id="cb141-131"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-131" tabindex="-1"></a>    <span class="fu">tm_shape</span>(campina_grande_neighbourhoods) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.10</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;NeighNum&quot;</span>) <span class="sc">+</span></span>
<span id="cb141-132"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-132" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">1.2</span>, <span class="at">legend.text.size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb141-133"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-133" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb141-134"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-134" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;-2&#39; to show its for April</span></span>
<span id="cb141-135"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-135" tabindex="-1"></a><span class="fu">tmap_save</span>(rr_map, <span class="st">&quot;rr_2017-2.png&quot;</span>, <span class="at">height =</span> <span class="dv">12</span>)</span>
<span id="cb141-136"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-136" tabindex="-1"></a><span class="fu">tmap_save</span>(sg_map, <span class="st">&quot;sign_2017-2.png&quot;</span>, <span class="at">height =</span> <span class="dv">12</span>)</span>
<span id="cb141-137"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-137" tabindex="-1"></a></span>
<span id="cb141-138"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-138" tabindex="-1"></a><span class="co"># chart the trajectory of risks to see if the remain sustained across all LIRAa surveys</span></span>
<span id="cb141-139"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-139" tabindex="-1"></a><span class="co"># create a sink for data posterior estimates and build</span></span>
<span id="cb141-140"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-140" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;_2&#39; to show its for April</span></span>
<span id="cb141-141"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-141" tabindex="-1"></a>risk_data_2 <span class="ot">&lt;-</span> <span class="fu">st_drop_geometry</span>(spatial.data[,<span class="fu">c</span>(<span class="st">&quot;osmID&quot;</span>, <span class="st">&quot;NeighNum&quot;</span>, <span class="st">&quot;Risk_LiraA_2017_2&quot;</span>, <span class="st">&quot;Sign_LiraA_2017_2&quot;</span>, <span class="st">&quot;LiraA_2017_2&quot;</span>)])</span>
<span id="cb141-142"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-142" tabindex="-1"></a><span class="co"># all results will be sinked into this subsequent file</span></span>
<span id="cb141-143"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-143" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;-2&#39; to show its for April</span></span>
<span id="cb141-144"><a href="bayesian-updating-spatial-temporal-modelling.html#cb141-144" tabindex="-1"></a><span class="fu">write.csv</span>(risk_data_2, <span class="at">file =</span> <span class="st">&quot;Updated 2017-2.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<p>Here is the code for extracting the updated results from object <code>Bayesian.model.updated2.2017_3</code>:</p>
<details>
<summary>
<strong>[Click here to see code]:</strong>
</summary>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-1" tabindex="-1"></a><span class="co"># again, repeat the data management for Bayesian.model.updated2.2017_3</span></span>
<span id="cb142-2"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-2" tabindex="-1"></a><span class="co"># replace all key objects with Bayesian.model.updated2.2017_3</span></span>
<span id="cb142-3"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-3" tabindex="-1"></a></span>
<span id="cb142-4"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-4" tabindex="-1"></a><span class="co"># diagnostics</span></span>
<span id="cb142-5"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-5" tabindex="-1"></a><span class="co"># diagnostic check on the rHats - put everything into a data frame</span></span>
<span id="cb142-6"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-6" tabindex="-1"></a>diagnostic.checks <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb142-7"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-7" tabindex="-1"></a><span class="co"># create binary variable</span></span>
<span id="cb142-8"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-8" tabindex="-1"></a>diagnostic.checks<span class="sc">$</span>valid <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(diagnostic.checks<span class="sc">$</span>Rhat <span class="sc">&lt;</span> <span class="fl">1.05</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb142-9"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-9" tabindex="-1"></a><span class="co"># tabulate it</span></span>
<span id="cb142-10"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-10" tabindex="-1"></a><span class="fu">table</span>(diagnostic.checks<span class="sc">$</span>valid)</span>
<span id="cb142-11"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-11" tabindex="-1"></a></span>
<span id="cb142-12"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-12" tabindex="-1"></a><span class="co"># check rHAT &lt; 1.05</span></span>
<span id="cb142-13"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-13" tabindex="-1"></a><span class="co"># check chains for samples that diverged (should not exceed 10% of the total 180000)</span></span>
<span id="cb142-14"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-14" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">inc_warmup =</span> F)[[<span class="dv">1</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 1</span></span>
<span id="cb142-15"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-15" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">inc_warmup =</span> F)[[<span class="dv">2</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 2</span></span>
<span id="cb142-16"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-16" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">inc_warmup =</span> F)[[<span class="dv">3</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 3</span></span>
<span id="cb142-17"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-17" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">inc_warmup =</span> F)[[<span class="dv">4</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 4</span></span>
<span id="cb142-18"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-18" tabindex="-1"></a>d5 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">inc_warmup =</span> F)[[<span class="dv">5</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 5</span></span>
<span id="cb142-19"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-19" tabindex="-1"></a>d6 <span class="ot">&lt;-</span> <span class="fu">get_sampler_params</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">inc_warmup =</span> F)[[<span class="dv">6</span>]][, <span class="st">&#39;divergent__&#39;</span>] <span class="sc">%&gt;%</span> <span class="fu">sum</span>() <span class="co"># chain 6</span></span>
<span id="cb142-20"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-20" tabindex="-1"></a>(d1<span class="sc">+</span>d2<span class="sc">+</span>d3<span class="sc">+</span>d4<span class="sc">+</span>d5<span class="sc">+</span>d6)<span class="sc">/</span><span class="dv">180000</span> <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb142-21"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-21" tabindex="-1"></a></span>
<span id="cb142-22"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-22" tabindex="-1"></a><span class="co"># extract the exceedance probabilities for the intercept &amp; each beta coefficient</span></span>
<span id="cb142-23"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-23" tabindex="-1"></a><span class="co"># note: the previous alpha.exc.probs and beta.exc.probs will be overwritten!</span></span>
<span id="cb142-24"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-24" tabindex="-1"></a>threshold.intercept <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">0.00</span>)}</span>
<span id="cb142-25"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-25" tabindex="-1"></a>alpha.exc.probs <span class="ot">&lt;-</span> Bayesian.model.updated2<span class="fl">.2017</span>_3 <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(alpha) <span class="sc">%&gt;%</span> </span>
<span id="cb142-26"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-26" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">alpha=</span><span class="fu">threshold.intercept</span>(alpha)) <span class="sc">%&gt;%</span></span>
<span id="cb142-27"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-27" tabindex="-1"></a>    <span class="fu">pull</span>(alpha)</span>
<span id="cb142-28"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-28" tabindex="-1"></a></span>
<span id="cb142-29"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-29" tabindex="-1"></a>threshold.coefficients <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">0.00</span>)}</span>
<span id="cb142-30"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-30" tabindex="-1"></a>beta.exc.probs <span class="ot">&lt;-</span> Bayesian.model.updated2<span class="fl">.2017</span>_3 <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(beta[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb142-31"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-31" tabindex="-1"></a>    <span class="fu">group_by</span>(i) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">beta=</span><span class="fu">threshold.coefficients</span>(beta)) <span class="sc">%&gt;%</span></span>
<span id="cb142-32"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-32" tabindex="-1"></a>    <span class="fu">pull</span>(beta)</span>
<span id="cb142-33"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-33" tabindex="-1"></a></span>
<span id="cb142-34"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-34" tabindex="-1"></a><span class="co"># reports updated exceedance probabilities from Bayesian.model.updated2.2017_3</span></span>
<span id="cb142-35"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-35" tabindex="-1"></a>alpha.exc.probs</span>
<span id="cb142-36"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-36" tabindex="-1"></a>beta.exc.probs</span>
<span id="cb142-37"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-37" tabindex="-1"></a></span>
<span id="cb142-38"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-38" tabindex="-1"></a><span class="co"># Step 1: create the names in the appropriate order as there were modelled in Stan</span></span>
<span id="cb142-39"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-39" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Intercept&quot;</span>, <span class="st">&quot;Temperature&quot;</span>, <span class="st">&quot;Precipitation&quot;</span>, <span class="st">&quot;NDVI&quot;</span>, <span class="st">&quot;Urbanisation&quot;</span>)</span>
<span id="cb142-40"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-40" tabindex="-1"></a></span>
<span id="cb142-41"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-41" tabindex="-1"></a><span class="co"># Step 2: now, pull all global relative risk results into the object called &#39;results&#39;</span></span>
<span id="cb142-42"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-42" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;rr_alpha&quot;</span>, <span class="st">&quot;rr_beta&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb142-43"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-43" tabindex="-1"></a>results<span class="sc">$</span>variables <span class="ot">&lt;-</span> names</span>
<span id="cb142-44"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-44" tabindex="-1"></a><span class="fu">row.names</span>(results) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)</span>
<span id="cb142-45"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-45" tabindex="-1"></a></span>
<span id="cb142-46"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-46" tabindex="-1"></a><span class="co"># Step 3: fudge with the results to make it look clean</span></span>
<span id="cb142-47"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-47" tabindex="-1"></a>results <span class="ot">&lt;-</span> results[,<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>)]</span>
<span id="cb142-48"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-48" tabindex="-1"></a>results<span class="sc">$</span>mean <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>mean, <span class="dv">4</span>)</span>
<span id="cb142-49"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-49" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;coefficient&quot;</span></span>
<span id="cb142-50"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-50" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;lower95&quot;</span></span>
<span id="cb142-51"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-51" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&quot;upper95&quot;</span></span>
<span id="cb142-52"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-52" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ess&quot;</span></span>
<span id="cb142-53"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-53" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rhat&quot;</span></span>
<span id="cb142-54"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-54" tabindex="-1"></a>results<span class="sc">$</span>lower95<span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>lower95, <span class="dv">4</span>)</span>
<span id="cb142-55"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-55" tabindex="-1"></a>results<span class="sc">$</span>upper95 <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>upper95, <span class="dv">4</span>)</span>
<span id="cb142-56"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-56" tabindex="-1"></a>results<span class="sc">$</span>ess <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>ess, <span class="dv">0</span>)</span>
<span id="cb142-57"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-57" tabindex="-1"></a>results<span class="sc">$</span>rhat <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>rhat, <span class="dv">4</span>)</span>
<span id="cb142-58"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-58" tabindex="-1"></a></span>
<span id="cb142-59"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-59" tabindex="-1"></a><span class="co"># Step 4: stitch the credibility results as text so it reads as (95% CrI: XXX to XXX)</span></span>
<span id="cb142-60"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-60" tabindex="-1"></a>results<span class="sc">$</span>beta_95CrI <span class="ot">&lt;-</span> <span class="fu">paste</span>(results<span class="sc">$</span>coefficient, <span class="st">&quot; (95% CrI: &quot;</span>, results<span class="sc">$</span>lower95, <span class="st">&quot; to &quot;</span>, results<span class="sc">$</span>upper95, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb142-61"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-61" tabindex="-1"></a></span>
<span id="cb142-62"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-62" tabindex="-1"></a><span class="co"># Step 5: pull the exceedance probabilities into the result table</span></span>
<span id="cb142-63"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-63" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">c</span>(alpha.exc.probs, beta.exc.probs)</span>
<span id="cb142-64"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-64" tabindex="-1"></a>results<span class="sc">$</span>ExceedanceProb <span class="ot">&lt;-</span> <span class="fu">round</span>(a, <span class="dv">4</span>)</span>
<span id="cb142-65"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-65" tabindex="-1"></a>results<span class="sc">$</span>Uncertainty <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Prob = &quot;</span>, results<span class="sc">$</span>ExceedanceProb, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb142-66"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-66" tabindex="-1"></a></span>
<span id="cb142-67"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-67" tabindex="-1"></a><span class="co"># Step 6: finally, more fudging around with the results to make it look cleaner and done!</span></span>
<span id="cb142-68"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-68" tabindex="-1"></a>final.output <span class="ot">&lt;-</span> results[,<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">5</span>, <span class="dv">6</span>)]</span>
<span id="cb142-69"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-69" tabindex="-1"></a></span>
<span id="cb142-70"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-70" tabindex="-1"></a><span class="co"># view final output and... presto! not too shabby!</span></span>
<span id="cb142-71"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-71" tabindex="-1"></a>final.output</span>
<span id="cb142-72"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-72" tabindex="-1"></a></span>
<span id="cb142-73"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-73" tabindex="-1"></a><span class="co"># Now export regression results into a .csv file</span></span>
<span id="cb142-74"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-74" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: Update this line of code and save the file with a different name</span></span>
<span id="cb142-75"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-75" tabindex="-1"></a><span class="fu">write.csv</span>(final.output, <span class="at">file =</span> <span class="st">&quot;Updated_Result_July_2017.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb142-76"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-76" tabindex="-1"></a></span>
<span id="cb142-77"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-77" tabindex="-1"></a><span class="co"># spatial maps of relative risks</span></span>
<span id="cb142-78"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-78" tabindex="-1"></a></span>
<span id="cb142-79"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-79" tabindex="-1"></a><span class="co"># extraction of key updated posterior results for the generated quantities </span></span>
<span id="cb142-80"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-80" tabindex="-1"></a>relativeRisk.results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(Bayesian.model.updated2<span class="fl">.2017</span>_3, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;rr_mu&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb142-81"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-81" tabindex="-1"></a><span class="co"># now cleaning up this table up</span></span>
<span id="cb142-82"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-82" tabindex="-1"></a><span class="co"># first, insert clean row numbers to new data frame</span></span>
<span id="cb142-83"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-83" tabindex="-1"></a><span class="fu">row.names</span>(relativeRisk.results) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(relativeRisk.results)</span>
<span id="cb142-84"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-84" tabindex="-1"></a><span class="co"># second, rearrange the columns into order</span></span>
<span id="cb142-85"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-85" tabindex="-1"></a>relativeRisk.results <span class="ot">&lt;-</span> relativeRisk.results[, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>)]</span>
<span id="cb142-86"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-86" tabindex="-1"></a><span class="co"># third, rename the columns appropriately</span></span>
<span id="cb142-87"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-87" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rr&quot;</span></span>
<span id="cb142-88"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-88" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rrlower&quot;</span></span>
<span id="cb142-89"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-89" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rrupper&quot;</span></span>
<span id="cb142-90"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-90" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rHAT&quot;</span></span>
<span id="cb142-91"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-91" tabindex="-1"></a></span>
<span id="cb142-92"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-92" tabindex="-1"></a><span class="co"># template for merging spatial risk data</span></span>
<span id="cb142-93"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-93" tabindex="-1"></a>spatial.data <span class="ot">&lt;-</span> campina_grande_neighbourhoods</span>
<span id="cb142-94"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-94" tabindex="-1"></a><span class="co"># now, we proceed to generate our risk maps</span></span>
<span id="cb142-95"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-95" tabindex="-1"></a><span class="co"># align the results to the areas in shapefile</span></span>
<span id="cb142-96"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-96" tabindex="-1"></a>spatial.data<span class="sc">$</span>rr <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rr&quot;</span>]</span>
<span id="cb142-97"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-97" tabindex="-1"></a>spatial.data<span class="sc">$</span>rrlower <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rrlower&quot;</span>]</span>
<span id="cb142-98"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-98" tabindex="-1"></a>spatial.data<span class="sc">$</span>rrupper <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rrupper&quot;</span>]</span>
<span id="cb142-99"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-99" tabindex="-1"></a></span>
<span id="cb142-100"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-100" tabindex="-1"></a><span class="co"># create categories to define if an area has significant increase or decrease in risk, or nothing all </span></span>
<span id="cb142-101"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-101" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb142-102"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-102" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&gt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>    <span class="co"># NOT SIGNIFICANT</span></span>
<span id="cb142-103"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-103" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># NOT SIGNIFICANT</span></span>
<span id="cb142-104"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-104" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&gt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>    <span class="co"># SIGNIFICANT INCREASE</span></span>
<span id="cb142-105"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-105" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&lt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span>   <span class="co"># SIGNIFICANT DECREASE</span></span>
<span id="cb142-106"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-106" tabindex="-1"></a></span>
<span id="cb142-107"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-107" tabindex="-1"></a><span class="fu">summary</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb142-108"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-108" tabindex="-1"></a><span class="fu">hist</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb142-109"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-109" tabindex="-1"></a><span class="fu">table</span>(spatial.data<span class="sc">$</span>Significance)</span>
<span id="cb142-110"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-110" tabindex="-1"></a></span>
<span id="cb142-111"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-111" tabindex="-1"></a><span class="co"># we create these column to preserve this result for the updates from April</span></span>
<span id="cb142-112"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-112" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;_3&#39; to show its for April</span></span>
<span id="cb142-113"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-113" tabindex="-1"></a><span class="fu">colnames</span>(spatial.data)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Risk_LiraA_2017_3&quot;</span></span>
<span id="cb142-114"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-114" tabindex="-1"></a><span class="fu">colnames</span>(spatial.data)[<span class="dv">8</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Sign_LiraA_2017_3&quot;</span></span>
<span id="cb142-115"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-115" tabindex="-1"></a>spatial.data<span class="sc">$</span>LiraA_2017_3 <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">round</span>(spatial.data<span class="sc">$</span>Risk_LiraA_2017_3,<span class="dv">2</span>), <span class="st">&quot; (95% CrI:&quot;</span>, <span class="fu">round</span>(spatial.data<span class="sc">$</span>rrlower,<span class="dv">2</span>), <span class="st">&quot;,&quot;</span>, <span class="fu">round</span>(spatial.data<span class="sc">$</span>rrupper,<span class="dv">2</span>), <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb142-116"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-116" tabindex="-1"></a></span>
<span id="cb142-117"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-117" tabindex="-1"></a>campina_grande_neighbourhoods<span class="sc">$</span>NeighNum <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(campina_grande_neighbourhoods<span class="sc">$</span>NeighNum)</span>
<span id="cb142-118"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-118" tabindex="-1"></a><span class="co"># map of relative risk</span></span>
<span id="cb142-119"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-119" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;_3&#39; to show its for April</span></span>
<span id="cb142-120"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-120" tabindex="-1"></a>rr_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb142-121"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-121" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;Risk_LiraA_2017_3&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cont&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Relavtive Risk [RR]&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;OrRd&quot;</span>) <span class="sc">+</span></span>
<span id="cb142-122"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-122" tabindex="-1"></a>    <span class="fu">tm_shape</span>(campina_grande_neighbourhoods) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.10</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;NeighNum&quot;</span>) <span class="sc">+</span></span>
<span id="cb142-123"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-123" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb142-124"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-124" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb142-125"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-125" tabindex="-1"></a></span>
<span id="cb142-126"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-126" tabindex="-1"></a><span class="co"># map of significance regions</span></span>
<span id="cb142-127"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-127" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;_3&#39; to show its for April</span></span>
<span id="cb142-128"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-128" tabindex="-1"></a>sg_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb142-129"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-129" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;Sign_LiraA_2017_3&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cat&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Significance Categories&quot;</span>, </span>
<span id="cb142-130"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-130" tabindex="-1"></a>        <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&quot;#33a6fe&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;#fe0000&quot;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Significantly low&quot;</span>, <span class="st">&quot;Not Significant&quot;</span>, <span class="st">&quot;Significantly high&quot;</span>)) <span class="sc">+</span></span>
<span id="cb142-131"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-131" tabindex="-1"></a>    <span class="fu">tm_shape</span>(campina_grande_neighbourhoods) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.10</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;NeighNum&quot;</span>) <span class="sc">+</span></span>
<span id="cb142-132"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-132" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">1.2</span>, <span class="at">legend.text.size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb142-133"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-133" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb142-134"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-134" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;-3&#39; to show its for April</span></span>
<span id="cb142-135"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-135" tabindex="-1"></a><span class="fu">tmap_save</span>(rr_map, <span class="st">&quot;rr_2017-3.png&quot;</span>, <span class="at">height =</span> <span class="dv">12</span>)</span>
<span id="cb142-136"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-136" tabindex="-1"></a><span class="fu">tmap_save</span>(sg_map, <span class="st">&quot;sign_2017-3.png&quot;</span>, <span class="at">height =</span> <span class="dv">12</span>)</span>
<span id="cb142-137"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-137" tabindex="-1"></a></span>
<span id="cb142-138"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-138" tabindex="-1"></a><span class="co"># chart the trajectory of risks to see if the remain sustained across all LIRAa surveys</span></span>
<span id="cb142-139"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-139" tabindex="-1"></a><span class="co"># create a sink for data posterior estimates and build</span></span>
<span id="cb142-140"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-140" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;_3&#39; to show its for July</span></span>
<span id="cb142-141"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-141" tabindex="-1"></a>risk_data_3 <span class="ot">&lt;-</span> <span class="fu">st_drop_geometry</span>(spatial.data[,<span class="fu">c</span>(<span class="st">&quot;osmID&quot;</span>, <span class="st">&quot;NeighNum&quot;</span>, <span class="st">&quot;Risk_LiraA_2017_3&quot;</span>, <span class="st">&quot;Sign_LiraA_2017_3&quot;</span>, <span class="st">&quot;LiraA_2017_3&quot;</span>)])</span>
<span id="cb142-142"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-142" tabindex="-1"></a><span class="co"># all results will be sinked into this subsequent file</span></span>
<span id="cb142-143"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-143" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: This code needs to change &#39;-3&#39; to show its for April</span></span>
<span id="cb142-144"><a href="bayesian-updating-spatial-temporal-modelling.html#cb142-144" tabindex="-1"></a><span class="fu">write.csv</span>(risk_data_3, <span class="at">file =</span> <span class="st">&quot;Updated 2017-3.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
</div>
<div id="list-of-key-outputs" class="section level3 hasAnchor" number="6.1.7">
<h3><span class="header-section-number">6.1.7</span> List of key outputs<a href="bayesian-updating-spatial-temporal-modelling.html#list-of-key-outputs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>The regression results with baseline and updated relative risks stored in 3 separate tables in following files:</li>
</ol>
<ul>
<li>January (Baseline): <code>Baseline_Result_January_2017.csv</code></li>
<li>April (Updated): <code>Updated_Result_April_2017.csv</code></li>
<li>July (Updated): <code>Updated_Result_July_2017.csv</code></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>3 maps that show relative risks and 3 maps that show significant neighbourhoods. See the following files:</li>
</ol>
<ul>
<li>January (Baseline): <code>rr_2017-1.png</code> and <code>sign_2017-1.png</code></li>
<li>April (Updated): <code>rr_2017-2.png</code> and <code>sign_2017-2.png</code></li>
<li>July (Updated): <code>rr_2017-3.png</code> and <code>sign_2017-3.png</code></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>The relative risk and significance categories from baseline and update models stored in 3 separate tables. These are for mapping and charting those risk trajectories. See the following files:</li>
</ol>
<ul>
<li>January (Baseline): <code>Baseline 2017-1.csv</code></li>
<li>April (Updated): <code>Updated 2017-2.csv</code></li>
<li>July (Updated): <code>Updated 2017-3.csv</code></li>
</ul>
<div class="note">
<p><strong>IMPORTANT:</strong> Note that these tables are used to create to risk trajectories shown in Week 9’s lecture on slide 39. The columns <code>NeighNum</code>, <code>Sign_LiraA_2017_1</code>, <code>Sign_LiraA_2017_2</code> and <code>Sign_LiraA_2017_3</code> are arranged in a separate excel spreadsheet and coloured manually in <strong>Blue</strong> for -1 (significantly lower risks), <strong>Grey</strong> for 0 (Not significant) and <strong>Red</strong> for 1 (significantly higher risks).</p>
</div>
</div>
</div>
<div id="finished" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Finished!<a href="bayesian-updating-spatial-temporal-modelling.html#finished" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>And that’s all to it. That’s how we conduct Bayesian inference - I hope you’ve enjoyed learning this subject. Well done for getting through these practicals! We know, they were long and a grueling process - but you have done well to learn this branch of statistics in the <strong>Advanced Topics in Social &amp; Geographic Data Sciences</strong>. As an appreciation, we end with compliments by expression through this iconic scene from one of our all time great anime, <strong>Neon Genesis Evangelion</strong>.</p>
<p><img src="images/general/congratulations-neon-genesis-evangelion.gif" width="75%" style="display: block; margin: auto;" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/UCLPG-MSC-SGDS/GEOG0125/edit/main/Intro_to_Bayesian_Updating_Spatiotemporals.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
