<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science</title>
  <meta name="description" content="5 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="5 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  <meta name="github-repo" content="UCLPG-MSC-SGDS/GEOG0125" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science" />
  
  <meta name="twitter:description" content="5 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian-generalised-additive-models-gams.html"/>
<link rel="next" href="bayesian-spatial-modelling-for-areal-data-in-stan.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/vembedr-0.1.5/css/vembedr.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="assets/custom.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo">
<a href="https://www.ucl.ac.uk/module-catalogue/modules/advanced-topics-in-social-and-geographic-data-science-GEOG0125"><img src="images/general/ucl_logo.png">
</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#description"><i class="fa fa-check"></i>Description</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#timetable-and-key-locations"><i class="fa fa-check"></i>Timetable and key locations</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contact-details"><i class="fa fa-check"></i>Contact details</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reading-list.html"><a href="reading-list.html"><i class="fa fa-check"></i>Reading List</a>
<ul>
<li class="chapter" data-level="" data-path="reading-list.html"><a href="reading-list.html#week-1-introduction-to-bayesian-inference"><i class="fa fa-check"></i>Week 1: Introduction to Bayesian Inference</a></li>
<li class="chapter" data-level="" data-path="reading-list.html"><a href="reading-list.html#week-2-bayesian-generalised-linear-models-glms"><i class="fa fa-check"></i>Week 2: Bayesian Generalised Linear Models (GLMs)</a></li>
<li class="chapter" data-level="" data-path="reading-list.html"><a href="reading-list.html#week-3-bayesian-generalised-additive-models-gams"><i class="fa fa-check"></i>Week 3: Bayesian Generalised Additive Models (GAMs)</a></li>
<li class="chapter" data-level="" data-path="reading-list.html"><a href="reading-list.html#week-7-bayesian-hierarchical-regression-models"><i class="fa fa-check"></i>Week 7: Bayesian Hierarchical Regression Models</a></li>
<li class="chapter" data-level="" data-path="reading-list.html"><a href="reading-list.html#week-8-spatial-intrinsic-conditional-autoregressive-modelling-icar"><i class="fa fa-check"></i>Week 8: Spatial Intrinsic Conditional Autoregressive Modelling (ICAR)</a></li>
<li class="chapter" data-level="" data-path="reading-list.html"><a href="reading-list.html#week-9-bayesian-updating-for-spatiotemporal-areal-analysis"><i class="fa fa-check"></i>Week 9: Bayesian Updating for Spatiotemporal Areal Analysis</a></li>
<li class="chapter" data-level="" data-path="reading-list.html"><a href="reading-list.html#excellent-incredibly-useful-tutorial-videos-for-learning-stan-code"><i class="fa fa-check"></i>Excellent &amp; Incredibly Useful Tutorial Videos for Learning Stan Code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>1</b> Getting started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="getting-started.html"><a href="getting-started.html#what-is-stan"><i class="fa fa-check"></i><b>1.1</b> What is Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="getting-started.html"><a href="getting-started.html#installation-of-r-rstudio"><i class="fa fa-check"></i><b>1.2</b> Installation of R &amp; RStudio</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="getting-started.html"><a href="getting-started.html#installation-process-for-mac-users"><i class="fa fa-check"></i><b>1.2.1</b> Installation process for MAC users</a></li>
<li class="chapter" data-level="1.2.2" data-path="getting-started.html"><a href="getting-started.html#installation-process-for-windows-users"><i class="fa fa-check"></i><b>1.2.2</b> Installation process for Windows users</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="getting-started.html"><a href="getting-started.html#installation-of-rstan-or-stan"><i class="fa fa-check"></i><b>1.3</b> Installation of <code>rstan</code> (or Stan)</a></li>
<li class="chapter" data-level="1.4" data-path="getting-started.html"><a href="getting-started.html#installation-of-other-relevant-r-packages"><i class="fa fa-check"></i><b>1.4</b> Installation of other relevant R-packages</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html"><i class="fa fa-check"></i><b>2</b> Introduction to Bayesian Statistics</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#lecture-recording-length-5950-minutes"><i class="fa fa-check"></i><b>2.1</b> Lecture recording (Length: 59:50 minutes)</a></li>
<li class="chapter" data-level="2.2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#introduction"><i class="fa fa-check"></i><b>2.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#learning-outcomes"><i class="fa fa-check"></i><b>2.2.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#demonstration-recording-length-3823-minutes"><i class="fa fa-check"></i><b>2.2.2</b> Demonstration recording (Length: 38:23 minutes)</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#datasets-setting-up-the-work-directory"><i class="fa fa-check"></i><b>2.2.3</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="2.2.4" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#loading-and-installing-packages"><i class="fa fa-check"></i><b>2.2.4</b> Loading and installing packages</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-i-about-stan-programming"><i class="fa fa-check"></i><b>2.3</b> Basic building blocks I: About Stan Programming</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#opening-a-stan-script-in-rstudio"><i class="fa fa-check"></i><b>2.3.1</b> Opening a Stan Script in RStudio</a></li>
<li class="chapter" data-level="2.3.2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-structure-of-a-stan-script-in-rstudio"><i class="fa fa-check"></i><b>2.3.2</b> Basic structure of a Stan script in RStudio</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-ii-data-types-and-constraint-declarations"><i class="fa fa-check"></i><b>2.4</b> Basic building blocks II: Data types and constraint declarations</a></li>
<li class="chapter" data-level="2.5" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-iii-developing-our-model"><i class="fa fa-check"></i><b>2.5</b> Basic building blocks III: Developing our model</a></li>
<li class="chapter" data-level="2.6" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-iv-compiling-our-stan-code-in-rstudio"><i class="fa fa-check"></i><b>2.6</b> Basic building blocks IV: Compiling our Stan code in RStudio</a></li>
<li class="chapter" data-level="2.7" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-v-extract-posterior-samples-and-interpretation"><i class="fa fa-check"></i><b>2.7</b> Basic building blocks V: Extract posterior samples and interpretation</a></li>
<li class="chapter" data-level="2.8" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-vi-updating-our-prediction-with-new-information"><i class="fa fa-check"></i><b>2.8</b> Basic building blocks VI: Updating our prediction with new information</a></li>
<li class="chapter" data-level="2.9" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#tasks"><i class="fa fa-check"></i><b>2.9</b> Tasks</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#task-1---low-level-arsenic-poisoning-in-cornwall-uk"><i class="fa fa-check"></i><b>2.9.1</b> Task 1 - Low-level arsenic poisoning in Cornwall, UK</a></li>
<li class="chapter" data-level="2.9.2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#task-2---body-mass-index-bmi-problem"><i class="fa fa-check"></i><b>2.9.2</b> Task 2 - Body mass index (BMI) problem</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html"><i class="fa fa-check"></i><b>3</b> Bayesian Generalised Linear Models (GLMs)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#lecture-recording-length-4546-minutes"><i class="fa fa-check"></i><b>3.1</b> Lecture recording (Length: 45:46 minutes)</a></li>
<li class="chapter" data-level="3.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#introduction-1"><i class="fa fa-check"></i><b>3.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#learning-outcomes-1"><i class="fa fa-check"></i><b>3.2.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="3.2.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#demonstration-recording-length-5252-minutes"><i class="fa fa-check"></i><b>3.2.2</b> Demonstration recording (Length: 52:52 minutes)</a></li>
<li class="chapter" data-level="3.2.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#datasets-setting-up-the-work-directory-1"><i class="fa fa-check"></i><b>3.2.3</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="3.2.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#loading-and-installing-packages-1"><i class="fa fa-check"></i><b>3.2.4</b> Loading and installing packages</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#poisson-regression-modelling"><i class="fa fa-check"></i><b>3.3</b> Poisson Regression Modelling</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#selecting-the-appropriate-poisson-model"><i class="fa fa-check"></i><b>3.3.1</b> Selecting the appropriate Poisson model</a></li>
<li class="chapter" data-level="3.3.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan"><i class="fa fa-check"></i><b>3.3.2</b> Data preparation and set-up for Bayesian analysis in Stan</a></li>
<li class="chapter" data-level="3.3.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#creating-a-script-to-run-a-negative-binomial-poisson-regression-in-stan"><i class="fa fa-check"></i><b>3.3.3</b> Creating a script to run a Negative Binomial Poisson regression in Stan</a></li>
<li class="chapter" data-level="3.3.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#compiling-our-stan-code-in-rstudio"><i class="fa fa-check"></i><b>3.3.4</b> Compiling our Stan code in RStudio</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#logistic-regression-modelling"><i class="fa fa-check"></i><b>3.4</b> Logistic Regression Modelling</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan-1"><i class="fa fa-check"></i><b>3.4.1</b> Data preparation and set-up for Bayesian analysis in Stan</a></li>
<li class="chapter" data-level="3.4.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#creating-a-script-to-run-a-logistic-regression-in-stan"><i class="fa fa-check"></i><b>3.4.2</b> Creating a script to run a logistic regression in Stan</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#tasks-1"><i class="fa fa-check"></i><b>3.5</b> Tasks</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#task-1---obesity-and-fastfoods-in-london"><i class="fa fa-check"></i><b>3.5.1</b> Task 1 - Obesity and Fastfoods in London</a></li>
<li class="chapter" data-level="3.5.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#task-2---factors-affecting-house-prices-in-london-2015"><i class="fa fa-check"></i><b>3.5.2</b> Task 2 - Factors affecting house prices in London (2015)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html"><i class="fa fa-check"></i><b>4</b> Bayesian Generalised Additive Models (GAMs)</a>
<ul>
<li class="chapter" data-level="4.1" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#lecture-recording-length-3812-minutes"><i class="fa fa-check"></i><b>4.1</b> Lecture recording (Length: 38:12 minutes)</a></li>
<li class="chapter" data-level="4.2" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#introduction-2"><i class="fa fa-check"></i><b>4.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#datasets-setting-up-the-work-directory-2"><i class="fa fa-check"></i><b>4.2.1</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="4.2.2" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#loading-and-installing-packages-2"><i class="fa fa-check"></i><b>4.2.2</b> Loading and installing packages</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#implementing-a-bayesian-generalised-additive-model"><i class="fa fa-check"></i><b>4.3</b> Implementing a Bayesian Generalised Additive Model</a></li>
<li class="chapter" data-level="4.4" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#printing-stan-code-from-brmsstancode"><i class="fa fa-check"></i><b>4.4</b> Printing Stan code from <code>brms::stancode()</code></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html"><i class="fa fa-check"></i><b>5</b> Bayesian Hierarchical Regression Models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#lecture-recording-length-4825-minutes"><i class="fa fa-check"></i><b>5.1</b> Lecture recording (Length: 48:25 minutes)</a></li>
<li class="chapter" data-level="5.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#introduction-3"><i class="fa fa-check"></i><b>5.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#datasets-setting-up-the-work-directory-3"><i class="fa fa-check"></i><b>5.2.1</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="5.2.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#loading-packages"><i class="fa fa-check"></i><b>5.2.2</b> Loading packages</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan-2"><i class="fa fa-check"></i><b>5.3</b> Data preparation and set-up for Bayesian analysis in Stan</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#creating-a-script-to-run-a-2-level-multilevel-linear-regression-in-stan"><i class="fa fa-check"></i><b>5.3.1</b> Creating a script to run a 2-level Multilevel linear regression in Stan</a></li>
<li class="chapter" data-level="5.3.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#compiling-our-stan-code-for-hierarchical-modelling"><i class="fa fa-check"></i><b>5.3.2</b> Compiling our Stan code for Hierarchical Modelling</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#task"><i class="fa fa-check"></i><b>5.4</b> Task</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html"><i class="fa fa-check"></i><b>6</b> Bayesian Spatial Modelling for Areal Data in Stan</a>
<ul>
<li class="chapter" data-level="6.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#lecture-recording-length-4058-minutes"><i class="fa fa-check"></i><b>6.1</b> Lecture recording (Length: 40:58 minutes)</a></li>
<li class="chapter" data-level="6.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#introduction-4"><i class="fa fa-check"></i><b>6.2</b> Introduction</a></li>
<li class="chapter" data-level="6.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#learning-outcomes-2"><i class="fa fa-check"></i><b>6.3</b> Learning outcomes</a></li>
<li class="chapter" data-level="6.4" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#demonstration-recording-length-5146-minutes"><i class="fa fa-check"></i><b>6.4</b> Demonstration recording (Length: 51:46 minutes)</a></li>
<li class="chapter" data-level="6.5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#before-we-start"><i class="fa fa-check"></i><b>6.5</b> Before we start…</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#loading-and-installing-packages-3"><i class="fa fa-check"></i><b>6.5.1</b> Loading and installing packages</a></li>
<li class="chapter" data-level="6.5.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#datasets-setting-up-the-work-directory-4"><i class="fa fa-check"></i><b>6.5.2</b> Datasets &amp; setting up the work directory</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#data-preparation-in-rstudio"><i class="fa fa-check"></i><b>6.6</b> Data preparation in RStudio</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#calculation-for-expected-numbers"><i class="fa fa-check"></i><b>6.6.1</b> Calculation for expected numbers</a></li>
<li class="chapter" data-level="6.6.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#converting-the-spatial-adjacency-matrix-to-nodes-edges"><i class="fa fa-check"></i><b>6.6.2</b> Converting the spatial adjacency matrix to nodes &amp; edges</a></li>
<li class="chapter" data-level="6.6.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#create-the-dataset-to-be-compiled-in-stan"><i class="fa fa-check"></i><b>6.6.3</b> Create the dataset to be compiled in Stan</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#creating-the-script-for-the-spatial-icar-smoothed-model"><i class="fa fa-check"></i><b>6.7</b> Creating the script for the Spatial ICAR smoothed model</a>
<ul>
<li class="chapter" data-level="6.7.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#defining-the-icar-component-of-the-spatial-model"><i class="fa fa-check"></i><b>6.7.1</b> Defining the ICAR component of the Spatial model</a></li>
<li class="chapter" data-level="6.7.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#adding-the-blocks-in-our-icar-stan-script"><i class="fa fa-check"></i><b>6.7.2</b> Adding the blocks in our ICAR Stan script</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#compiling-stan-code-for-spatial-icar-modelling"><i class="fa fa-check"></i><b>6.8</b> Compiling Stan code for Spatial ICAR modelling</a>
<ul>
<li class="chapter" data-level="6.8.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#printing-of-the-global-results"><i class="fa fa-check"></i><b>6.8.1</b> Printing of the global results</a></li>
<li class="chapter" data-level="6.8.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#rapid-diagnostics-of-the-rhats"><i class="fa fa-check"></i><b>6.8.2</b> Rapid diagnostics of the rHATs</a></li>
<li class="chapter" data-level="6.8.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#extraction-of-the-area-specific-relative-risks"><i class="fa fa-check"></i><b>6.8.3</b> Extraction of the area-specific relative risks</a></li>
<li class="chapter" data-level="6.8.4" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#mapping-of-rr-and-significance"><i class="fa fa-check"></i><b>6.8.4</b> Mapping of RR and significance</a></li>
<li class="chapter" data-level="6.8.5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#extracting-and-mapping-of-the-exceedance-probabilities"><i class="fa fa-check"></i><b>6.8.5</b> Extracting and mapping of the exceedance probabilities</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#task-1"><i class="fa fa-check"></i><b>6.9</b> Task</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="research-methods-study-design-and-revision.html"><a href="research-methods-study-design-and-revision.html"><i class="fa fa-check"></i><b>7</b> Research Methods, Study Design and Revision</a>
<ul>
<li class="chapter" data-level="7.1" data-path="research-methods-study-design-and-revision.html"><a href="research-methods-study-design-and-revision.html#lecture-length-5103-minutes"><i class="fa fa-check"></i><b>7.1</b> Lecture (Length: 51:03 minutes)</a></li>
<li class="chapter" data-level="7.2" data-path="research-methods-study-design-and-revision.html"><a href="research-methods-study-design-and-revision.html#revision-length-1756-minutes"><i class="fa fa-check"></i><b>7.2</b> Revision (Length: 17:56 minutes)</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">GEOG0125: Advanced Topics in Social Geographic Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="bayesian-hierarchical-regression-models" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">5</span> Bayesian Hierarchical Regression Models<a href="bayesian-hierarchical-regression-models.html#bayesian-hierarchical-regression-models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="lecture-recording-length-4825-minutes" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Lecture recording (Length: 48:25 minutes)<a href="bayesian-hierarchical-regression-models.html#lecture-recording-length-4825-minutes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="vembedr" align="center">
<div>
<iframe src="https://web.microsoftstream.com/embed/video/6d37ef45-05fb-4fce-a847-ffd3e84c5546?autoplay=false&amp;showinfo=true" width="711" height="400" style="border:none;" data-external="1"></iframe>
</div>
</div>
<div class="note">
<p><strong>Important Notes:</strong> If this or any subsequent video don’t play from this website, then try playing it directly from Microsoft Streams - you should be able to view it by clicking this <a href="https://web.microsoftstream.com/video/6d37ef45-05fb-4fce-a847-ffd3e84c5546"><strong>[LINK]</strong></a>. Access to Microsoft Steams to these videos will require use of your UCL institutional login details.</p>
</div>
</div>
<div id="introduction-3" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Introduction<a href="bayesian-hierarchical-regression-models.html#introduction-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This week we will learn how to perform Hierarchical regression modelling within a <strong>Bayesian</strong> framework. These models are useful and much superior to the generic regressions especially if there is an hierarchical structure to the data. This artefact must be taken into account off to ensure statistical robustness. We will focus on implementing 2-level hierarchical regressions with examples on <strong>random-intercept-only</strong> model as these are quite simple to pull off in <strong>Stan</strong>. Let us begin.</p>
<div id="datasets-setting-up-the-work-directory-3" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Datasets &amp; setting up the work directory<a href="bayesian-hierarchical-regression-models.html#datasets-setting-up-the-work-directory-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Go to your folder <strong>GEOG0125</strong> and create a sub folder called “<strong>Week 7</strong>” within the <strong>GEOG0125</strong> folder. Here, we will store all our R &amp; Stan scripts as well as datasets. Set your work directory to <strong>Week 7’s</strong> folder.</p>
<p>For Windows, the code for setting the work directory will be:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="bayesian-hierarchical-regression-models.html#cb77-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/Users/AccountName/Desktop/GEOG0125/Week 7&quot;</span>)</span></code></pre></div>
<p>For MAC, the code for setting the work directory will be:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="bayesian-hierarchical-regression-models.html#cb78-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;/Users/AccountName/Desktop/GEOG0125/Week 7&quot;</span>)</span></code></pre></div>
<p>The dataset for this practical are:</p>
<ul>
<li><code>Maths attainment and activity study.csv</code></li>
<li><code>Pregnancies and hospital data.csv</code></li>
</ul>
<p>The dataset were going to start of with is the <code>Maths attainment and activity study.csv</code>. Let us load this dataset into memory:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="bayesian-hierarchical-regression-models.html#cb79-1" tabindex="-1"></a><span class="co"># load up the data</span></span>
<span id="cb79-2"><a href="bayesian-hierarchical-regression-models.html#cb79-2" tabindex="-1"></a>Maths_dataset <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;`Maths attainment and activity study.csv`&quot;</span>)</span></code></pre></div>
</div>
<div id="loading-packages" class="section level3 hasAnchor" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Loading packages<a href="bayesian-hierarchical-regression-models.html#loading-packages" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We need to load the installed packages including <code>rstan</code> and <code>tidybayes</code>:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="bayesian-hierarchical-regression-models.html#cb80-1" tabindex="-1"></a><span class="co"># load up packages</span></span>
<span id="cb80-2"><a href="bayesian-hierarchical-regression-models.html#cb80-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;rstan&#39;</span>)</span>
<span id="cb80-3"><a href="bayesian-hierarchical-regression-models.html#cb80-3" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;tidybayes&#39;</span>)</span></code></pre></div>
<p>As usual, configure Stan:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="bayesian-hierarchical-regression-models.html#cb81-1" tabindex="-1"></a><span class="co"># configure Stan</span></span>
<span id="cb81-2"><a href="bayesian-hierarchical-regression-models.html#cb81-2" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb81-3"><a href="bayesian-hierarchical-regression-models.html#cb81-3" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
</div>
<div id="data-preparation-and-set-up-for-bayesian-analysis-in-stan-2" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Data preparation and set-up for Bayesian analysis in Stan<a href="bayesian-hierarchical-regression-models.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We are going to fit a 2-level hierarchical model on a continous outcome i.e., <code>MathScore</code> and see how the following independent variables i.e., <code>ActiveTime</code> and <code>Supportive</code> impact it. The <code>Maths_dataset</code> contains a total of 200 students evenly clustered into 4 classrooms <code>ClassroomID</code> (i.e., 50 students in each classroom). The students have a unique student number i.e., <code>StudentID</code> and classroom number the <code>GroupID</code> column.</p>
<p>We want fit an <code>random-intercept-only</code> to explore the difference in the classroom’s performance in maths, as well as how <code>ActiveTime</code> and <code>Supportive</code> impact it. To perform the 2-level hierarchical model, we need to perform the dataset accordingly by extract right information from the <code>Maths_dataset</code> data frame for the Stan script as follows:</p>
<ul>
<li><code>N</code> = total number of students (level 1);</li>
<li><code>CL</code> = maximum number of group (level 2);</li>
<li><code>ClassroomID</code> = the list of all the group numbers that align with the students;</li>
<li><code>k</code> = the total k-number of indepedent variables to be included in the model (k=2) because we want to use <code>ActiveTime</code> and <code>Supportive</code>;</li>
<li><code>MathScore</code> = we want to extract the dependent variable;</li>
<li><code>ActiveTime</code> = we want to extract the first independent variable;</li>
<li><code>Supportive</code> = we want to extract the second independent variable;</li>
</ul>
<p>We can condense this information into list() object in line of code as our dataset for <strong>Stan</strong> to compile:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="bayesian-hierarchical-regression-models.html#cb82-1" tabindex="-1"></a>stan.dataset <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N=</span><span class="fu">nrow</span>(Maths_dataset), </span>
<span id="cb82-2"><a href="bayesian-hierarchical-regression-models.html#cb82-2" tabindex="-1"></a>    <span class="at">CL=</span><span class="fu">max</span>(<span class="fu">unique</span>(Maths_dataset<span class="sc">$</span>GroupID)),</span>
<span id="cb82-3"><a href="bayesian-hierarchical-regression-models.html#cb82-3" tabindex="-1"></a>    <span class="at">ClassroomID=</span><span class="fu">as.integer</span>(Maths_dataset<span class="sc">$</span>GroupID),</span>
<span id="cb82-4"><a href="bayesian-hierarchical-regression-models.html#cb82-4" tabindex="-1"></a>    <span class="at">k=</span><span class="dv">2</span>,</span>
<span id="cb82-5"><a href="bayesian-hierarchical-regression-models.html#cb82-5" tabindex="-1"></a>    <span class="at">MathScore=</span>Maths_dataset<span class="sc">$</span>Math,</span>
<span id="cb82-6"><a href="bayesian-hierarchical-regression-models.html#cb82-6" tabindex="-1"></a>    <span class="at">ActiveTime=</span>Maths_dataset<span class="sc">$</span>ActiveTime,</span>
<span id="cb82-7"><a href="bayesian-hierarchical-regression-models.html#cb82-7" tabindex="-1"></a>    <span class="at">Supportive=</span>Maths_dataset<span class="sc">$</span>Support</span>
<span id="cb82-8"><a href="bayesian-hierarchical-regression-models.html#cb82-8" tabindex="-1"></a>    )</span></code></pre></div>
<p>At this point, the dataset is fully prepared and ready to go. Let’s create our <strong>Stan script</strong> for running a <strong>2-level Multilevel linear regression</strong> within a Bayesian framework.</p>
<div id="creating-a-script-to-run-a-2-level-multilevel-linear-regression-in-stan" class="section level3 hasAnchor" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Creating a script to run a 2-level Multilevel linear regression in Stan<a href="bayesian-hierarchical-regression-models.html#creating-a-script-to-run-a-2-level-multilevel-linear-regression-in-stan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will need <code>Data</code>, <code>Parameters</code> and <code>Model</code> blocks only for this analysis. Recall that the <code>Data</code>, <code>Parameters</code> and <code>Model</code> block <strong>must</strong> be specified for any regression analysis to work.</p>
<p><strong>FIRST STEP:</strong> We specify the total number of observations <code>int N</code> as well as the number of independent variables <code>int k</code> as an integer in the <strong>data</strong> block. We define our <code>MathScore</code> outcome as a <code>vector</code> of size <code>N</code>, and we do the same for the two independent variables <code>ActiveTime</code> and <code>Supportive</code>. We need to specific the number of classrooms for which the students are clustered in through <code>CL</code> and <code>ClassroomID</code>.</p>
<pre class="text"><code>data {
    int&lt;lower = 0&gt; N;       // Number of students
    int&lt;lower = 0&gt; CL;      // Total number of classrooms
    int&lt;lower = 0, upper = CL&gt; ClassroomID[N];    // Aligning the classroom ID number to the student ID
    int&lt;lower = 0&gt; k;                   // Specify total number of independent variables to be used in model
    real&lt;lower = 0&gt; ActiveTime[N];      // First independent variable
    real&lt;lower = 0&gt; Supportive[N];      // Second independent variable
    real&lt;lower = 0&gt; MathScore[N];       // Outcome or dependent variable
}</code></pre>
<p><strong>SECOND STEP:</strong> For the <strong>parameters</strong> block, here we will need to specify the name of the <strong>fixed effect part</strong> of regression i.e., <code>gamma00</code> and the level-1 coefficients <code>beta</code> for our independent variables. We need to also specify the random effect part of the model as well i.e., <code>u0,1 u0,2, u0,3 and u0,4</code> as a vector by linking this to the four number of classes. Finally, we need to specify the <code>sigma_error</code> and <code>group_error</code> as the variance (or residual errors on group- and individual-level) as we must estimate this!</p>
<p>Here is the code:</p>
<pre class="text"><code>data {
    int&lt;lower = 0&gt; N;                             // Number of students
    int&lt;lower = 0&gt; CL;                            // Total number of classrooms
    int&lt;lower = 0, upper = CL&gt; ClassroomID[N];    // Aligning the classroom ID number to the student ID
    int&lt;lower = 0&gt; k;                             // Specify total number of independent variables to be used in model
    real&lt;lower = 0&gt; ActiveTime[N];                // First independent variable
    real&lt;lower = 0&gt; Supportive[N];                // Second independent variable
    real&lt;lower = 0&gt; MathScore[N];                 // Outcome or dependent variable
}

parameters {
    real gamma00;                                 // Declare the fixed part (intercept)
    vector[k] beta;                               // Declare the fixed part (coefficients for ActiveTime and Supportive)
    vector[CL] u;                                 // Declare the random effects u0,1 u0,2, u0,3 and u0,4
    real&lt;lower = 0&gt; sigma_error;                  // Declare the random part (level-1)
    real&lt;lower = 0&gt; group_error;                  // Declare the random part (level-2)
}</code></pre>
<p><strong>THIRD AND LAST STEP:</strong> We build our likelihood function and specify the priors for each parameter under the <strong>model</strong> block. We are using a typical linear model as we are assuming there’s some linear relationship:</p>
<pre class="text"><code>data {
    int&lt;lower = 0&gt; N;                             // Number of students
    int&lt;lower = 0&gt; CL;                            // Total number of classrooms
    int&lt;lower = 0, upper = CL&gt; ClassroomID[N];    // Aligning the classroom ID number to the student ID
    int&lt;lower = 0&gt; k;                             // Specify total number of independent variables to be used in model
    real&lt;lower = 0&gt; ActiveTime[N];                // First independent variable
    real&lt;lower = 0&gt; Supportive[N];                // Second independent variable
    real&lt;lower = 0&gt; MathScore[N];                 // Outcome or dependent variable
}

parameters {
    real gamma00;                                 // Declare the fixed part (intercept)
    vector[k] beta;                               // Declare the fixed part (coefficients for ActiveTime and Supportive)
    vector[CL] u;                                 // Declare the random effects u0,1 u0,2, u0,3 and u0,4
    real&lt;lower = 0&gt; sigma_error;                  // Declare the random part (level-1)
    real&lt;lower = 0&gt; group_error;                  // Declare the random part (level-2)
}

model {
    real mu;
    u ~ normal(0, group_error);
    gamma00 ~ normal(0, 20);
    beta ~ normal(0, 20);
    
    for (i in 1:N) {
        mu = gamma00 + u[ClassroomID[i]] + beta[1]*ActiveTime[i] + beta[2]*Supportive[i];
        MathScore[i] ~ normal(mu, sigma_error);
    }
}</code></pre>
<div class="note">
<p>Let’s save the script as <code>Maths_Activity_study.stan</code>. Now, we can compile and run it through RStudio to get our estimates coefficients and random intercept results.</p>
</div>
</div>
<div id="compiling-our-stan-code-for-hierarchical-modelling" class="section level3 hasAnchor" number="5.3.2">
<h3><span class="header-section-number">5.3.2</span> Compiling our Stan code for Hierarchical Modelling<a href="bayesian-hierarchical-regression-models.html#compiling-our-stan-code-for-hierarchical-modelling" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now, let us turn our attention to RStudio. Using the <code>stan()</code> to compile the save script to obtain the posterior estimation of the parameters in our hierarchical model:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="bayesian-hierarchical-regression-models.html#cb86-1" tabindex="-1"></a><span class="co"># Start the clock</span></span>
<span id="cb86-2"><a href="bayesian-hierarchical-regression-models.html#cb86-2" tabindex="-1"></a>ptm <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb86-3"><a href="bayesian-hierarchical-regression-models.html#cb86-3" tabindex="-1"></a><span class="co"># compile linear regression model for now</span></span>
<span id="cb86-4"><a href="bayesian-hierarchical-regression-models.html#cb86-4" tabindex="-1"></a>bayesian.hierarchical.model <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">&quot;Maths_Activity_study.stan&quot;</span>, <span class="at">data=</span>stan.dataset, <span class="at">iter=</span><span class="dv">10000</span>, <span class="at">chains=</span><span class="dv">6</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-5"><a href="bayesian-hierarchical-regression-models.html#cb86-5" tabindex="-1"></a><span class="co"># Stop the clock</span></span>
<span id="cb86-6"><a href="bayesian-hierarchical-regression-models.html#cb86-6" tabindex="-1"></a><span class="fu">proc.time</span>() <span class="sc">-</span> ptm</span></code></pre></div>
<p><strong>Output summary table</strong></p>
<pre class="text"><code>bayesian.hierarchical.model

Inference for Stan model: anon_model.
6 chains, each with iter=10000; warmup=5000; thin=1; 
post-warmup draws per chain=5000, total post-warmup draws=30000.

               mean se_mean    sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
gamma00       33.24    0.38 24.31  -18.18   16.03   35.80   54.05   68.28  4194    1
beta[1]       11.44    0.01  0.78    9.90   10.92   11.45   11.97   12.98 18542    1
beta[2]        3.18    0.01  0.83    1.57    2.63    3.18    3.75    4.82 18370    1
u[1]          44.92    0.38 24.33    9.76   24.10   42.30   62.08   96.37  4182    1
u[2]          37.23    0.38 24.33    2.07   16.42   34.62   54.48   88.78  4192    1
u[3]          21.59    0.38 24.32  -13.54    0.79   18.96   38.76   73.01  4195    1
u[4]          28.08    0.38 24.32   -7.09    7.28   25.49   45.30   79.49  4190    1
sigma_error    3.34    0.00  0.17    3.03    3.22    3.33    3.45    3.69 17383    1
group_error   56.16    0.73 58.88    8.34   20.69   40.83   71.25  197.13  6566    1
lp__        -353.89    0.02  2.14 -359.01 -355.06 -353.55 -352.34 -350.73  9263    1

Samples were drawn using NUTS(diag_e) at Fri Mar  3 06:03:06 2023.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
<p>Here is the <strong>interpretation</strong>:</p>
<ul>
<li><code>gamma00</code> is the global mean (or average) in the population under study. This means after for accounting for clustering, on average the students’ marks in maths are <strong>33.24 (95% CrI: -18.18 to 68.28)</strong>. Note that the <code>u[1]</code> is the random-effect for the intercept for Class 1, its value is 44.92 (i.e., positive value). By added this to 33.24, we get the intercept that is specific to Class 1. Similarly, for <code>u[2]</code> by adding 37.23 to 33.24, we obtain the intercept this is specific to Class 2, and the rest is so on, and so forth.</li>
<li><code>beta[1]</code> is the level-1 coefficient for <code>ActiveTime</code>. This means after for accounting for clustering, its yields a positive increase on average for maths scores the more time is spent on active learning. This increase is significant since the credibility intervals exclude the null value of zero.</li>
<li><code>beta[2]</code>, in the same vein, the same can be said for amount of one-to-one support a student receives from a teacher.</li>
<li><code>Variances</code> for level-1 and level-2 can used to explain the model’s performance by taking the <code>56.16/(56.16 + 3.34) = 0.943</code>. Here, it’s <code>0.943</code> or <code>94.3%</code>, this quantity is actually known as the <strong>Intraclass Correlation Coefficient (ICC)</strong>. This the proportion of explained variation in the 2-level hierarchical model when accounting for group clustering. Here, the value is quite high and so its a good model. Anything close to 1 (100%) is good and bad vice versa.</li>
</ul>
</div>
</div>
<div id="task" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Task<a href="bayesian-hierarchical-regression-models.html#task" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Try your hand on this problem in Stan</strong>: Build a random intercept logit model using data on 1060 births to 501 mothers. The outcome of interest is whether the <code>birth</code> was delivered in a hospital or elsewhere. The predictors include the log of income <code>loginc</code>, the <code>distance</code> to the nearest hospital distance, and two indicators of mothers’s education: <code>dropout</code> for less than high school and college for college <code>graduate</code>, so high school or some college is the reference cell.</p>
<p>Have ago at building this model.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian-generalised-additive-models-gams.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/UCLPG-MSC-SGDS/GEOG0125/edit/main/Intro_to_Bayesian_Hierarchicals.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
