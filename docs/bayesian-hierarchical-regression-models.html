<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science</title>
  <meta name="description" content="4 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="4 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  <meta name="github-repo" content="UCLPG-MSC-SGDS/GEOG0125" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science" />
  
  <meta name="twitter:description" content="4 Bayesian Hierarchical Regression Models | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian-generalised-linear-models-glms.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/vembedr-0.1.5/css/vembedr.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="assets/custom.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo">
<a href="https://www.ucl.ac.uk/module-catalogue/modules/advanced-topics-in-social-and-geographic-data-science-GEOG0125"><img src="images/general/ucl_logo.png">
</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#description"><i class="fa fa-check"></i>Description</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#timetable-and-key-locations"><i class="fa fa-check"></i>Timetable and key locations</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contact-details"><i class="fa fa-check"></i>Contact details</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html"><i class="fa fa-check"></i>Reading List for GEOG0125</a>
<ul>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-1-introduction-to-bayesian-inference"><i class="fa fa-check"></i>Week 1: Introduction to Bayesian Inference</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-2-bayesian-generalised-linear-models-glms"><i class="fa fa-check"></i>Week 2: Bayesian Generalised Linear Models (GLMs)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-3-bayesian-hierarchical-models"><i class="fa fa-check"></i>Week 3: Bayesian Hierarchical Models</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-4-spatial-risk-models-part-i"><i class="fa fa-check"></i>Week 4: Spatial Risk Models (Part I)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-5-spatiotemproal-risk-models-bayesian-updating-part-ii"><i class="fa fa-check"></i>Week 5: Spatiotemproal Risk Models &amp; Bayesian Updating (Part II)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#an-excellent-incredibly-useful-set-of-tutorial-videos-for-learning-stan-code"><i class="fa fa-check"></i>An Excellent &amp; Incredibly Useful Set of Tutorial Videos for Learning Stan Code</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>1</b> Getting started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="getting-started.html"><a href="getting-started.html#what-is-stan"><i class="fa fa-check"></i><b>1.1</b> What is Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="getting-started.html"><a href="getting-started.html#installation-of-r-rstudio"><i class="fa fa-check"></i><b>1.2</b> Installation of R &amp; RStudio</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="getting-started.html"><a href="getting-started.html#installation-process-for-mac-users"><i class="fa fa-check"></i><b>1.2.1</b> Installation process for MAC users</a></li>
<li class="chapter" data-level="1.2.2" data-path="getting-started.html"><a href="getting-started.html#installation-process-for-windows-users"><i class="fa fa-check"></i><b>1.2.2</b> Installation process for Windows users</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="getting-started.html"><a href="getting-started.html#installation-of-rstan-or-stan"><i class="fa fa-check"></i><b>1.3</b> Installation of <code>rstan</code> (or Stan)</a></li>
<li class="chapter" data-level="1.4" data-path="getting-started.html"><a href="getting-started.html#installation-of-other-relevant-r-packages-needed-in-geog0125"><i class="fa fa-check"></i><b>1.4</b> Installation of other relevant R-packages needed in GEOG0125</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html"><i class="fa fa-check"></i><b>2</b> Introduction to Bayesian Inference</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#lecture-recording-length-10002-minutes"><i class="fa fa-check"></i><b>2.1</b> Lecture recording (Length: 1:00:02 minutes)</a></li>
<li class="chapter" data-level="2.2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#introduction"><i class="fa fa-check"></i><b>2.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#learning-outcomes"><i class="fa fa-check"></i><b>2.2.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#demonstration-recording-length-15950-minutes"><i class="fa fa-check"></i><b>2.2.2</b> Demonstration recording (Length: 1:59:50 minutes)</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#datasets-setting-up-the-work-directory"><i class="fa fa-check"></i><b>2.2.3</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="2.2.4" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#loading-the-appropriate-packages"><i class="fa fa-check"></i><b>2.2.4</b> Loading the appropriate packages</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-i-about-stan-programming"><i class="fa fa-check"></i><b>2.3</b> Basic building blocks I: About Stan Programming</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#opening-a-stan-script-in-rstudio"><i class="fa fa-check"></i><b>2.3.1</b> Opening a Stan Script in RStudio</a></li>
<li class="chapter" data-level="2.3.2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-structure-of-a-stan-script-in-rstudio"><i class="fa fa-check"></i><b>2.3.2</b> Basic structure of a Stan script in RStudio</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-ii-data-types-and-constraint-declarations"><i class="fa fa-check"></i><b>2.4</b> Basic building blocks II: Data types and constraint declarations</a></li>
<li class="chapter" data-level="2.5" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-iii-developing-our-model"><i class="fa fa-check"></i><b>2.5</b> Basic building blocks III: Developing our model</a></li>
<li class="chapter" data-level="2.6" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-iv-compiling-our-stan-code-in-rstudio"><i class="fa fa-check"></i><b>2.6</b> Basic building blocks IV: Compiling our Stan code in RStudio</a></li>
<li class="chapter" data-level="2.7" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-v-extract-posterior-samples-and-interpretation"><i class="fa fa-check"></i><b>2.7</b> Basic building blocks V: Extract posterior samples and interpretation</a></li>
<li class="chapter" data-level="2.8" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#basic-building-blocks-vi-updating-our-prediction-with-new-information"><i class="fa fa-check"></i><b>2.8</b> Basic building blocks VI: Updating our prediction with new information</a></li>
<li class="chapter" data-level="2.9" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#tasks"><i class="fa fa-check"></i><b>2.9</b> Tasks</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#task-1---low-level-arsenic-poisoning-in-cornwall-uk"><i class="fa fa-check"></i><b>2.9.1</b> Task 1 - Low-level arsenic poisoning in Cornwall, UK</a></li>
<li class="chapter" data-level="2.9.2" data-path="introduction-to-bayesian-inference.html"><a href="introduction-to-bayesian-inference.html#task-2---body-mass-index-bmi-problem"><i class="fa fa-check"></i><b>2.9.2</b> Task 2 - Body mass index (BMI) problem</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html"><i class="fa fa-check"></i><b>3</b> Bayesian Generalised Linear Models (GLMs)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#lecture-recording-length-10002-minutes-1"><i class="fa fa-check"></i><b>3.1</b> Lecture recording (Length: 1:00:02 minutes)</a></li>
<li class="chapter" data-level="3.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#introduction-1"><i class="fa fa-check"></i><b>3.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#demonstration-recording-length-15949"><i class="fa fa-check"></i><b>3.2.1</b> Demonstration recording (Length: 1:59:49)</a></li>
<li class="chapter" data-level="3.2.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#datasets-setting-up-the-work-directory-1"><i class="fa fa-check"></i><b>3.2.2</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="3.2.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#loading-and-installing-packages"><i class="fa fa-check"></i><b>3.2.3</b> Loading and installing packages</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#poisson-regression-modelling"><i class="fa fa-check"></i><b>3.3</b> Poisson Regression Modelling</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#selecting-the-appropriate-poisson-model"><i class="fa fa-check"></i><b>3.3.1</b> Selecting the appropriate Poisson model</a></li>
<li class="chapter" data-level="3.3.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan"><i class="fa fa-check"></i><b>3.3.2</b> Data preparation and set-up for Bayesian analysis in Stan</a></li>
<li class="chapter" data-level="3.3.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#creating-a-script-to-run-a-negative-binomial-poisson-regression-in-stan"><i class="fa fa-check"></i><b>3.3.3</b> Creating a script to run a Negative Binomial Poisson regression in Stan</a></li>
<li class="chapter" data-level="3.3.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#compiling-our-stan-code-in-rstudio-and-results"><i class="fa fa-check"></i><b>3.3.4</b> Compiling our Stan code in RStudio and Results</a></li>
<li class="chapter" data-level="3.3.5" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#model-with-categorical-variables"><i class="fa fa-check"></i><b>3.3.5</b> Model with categorical variables</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#tasks-1"><i class="fa fa-check"></i><b>3.4</b> Tasks</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#task-1---obesity-and-fastfoods-in-london"><i class="fa fa-check"></i><b>3.4.1</b> Task 1 - Obesity and Fastfoods in London</a></li>
<li class="chapter" data-level="3.4.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#task-2---factors-affecting-house-prices-in-london-2015"><i class="fa fa-check"></i><b>3.4.2</b> Task 2 - Factors affecting house prices in London (2015)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html"><i class="fa fa-check"></i><b>4</b> Bayesian Hierarchical Regression Models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#lecture-recording-length-10002-minutes-2"><i class="fa fa-check"></i><b>4.1</b> Lecture recording (Length: 1:00:02 minutes)</a></li>
<li class="chapter" data-level="4.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#introduction-2"><i class="fa fa-check"></i><b>4.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#datasets-setting-up-the-work-directory-2"><i class="fa fa-check"></i><b>4.2.1</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="4.2.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#loading-packages"><i class="fa fa-check"></i><b>4.2.2</b> Loading packages</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan-1"><i class="fa fa-check"></i><b>4.3</b> Data preparation and set-up for Bayesian analysis in Stan</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#creating-a-script-to-run-a-2-level-multilevel-linear-regression-in-stan"><i class="fa fa-check"></i><b>4.3.1</b> Creating a script to run a 2-level Multilevel linear regression in Stan</a></li>
<li class="chapter" data-level="4.3.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#compiling-our-stan-code-for-hierarchical-modelling"><i class="fa fa-check"></i><b>4.3.2</b> Compiling our Stan code for Hierarchical Modelling</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#task"><i class="fa fa-check"></i><b>4.4</b> Task</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">GEOG0125: Advanced Topics in Social Geographic Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="bayesian-hierarchical-regression-models" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Bayesian Hierarchical Regression Models<a href="bayesian-hierarchical-regression-models.html#bayesian-hierarchical-regression-models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="lecture-recording-length-10002-minutes-2" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Lecture recording (Length: 1:00:02 minutes)<a href="bayesian-hierarchical-regression-models.html#lecture-recording-length-10002-minutes-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="vembedr" align="center">
<div>
<iframe src="https://www.youtube.com/embed/qMHmGwBFDY8" width="711" height="400" frameborder="0" allowfullscreen="" data-external="1"></iframe>
</div>
</div>
<p><a href="https://youtu.be/qMHmGwBFDY8">[<strong>Watch on YouTube</strong>]</a></p>
</div>
<div id="introduction-2" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Introduction<a href="bayesian-hierarchical-regression-models.html#introduction-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This week we will learn how to perform Hierarchical regression modelling within a <strong>Bayesian</strong> framework. These models are useful and much superior to the generic regressions especially if there is an hierarchical structure to the data. This artefact must be taken into account off to ensure statistical robustness. We will focus on implementing 2-level hierarchical regressions with an example using a model that has a <strong>varying intercept</strong> and <strong>varying-slope coefficients</strong>. These models are quite simple to pull off in <strong>Stan</strong> once you get the gist of it. Alright, let us begin!</p>
<div id="datasets-setting-up-the-work-directory-2" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Datasets &amp; setting up the work directory<a href="bayesian-hierarchical-regression-models.html#datasets-setting-up-the-work-directory-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Go to your folder <strong>GEOG0125</strong> and create a sub folder called “<strong>Week 3</strong>” within the <strong>GEOG0125</strong> folder. Here, we will store all our R &amp; Stan scripts as well as datasets. Set your work directory to <strong>Week 3’s</strong> folder.</p>
<p>For Windows, the code for setting the work directory will be:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="bayesian-hierarchical-regression-models.html#cb55-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/Users/AccountName/Desktop/GEOG0125/Week 3&quot;</span>)</span></code></pre></div>
<p>For MAC, the code for setting the work directory will be:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="bayesian-hierarchical-regression-models.html#cb56-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;/Users/AccountName/Desktop/GEOG0125/Week 3&quot;</span>)</span></code></pre></div>
<p>The main dataset for this practical:</p>
<ul>
<li><code>WHO-AFRO Cholera 2000-17.csv</code></li>
</ul>
<p>The dataset for the task:</p>
<ul>
<li><code>Pregnancies and hospital data.csv</code></li>
</ul>
<p>Let us load this dataset into memory:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="bayesian-hierarchical-regression-models.html#cb57-1" tabindex="-1"></a><span class="co"># load up the data</span></span>
<span id="cb57-2"><a href="bayesian-hierarchical-regression-models.html#cb57-2" tabindex="-1"></a>WHO_AFRO_Cholera <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;WHO-AFRO Cholera 2000-17.csv&quot;</span>)</span></code></pre></div>
</div>
<div id="loading-packages" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Loading packages<a href="bayesian-hierarchical-regression-models.html#loading-packages" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We need to load the installed packages including <code>rstan</code> and <code>tidybayes</code>:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="bayesian-hierarchical-regression-models.html#cb58-1" tabindex="-1"></a><span class="co"># load up packages</span></span>
<span id="cb58-2"><a href="bayesian-hierarchical-regression-models.html#cb58-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;rstan&quot;</span>)</span>
<span id="cb58-3"><a href="bayesian-hierarchical-regression-models.html#cb58-3" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;tidybayes&#39;</span>)</span>
<span id="cb58-4"><a href="bayesian-hierarchical-regression-models.html#cb58-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;tidyverse&#39;</span>)</span></code></pre></div>
<p>Configure Stan:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="bayesian-hierarchical-regression-models.html#cb59-1" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb59-2"><a href="bayesian-hierarchical-regression-models.html#cb59-2" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
</div>
<div id="data-preparation-and-set-up-for-bayesian-analysis-in-stan-1" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Data preparation and set-up for Bayesian analysis in Stan<a href="bayesian-hierarchical-regression-models.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We are going to fit a 2-level Hierarchical regression model on a count outcome i.e., <strong>Cholera</strong> and to see the impact of the following risk factors: coverage of <strong>no basic water services</strong> and <strong>no sanitation services</strong>. The <code>WHO_AFRO_Cholera</code> object contains a total of 13 sub-Saharan African countries who are part of the World Health Organization, whereby each country has <strong>cholera</strong>, <strong>basic water</strong> and <strong>sanitation service</strong> information starting from 2000, and up to 2017, inclusive (i.e., 18 years worth of data). Other independent variables for the countries for each year includes <strong>GDP</strong>, <strong>Temperature</strong> and <strong>Rainfall</strong>.</p>
<p>Note that the yearly data are grouped within the 13 countries <code>country_id</code> or <code>country_name</code>. Within a country, the information has a unique reading captured by the <code>year_id</code>.</p>
<p>We want fit a <strong>2-level negative binomial Poisson regression model</strong> with <code>varying-intercept</code> and <code>varying-slopes</code> on the basic water and sanitation services variables. To explore:</p>
<ol style="list-style-type: decimal">
<li>Global relationships between the increased burden of limited water and basic sanitation services, and risk of cholera, across the WHO-AFRO.</li>
<li>Local relationships between the increased burden of limited water and basic sanitation services, and risk of cholera, within each country.</li>
</ol>
<p>To perform such 2-level hierarchical model, we need to prepare the dataset in RStudio accordingly by extracting the right pieces of information from the <code>WHO_AFRO_Cholera</code> data frame object to be passed to the <strong>data block</strong> in our Stan script.</p>
<p><strong>KEY INGREDIENTS</strong>:</p>
<ul>
<li><code>N</code>: total number of observations/rows in our dataset (234);</li>
<li><code>Country</code>: maximum number of groups formed in the dataset (13 countries);</li>
<li><code>CountryID</code>: this lists all the unique ID numbers for the group i.e., aligns country ID with the observations;</li>
<li><code>Cholera</code>: we want to extract this as a dependent variable and treat as an <code>int</code> because its <strong>counts</strong> measure;</li>
<li><code>Water</code>: we want to extract this as a primary independent variable and treat as an <code>real</code> since its a <strong>continuous</strong> measure;</li>
<li><code>Sanitation</code>: we want to extract the primary independent variable and treat as a <code>real</code> since its a <strong>continuous</strong> measure;</li>
<li><code>GDP</code>: we want to include this as an <strong>apriori</strong> independent variable and treat as an <code>real</code> since its a <strong>continuous</strong> measure;</li>
<li><code>Rainfall</code>: we want to include this as another <strong>apriori</strong> independent variable and treat as an <code>real</code> since its a <strong>continuous</strong> measure;</li>
<li><code>Temperature</code>: we want to include this as another <strong>apriori</strong> independent variable, just like the first two, and treat as an <code>real</code> since its a <strong>continuous</strong> measure;</li>
<li><code>Log_Population</code>: The <code>population</code> column has been log-transformed in the <code>list()</code>. This is going to be treated as an offset <code>real</code> measure;</li>
<li><code>Overdispersion_parameter</code>: We are going to set this at <code>0.4</code>. However, we create a distribution around this value where the degree of over-dispersion can range from <code>0</code> to <code>0.4</code> using a <code>cauchy(0, 0.4)</code>. This means that the counts in cholera can potentially have a shape that is extremely over-dispersed (0) to somewhere that’s mildly over-dispersed patterns (up-to 0.4).</li>
</ul>
<p>We can condense this information into <code>list()</code> object in line of code as our dataset for <strong>Stan</strong> to compile:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="bayesian-hierarchical-regression-models.html#cb60-1" tabindex="-1"></a><span class="co"># create dataset for Stan</span></span>
<span id="cb60-2"><a href="bayesian-hierarchical-regression-models.html#cb60-2" tabindex="-1"></a>stan.cholera.dataset <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb60-3"><a href="bayesian-hierarchical-regression-models.html#cb60-3" tabindex="-1"></a>    <span class="at">N=</span><span class="fu">nrow</span>(WHO_AFRO_Cholera), </span>
<span id="cb60-4"><a href="bayesian-hierarchical-regression-models.html#cb60-4" tabindex="-1"></a>    <span class="at">Country=</span><span class="fu">max</span>(<span class="fu">unique</span>(WHO_AFRO_Cholera<span class="sc">$</span>country_id)),</span>
<span id="cb60-5"><a href="bayesian-hierarchical-regression-models.html#cb60-5" tabindex="-1"></a>    <span class="at">CountryID=</span><span class="fu">as.integer</span>(WHO_AFRO_Cholera<span class="sc">$</span>country_id),</span>
<span id="cb60-6"><a href="bayesian-hierarchical-regression-models.html#cb60-6" tabindex="-1"></a>    <span class="at">Cholera=</span>WHO_AFRO_Cholera<span class="sc">$</span>cholera,</span>
<span id="cb60-7"><a href="bayesian-hierarchical-regression-models.html#cb60-7" tabindex="-1"></a>    <span class="at">Log_Population =</span> <span class="fu">log</span>(WHO_AFRO_Cholera<span class="sc">$</span>population),</span>
<span id="cb60-8"><a href="bayesian-hierarchical-regression-models.html#cb60-8" tabindex="-1"></a>    <span class="at">Water =</span> WHO_AFRO_Cholera<span class="sc">$</span>basic_water,</span>
<span id="cb60-9"><a href="bayesian-hierarchical-regression-models.html#cb60-9" tabindex="-1"></a>    <span class="at">Sanitation =</span> WHO_AFRO_Cholera<span class="sc">$</span>basic_sanitation,</span>
<span id="cb60-10"><a href="bayesian-hierarchical-regression-models.html#cb60-10" tabindex="-1"></a>    <span class="at">GDP =</span> WHO_AFRO_Cholera<span class="sc">$</span>gdp,</span>
<span id="cb60-11"><a href="bayesian-hierarchical-regression-models.html#cb60-11" tabindex="-1"></a>    <span class="at">Rainfall =</span> WHO_AFRO_Cholera<span class="sc">$</span>rainfall,</span>
<span id="cb60-12"><a href="bayesian-hierarchical-regression-models.html#cb60-12" tabindex="-1"></a>    <span class="at">Temperature =</span> WHO_AFRO_Cholera<span class="sc">$</span>temperature,</span>
<span id="cb60-13"><a href="bayesian-hierarchical-regression-models.html#cb60-13" tabindex="-1"></a>    <span class="at">Overdispersion_Parameter =</span> <span class="fl">0.4</span></span>
<span id="cb60-14"><a href="bayesian-hierarchical-regression-models.html#cb60-14" tabindex="-1"></a>)</span></code></pre></div>
<p>At this point, the dataset is now fully prepared and ready to go. Let’s create our <strong>Stan script</strong> for running a <strong>2-level negative binomial Poisson regression</strong> within a Bayesian framework.</p>
<div id="creating-a-script-to-run-a-2-level-multilevel-linear-regression-in-stan" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Creating a script to run a 2-level Multilevel linear regression in Stan<a href="bayesian-hierarchical-regression-models.html#creating-a-script-to-run-a-2-level-multilevel-linear-regression-in-stan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will need <code>data</code>, <code>parameters</code>, <code>transformed parameters</code> and <code>model</code> blocks for this analysis.</p>
<p><strong>FIRST STEP:</strong> In the <code>data</code> block, we can pass the key information from our list object <code>stan.cholera.dataset</code>.</p>
<pre class="text"><code>data {
  int&lt;lower=1&gt; N;                            // Number of observations
  int&lt;lower=1&gt; Country;                      // Number of countries
  int&lt;lower=1, upper=Country&gt; CountryID[N];  // Country IDs 
  int&lt;lower=0&gt; Cholera[N];                   // Cholera cases
  real Water[N];                             // Water access variable
  real Sanitation[N];                        // Sanitation variable
  real GDP[N];                               // GDP variable
    real Rainfall[N];                          // Rainfall variable         
    real Temperature[N];                       // Temperature variable
  real Log_Population[N];                    // Logged Population variable used as offset
  real Overdispersion_Parameter;             // Over-dispersion prior (set to 0.4)
}</code></pre>
<p><strong>SECOND STEP:</strong> For the <strong>parameters</strong> block, here we will need to specify the name of the <strong>fixed effect</strong> of the regression model i.e., <code>gamma00</code>, <code>gamma01</code> and <code>gamma02</code>, which is the overall intercept, and the overall effect (coefficients) of <code>Water</code> and <code>Sanitation</code> on <code>Cholera</code>, respectively. These are operating on the level-1 part of the model. We want the intercept and latter coefficients vary across the countries at level-2; thus, we define <strong>country-specific random effects</strong> from them which is governed by some <strong>standard deviation</strong> i.e., their variation within countries.</p>
<p>Note that the coefficients <code>beta3</code>, <code>beta4</code> and <code>beta5</code> for <code>GDP</code>, <code>Rainfall</code> and <code>Temperature</code> are on level-1.</p>
<p>Lastly, we are defining <code>phi</code> to capture all the possible shapes &amp; ways which the distribution in Cholera can be over-dispersed.</p>
<p>Here is the code:</p>
<pre class="text"><code>data {
  int&lt;lower=1&gt; N;                            // Number of observations
  int&lt;lower=1&gt; Country;                      // Number of countries
  int&lt;lower=1, upper=Country&gt; CountryID[N];  // Country IDs 
  int&lt;lower=0&gt; Cholera[N];                   // Cholera cases
  real Water[N];                             // Water access variable
  real Sanitation[N];                        // Sanitation variable
  real GDP[N];                               // GDP variable
  real Rainfall[N];                          // Rainfall variable         
  real Temperature[N];                       // Temperature variable
  real Log_Population[N];                    // Logged Population variable used as offset
  real Overdispersion_Parameter;             // Over-dispersion set to 0.4 as the initiate value
}

parameters {
  real gamma00;                              // Overall intercept
  real gamma01;                              // Overall effect of Water
  real gamma02;                              // Overall effect of Sanitation
  real beta3;                                // overall fixed effects relationship with GDP
  real beta4;                                // overall fixed effects relationship with rainfall
  real beta5;                                // overall fixed effects relationship with temperature
  real random_intercept[Country];            // Country-specific random intercepts
  real random_slope_water[Country];          // Country-specific random slopes for Water
  real random_slope_sanitation[Country];     // Country-specific random slopes for Sanitation
  real&lt;lower=0&gt; group_intercept_sd;          // SD of random intercepts
  real&lt;lower=0&gt; group_slope_water_sd;        // SD of random slopes for Water
  real&lt;lower=0&gt; group_slope_sanitation_sd;   // SD of random slopes for Sanitation
  real&lt;lower=0&gt; phi;                         // Use phi to create a distribution around the Overdispersion_Parameter</code></pre>
<p><strong>THIRD STEP:</strong> For the <strong>transformed parameters</strong> block, include the sub-equations for <code>beta00</code>, <code>beta01</code> and <code>beta02</code>, where we add the fixed effects and random effects:</p>
<pre class="text"><code>data {
  int&lt;lower=1&gt; N;                            // Number of observations
  int&lt;lower=1&gt; Country;                      // Number of countries
  int&lt;lower=1, upper=Country&gt; CountryID[N];  // Country IDs 
  int&lt;lower=0&gt; Cholera[N];                   // Cholera cases
  real Water[N];                             // Water access variable
  real Sanitation[N];                        // Sanitation variable
  real GDP[N];                               // GDP variable
  real Rainfall[N];                          // Rainfall variable         
  real Temperature[N];                       // Temperature variable
  real Log_Population[N];                    // Logged Population variable used as offset
  real Overdispersion_Parameter;             // Over-dispersion set to 0.4 as the initiate value
}

parameters {
  real gamma00;                              // Overall intercept
  real gamma01;                              // Overall effect of Water
  real gamma02;                              // Overall effect of Sanitation
  real beta3;                                // overall fixed effects relationship with GDP
  real beta4;                                // overall fixed effects relationship with rainfall
  real beta5;                                // overall fixed effects relationship with temperature
  real random_intercept[Country];            // Country-specific random intercepts
  real random_slope_water[Country];          // Country-specific random slopes for Water
  real random_slope_sanitation[Country];     // Country-specific random slopes for Sanitation
  real&lt;lower=0&gt; group_intercept_sd;          // SD of random intercepts
  real&lt;lower=0&gt; group_slope_water_sd;        // SD of random slopes for Water
  real&lt;lower=0&gt; group_slope_sanitation_sd;   // SD of random slopes for Sanitation
  real&lt;lower=0&gt; phi;                         // Use phi to create a distribution around the Overdispersion_Parameter
}
  
transformed parameters {
  real beta00[Country];
  real beta01[Country];
  real beta02[Country];

  for (j in 1:Country) {
    beta00[j] = gamma00 + random_intercept[j];           // Random intercept per country - overall risks of cholera varying by country
    beta01[j] = gamma01 + random_slope_water[j];         // Random slope for Water - overall risks cholera with `Water` varying by country
    beta02[j] = gamma02 + random_slope_sanitation[j];    // Random slope for Sanitation - overall risks cholera with `Sanitation` varying by country
  }
} </code></pre>
<p><strong>FOURTH STEP:</strong> We build our likelihood function and specify the priors for each parameter under the <strong>model</strong> block. This will contain our statistical model.</p>
<pre class="text"><code>data {
  int&lt;lower=1&gt; N;                            // Number of observations
  int&lt;lower=1&gt; Country;                      // Number of countries
  int&lt;lower=1, upper=Country&gt; CountryID[N];  // Country IDs 
  int&lt;lower=0&gt; Cholera[N];                   // Cholera cases
  real Water[N];                             // Water access variable
  real Sanitation[N];                        // Sanitation variable
  real GDP[N];                               // GDP variable
  real Rainfall[N];                          // Rainfall variable         
  real Temperature[N];                       // Temperature variable
  real Log_Population[N];                    // Logged Population variable used as offset
  real Overdispersion_Parameter;             // Over-dispersion set to 0.4 as the initiate value
}

parameters {
  real gamma00;                              // Overall intercept
  real gamma01;                              // Overall effect of Water
  real gamma02;                              // Overall effect of Sanitation
  real beta3;                                // overall fixed effects relationship with GDP
  real beta4;                                // overall fixed effects relationship with rainfall
  real beta5;                                // overall fixed effects relationship with temperature
  real random_intercept[Country];            // Country-specific random intercepts
  real random_slope_water[Country];          // Country-specific random slopes for Water
  real random_slope_sanitation[Country];     // Country-specific random slopes for Sanitation
  real&lt;lower=0&gt; group_intercept_sd;          // SD of random intercepts
  real&lt;lower=0&gt; group_slope_water_sd;        // SD of random slopes for Water
  real&lt;lower=0&gt; group_slope_sanitation_sd;   // SD of random slopes for Sanitation
  real&lt;lower=0&gt; phi;                         // Use phi to create a distribution around the Overdispersion_Parameter
}
  
transformed parameters {
  real beta00[Country];
  real beta01[Country];
  real beta02[Country];

  for (j in 1:Country) {
    beta00[j] = gamma00 + random_intercept[j];           // Random intercept per country - overall risks of cholera varying by country
    beta01[j] = gamma01 + random_slope_water[j];         // Random slope for Water - overall risks cholera with `Water` varying by country
    beta02[j] = gamma02 + random_slope_sanitation[j];    // Random slope for Sanitation - overall risks cholera with `Sanitation` varying by country
  }
}

model {
  // Priors for fixed effects
  gamma00 ~ normal(0, 1);
  gamma01 ~ normal(0, 1);
  gamma02 ~ normal(0, 1);
  beta3 ~ normal(0, 1);
  beta4 ~ normal(0, 1);
  beta5 ~ normal(0, 1);

  // Priors for random effects
  random_intercept ~ normal(0, group_intercept_sd);
  random_slope_water ~ normal(0, group_slope_water_sd);
  random_slope_sanitation ~ normal(0, group_slope_sanitation_sd);
  
  // Priors for standard deviations of random effects
  group_intercept_sd ~ cauchy(0, 0.5);
  group_slope_water_sd ~ cauchy(0, 0.5);
  group_slope_sanitation_sd ~ cauchy(0, 0.5);

  // Prior for overdispersion parameter
  phi ~ cauchy(0, Overdispersion_Parameter);

  // Likelihood: Negative Binomial Poisson Regression
  for (i in 1:N) {
    Cholera[i] ~ neg_binomial_2_log(beta00[CountryID[i]] + beta01[CountryID[i]]*Water[i] + beta02[CountryID[i]]*Sanitation[i] + beta3*GDP[i] + beta4*Rainfall[i] + beta5*Temperature[i] + Log_Population[i], phi);
  }
}</code></pre>
<p><strong>FINAL STEP:</strong> We include <strong>generated quantities</strong> block to derive all results as relative risk ratios.</p>
<pre class="text"><code>data {
  int&lt;lower=1&gt; N;                            // Number of observations
  int&lt;lower=1&gt; Country;                      // Number of countries
  int&lt;lower=1, upper=Country&gt; CountryID[N];  // Country IDs 
  int&lt;lower=0&gt; Cholera[N];                   // Cholera cases
  real Water[N];                             // Water access variable
  real Sanitation[N];                        // Sanitation variable
  real GDP[N];                               // GDP variable
  real Rainfall[N];                          // Rainfall variable         
  real Temperature[N];                       // Temperature variable
  real Log_Population[N];                    // Logged Population variable used as offset
  real Overdispersion_Parameter;             // Over-dispersion set to 0.4 as the initiate value
}

parameters {
  real gamma00;                              // Overall intercept
  real gamma01;                              // Overall effect of Water
  real gamma02;                              // Overall effect of Sanitation
  real beta3;                                // overall fixed effects relationship with GDP
  real beta4;                                // overall fixed effects relationship with rainfall
  real beta5;                                // overall fixed effects relationship with temperature
  real random_intercept[Country];            // Country-specific random intercepts
  real random_slope_water[Country];          // Country-specific random slopes for Water
  real random_slope_sanitation[Country];     // Country-specific random slopes for Sanitation
  real&lt;lower=0&gt; group_intercept_sd;          // SD of random intercepts
  real&lt;lower=0&gt; group_slope_water_sd;        // SD of random slopes for Water
  real&lt;lower=0&gt; group_slope_sanitation_sd;   // SD of random slopes for Sanitation
  real&lt;lower=0&gt; phi;                         // Use phi to create a distribution around the Overdispersion_Parameter
}
  
transformed parameters {
  real beta00[Country];
  real beta01[Country];
  real beta02[Country];

  for (j in 1:Country) {
    beta00[j] = gamma00 + random_intercept[j];           // Random intercept per country - overall risks of cholera varying by country
    beta01[j] = gamma01 + random_slope_water[j];         // Random slope for Water - overall risks cholera with `Water` varying by country
    beta02[j] = gamma02 + random_slope_sanitation[j];    // Random slope for Sanitation - overall risks cholera with `Sanitation` varying by country
  }
}

model {
  // Priors for fixed effects
  gamma00 ~ normal(0, 1);
  gamma01 ~ normal(0, 1);
  gamma02 ~ normal(0, 1);
  beta3 ~ normal(0, 1);
  beta4 ~ normal(0, 1);
  beta5 ~ normal(0, 1);

  // Priors for random effects
  random_intercept ~ normal(0, group_intercept_sd);
  random_slope_water ~ normal(0, group_slope_water_sd);
  random_slope_sanitation ~ normal(0, group_slope_sanitation_sd);
  
  // Priors for standard deviations of random effects
  group_intercept_sd ~ cauchy(0, 0.5);
  group_slope_water_sd ~ cauchy(0, 0.5);
  group_slope_sanitation_sd ~ cauchy(0, 0.5);

  // Prior for overdispersion parameter
  phi ~ cauchy(0, Overdispersion_Parameter);

  // Likelihood: Negative Binomial Poisson Regression
  for (i in 1:N) {
    Cholera[i] ~ neg_binomial_2_log(beta00[CountryID[i]] + beta01[CountryID[i]]*Water[i] + beta02[CountryID[i]]*Sanitation[i] + beta3*GDP[i] + beta4*Rainfall[i] + beta5*Temperature[i] + Log_Population[i], phi);
  }
}

generated quantities {
  // report the coefficients as relative risk ratios
  real gamma00_RR;
  real gamma01_RR;
  real gamma02_RR;
    
  gamma00_RR = exp(gamma00);
  gamma01_RR = exp(gamma01);
  gamma02_RR = exp(gamma02);
    
  real beta3_RR;
  real beta4_RR;
  real beta5_RR;
    
  beta3_RR = exp(beta3);
  beta4_RR = exp(beta4);
  beta5_RR = exp(beta5);
        
  // report the varying slopes as relative risk ratios
  vector[13] beta01_RR;
  beta01_RR[1] = exp(beta01[1]);
  beta01_RR[2] = exp(beta01[2]);
  beta01_RR[3] = exp(beta01[3]);
  beta01_RR[4] = exp(beta01[4]);
  beta01_RR[5] = exp(beta01[5]);
  beta01_RR[6] = exp(beta01[6]);
  beta01_RR[7] = exp(beta01[7]);
  beta01_RR[8] = exp(beta01[8]);
  beta01_RR[9] = exp(beta01[9]);
  beta01_RR[10] = exp(beta01[10]);
  beta01_RR[11] = exp(beta01[11]);
  beta01_RR[12] = exp(beta01[12]);
  beta01_RR[13] = exp(beta01[13]);
    
  vector[13] beta02_RR;
  beta02_RR[1] = exp(beta02[1]);
  beta02_RR[2] = exp(beta02[2]);
  beta02_RR[3] = exp(beta02[3]);
  beta02_RR[4] = exp(beta02[4]);
  beta02_RR[5] = exp(beta02[5]);
  beta02_RR[6] = exp(beta02[6]);
  beta02_RR[7] = exp(beta02[7]);
  beta02_RR[8] = exp(beta02[8]);
  beta02_RR[9] = exp(beta02[9]);
  beta02_RR[10] = exp(beta02[10]);
  beta02_RR[11] = exp(beta02[11]);
  beta02_RR[12] = exp(beta02[12]);
  beta02_RR[13] = exp(beta02[13]);
}
// end script</code></pre>
<div class="note">
<p>Let’s save the script as <code>Cholera Script.stan</code>. Now, we can compile and run it through RStudio to get our estimated coefficients.</p>
</div>
</div>
<div id="compiling-our-stan-code-for-hierarchical-modelling" class="section level3 hasAnchor" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> Compiling our Stan code for Hierarchical Modelling<a href="bayesian-hierarchical-regression-models.html#compiling-our-stan-code-for-hierarchical-modelling" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now, let us turn our attention to RStudio. Using the <code>stan()</code> to compile the save script to obtain the posterior estimation of the parameters in our hierarchical model:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="bayesian-hierarchical-regression-models.html#cb66-1" tabindex="-1"></a><span class="co"># Start the clock</span></span>
<span id="cb66-2"><a href="bayesian-hierarchical-regression-models.html#cb66-2" tabindex="-1"></a>ptm <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb66-3"><a href="bayesian-hierarchical-regression-models.html#cb66-3" tabindex="-1"></a><span class="co"># compile linear regression model for now</span></span>
<span id="cb66-4"><a href="bayesian-hierarchical-regression-models.html#cb66-4" tabindex="-1"></a>bayesian.hierarchical.model <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">&quot;Cholera Script.stan&quot;</span>, <span class="at">data=</span>stan.dataset, <span class="at">iter=</span><span class="dv">30000</span>, <span class="at">chains=</span><span class="dv">6</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb66-5"><a href="bayesian-hierarchical-regression-models.html#cb66-5" tabindex="-1"></a><span class="co"># Stop the clock</span></span>
<span id="cb66-6"><a href="bayesian-hierarchical-regression-models.html#cb66-6" tabindex="-1"></a><span class="fu">proc.time</span>() <span class="sc">-</span> ptm</span></code></pre></div>
<p><strong>Output summary table</strong></p>
<pre class="text"><code># print full table to avoid some rows from being omitted.
options(max.print = 100000)

# print full table to see all results
print(bayesian.hierarchical.model)

Inference for Stan model: anon_model.
6 chains, each with iter=40000; warmup=20000; thin=1; 
post-warmup draws per chain=20000, total post-warmup draws=120000.

                                mean se_mean     sd     2.5%      25%      50%      75%    97.5%  n_eff Rhat
gamma00                        -0.51    0.00   0.95    -2.38    -1.15    -0.51     0.13     1.36  84283    1
gamma01                         0.59    0.00   0.31    -0.08     0.41     0.60     0.79     1.17  43453    1
gamma02                         0.40    0.00   0.42    -0.39     0.13     0.39     0.67     1.28  37440    1
beta3                           0.27    0.00   0.20    -0.15     0.13     0.27     0.40     0.66  30677    1
beta4                          -0.01    0.00   0.01    -0.02    -0.01    -0.01    -0.01     0.00  64690    1
beta5                          -0.30    0.00   0.04    -0.38    -0.33    -0.30    -0.27    -0.22  71062    1
random_intercept[1]            -0.05    0.00   0.34    -0.85    -0.16    -0.01     0.09     0.61  74443    1
random_intercept[2]            -0.02    0.00   0.36    -0.85    -0.14     0.00     0.11     0.72  80797    1
random_intercept[3]             0.10    0.00   0.33    -0.47    -0.05     0.03     0.21     0.92  33448    1
random_intercept[4]             0.05    0.00   0.35    -0.62    -0.08     0.01     0.17     0.88  57712    1
random_intercept[5]             0.06    0.00   0.33    -0.58    -0.08     0.02     0.17     0.83  58872    1
random_intercept[6]            -0.13    0.00   0.37    -1.12    -0.25    -0.04     0.04     0.44  18988    1
random_intercept[7]            -0.01    0.00   0.26    -0.58    -0.12     0.00     0.10     0.56 100566    1
random_intercept[8]            -0.07    0.00   0.28    -0.74    -0.19    -0.03     0.06     0.46  53905    1
random_intercept[9]            -0.06    0.00   0.35    -0.94    -0.17    -0.01     0.08     0.58  49867    1
random_intercept[10]            0.03    0.00   0.35    -0.68    -0.11     0.00     0.14     0.86  48667    1
random_intercept[11]            0.15    0.00   0.39    -0.43    -0.04     0.05     0.26     1.18  17801    1
random_intercept[12]            0.01    0.00   0.27    -0.55    -0.11     0.00     0.12     0.64  52144    1
random_intercept[13]           -0.11    0.00   0.36    -1.05    -0.22    -0.03     0.05     0.47  28024    1
random_slope_water[1]           0.21    0.00   0.57    -0.80    -0.09     0.11     0.47     1.58  46033    1
random_slope_water[2]           0.12    0.00   0.58    -1.01    -0.16     0.05     0.37     1.49  66451    1
random_slope_water[3]           0.16    0.00   0.45    -0.71    -0.08     0.10     0.40     1.15  60113    1
random_slope_water[4]          -0.31    0.00   0.46    -1.37    -0.58    -0.23    -0.01     0.44  23199    1
random_slope_water[5]          -0.07    0.00   0.41    -0.91    -0.30    -0.06     0.12     0.83  50078    1
random_slope_water[6]          -0.06    0.00   0.61    -1.47    -0.31    -0.02     0.22     1.16  86907    1
random_slope_water[7]           0.49    0.01   0.66    -0.41     0.02     0.31     0.83     2.13  14847    1
random_slope_water[8]          -0.11    0.00   0.42    -1.03    -0.33    -0.06     0.11     0.73  53602    1
random_slope_water[9]          -0.23    0.00   0.64    -1.82    -0.50    -0.10     0.10     0.87  34760    1
random_slope_water[10]         -0.58    0.01   0.74    -2.43    -0.96    -0.36    -0.03     0.38  13525    1
random_slope_water[11]          0.17    0.00   0.40    -0.60    -0.05     0.12     0.39     1.06  39671    1
random_slope_water[12]         -0.22    0.00   0.55    -1.55    -0.49    -0.12     0.08     0.75  33295    1
random_slope_water[13]          0.67    0.01   0.79    -0.30     0.06     0.44     1.08     2.63  12709    1
random_slope_sanitation[1]      0.22    0.00   0.67    -1.09    -0.22     0.20     0.65     1.59  51050    1
random_slope_sanitation[2]      0.29    0.00   0.50    -0.74    -0.03     0.30     0.63     1.24  40625    1
random_slope_sanitation[3]      0.43    0.01   1.34    -2.07    -0.41     0.34     1.20     3.35  68110    1
random_slope_sanitation[4]      0.19    0.00   0.73    -1.21    -0.29     0.18     0.67     1.67  44797    1
random_slope_sanitation[5]      2.02    0.01   1.05     0.05     1.29     2.00     2.72     4.16  39402    1
random_slope_sanitation[6]      1.44    0.00   0.77    -0.06     0.93     1.44     1.95     2.95  29308    1
random_slope_sanitation[7]      1.12    0.01   1.36    -1.21     0.17     0.98     1.93     4.16  45410    1
random_slope_sanitation[8]      0.08    0.00   0.83    -1.55    -0.45     0.07     0.61     1.74  60286    1
random_slope_sanitation[9]     -1.14    0.00   0.79    -2.72    -1.66    -1.13    -0.61     0.35  31384    1
random_slope_sanitation[10]    -1.29    0.00   0.74    -2.76    -1.79    -1.29    -0.79     0.13  37763    1
random_slope_sanitation[11]    -1.31    0.00   0.71    -2.76    -1.76    -1.29    -0.83     0.01  31915    1
random_slope_sanitation[12]    -1.01    0.00   0.71    -2.39    -1.48    -1.01    -0.53     0.38  32075    1
random_slope_sanitation[13]    -0.19    0.00   0.64    -1.43    -0.60    -0.19     0.21     1.10  41660    1
group_intercept_sd              0.28    0.00   0.24     0.01     0.11     0.22     0.40     0.90   4267    1
group_slope_water_sd            0.57    0.00   0.40     0.04     0.27     0.50     0.80     1.52   6965    1
group_slope_sanitation_sd       1.33    0.00   0.47     0.54     1.01     1.28     1.59     2.40  24038    1
phi                             0.47    0.00   0.04     0.39     0.44     0.47     0.49     0.55 115310    1
beta00[1]                      -0.56    0.00   1.01    -2.55    -1.23    -0.56     0.12     1.42  85321    1
beta00[2]                      -0.53    0.00   1.01    -2.53    -1.20    -0.53     0.15     1.47  83878    1
beta00[3]                      -0.41    0.00   1.01    -2.37    -1.10    -0.42     0.26     1.61  73970    1
beta00[4]                      -0.46    0.00   1.01    -2.43    -1.14    -0.47     0.22     1.55  80656    1
beta00[5]                      -0.45    0.00   1.01    -2.43    -1.13    -0.46     0.23     1.55  81884    1
beta00[6]                      -0.64    0.00   1.02    -2.67    -1.31    -0.64     0.04     1.32  67097    1
beta00[7]                      -0.52    0.00   0.96    -2.39    -1.17    -0.53     0.12     1.37  82309    1
beta00[8]                      -0.58    0.00   0.99    -2.53    -1.25    -0.58     0.08     1.35  83859    1
beta00[9]                      -0.57    0.00   1.02    -2.58    -1.25    -0.57     0.11     1.40  82345    1
beta00[10]                     -0.48    0.00   1.02    -2.46    -1.17    -0.49     0.19     1.54  78466    1
beta00[11]                     -0.36    0.00   1.03    -2.34    -1.06    -0.38     0.31     1.72  54520    1
beta00[12]                     -0.50    0.00   0.98    -2.40    -1.15    -0.51     0.16     1.43  77158    1
beta00[13]                     -0.62    0.00   1.02    -2.64    -1.29    -0.61     0.06     1.35  77247    1
beta01[1]                       0.80    0.00   0.60    -0.33     0.46     0.75     1.11     2.14  66341    1
beta01[2]                       0.71    0.00   0.62    -0.53     0.37     0.69     1.02     2.06  99751    1
beta01[3]                       0.75    0.00   0.45    -0.16     0.48     0.74     1.01     1.67  61406    1
beta01[4]                       0.28    0.00   0.51    -0.86    -0.03     0.34     0.63     1.13  18242    1
beta01[5]                       0.52    0.00   0.37    -0.24     0.29     0.53     0.75     1.23  76611    1
beta01[6]                       0.53    0.00   0.69    -1.08     0.21     0.58     0.90     1.82  56567    1
beta01[7]                       1.08    0.00   0.62     0.11     0.64     0.97     1.43     2.54  18492    1
beta01[8]                       0.48    0.00   0.42    -0.42     0.23     0.51     0.76     1.28  44546    1
beta01[9]                       0.36    0.00   0.72    -1.41     0.03     0.48     0.80     1.56  27690    1
beta01[10]                      0.01    0.01   0.83    -2.01    -0.43     0.22     0.60     1.15  12887    1
beta01[11]                      0.76    0.00   0.40    -0.03     0.51     0.75     1.01     1.55  38643    1
beta01[12]                      0.37    0.00   0.60    -1.04     0.05     0.45     0.75     1.38  23983    1
beta01[13]                      1.26    0.01   0.77     0.16     0.70     1.08     1.68     3.12  15318    1
beta02[1]                       0.62    0.00   0.58    -0.43     0.23     0.59     0.98     1.85  72873    1
beta02[2]                       0.69    0.00   0.28     0.13     0.52     0.70     0.87     1.22  92463    1
beta02[3]                       0.83    0.01   1.41    -1.74    -0.07     0.74     1.65     3.89  57556    1
beta02[4]                       0.60    0.00   0.66    -0.67     0.16     0.59     1.03     1.93  46463    1
beta02[5]                       2.43    0.01   1.08     0.36     1.68     2.43     3.16     4.58  38407    1
beta02[6]                       1.84    0.00   0.73     0.35     1.38     1.87     2.34     3.20  29212    1
beta02[7]                       1.52    0.01   1.42    -0.92     0.54     1.38     2.38     4.67  43835    1
beta02[8]                       0.49    0.00   0.80    -1.05    -0.04     0.48     1.00     2.10  75280    1
beta02[9]                      -0.74    0.00   0.69    -2.06    -1.20    -0.76    -0.29     0.67  31401    1
beta02[10]                     -0.89    0.00   0.69    -2.20    -1.35    -0.91    -0.45     0.52  40089    1
beta02[11]                     -0.90    0.00   0.58    -2.08    -1.27    -0.89    -0.52     0.22  32598    1
beta02[12]                     -0.60    0.00   0.63    -1.76    -1.03    -0.64    -0.21     0.74  33842    1
beta02[13]                      0.22    0.00   0.55    -0.79    -0.14     0.19     0.55     1.37  46912    1
gamma00_RR                      0.94    0.00   1.16     0.09     0.32     0.60     1.14     3.89  80907    1
gamma01_RR                      1.89    0.00   0.58     0.93     1.50     1.83     2.20     3.22  55395    1
gamma02_RR                      1.64    0.00   0.77     0.67     1.13     1.48     1.95     3.59  33647    1
beta3_RR                        1.33    0.00   0.27     0.86     1.14     1.31     1.50     1.93  33575    1
beta4_RR                        0.99    0.00   0.01     0.98     0.99     0.99     0.99     1.00  64589    1
beta5_RR                        0.74    0.00   0.03     0.68     0.72     0.74     0.76     0.81  70905    1
beta01_RR[1]                    2.73    0.01   2.54     0.72     1.58     2.13     3.04     8.48  46593    1
beta01_RR[2]                    2.51    0.01   2.40     0.59     1.45     1.98     2.78     7.85  53373    1
beta01_RR[3]                    2.34    0.00   1.17     0.86     1.62     2.09     2.76     5.30  61137    1
beta01_RR[4]                    1.49    0.00   0.71     0.42     0.97     1.40     1.88     3.11  23357    1
beta01_RR[5]                    1.79    0.00   0.73     0.79     1.34     1.69     2.11     3.41  65009    1
beta01_RR[6]                    2.12    0.01   1.83     0.34     1.23     1.79     2.47     6.20  77558    1
beta01_RR[7]                    3.70    0.02   3.37     1.12     1.90     2.63     4.18    12.72  23289    1
beta01_RR[8]                    1.77    0.00   0.77     0.66     1.26     1.66     2.13     3.58  62043    1
beta01_RR[9]                    1.79    0.01   1.35     0.24     1.03     1.61     2.22     4.76  65839    1
beta01_RR[10]                   1.32    0.01   0.85     0.13     0.65     1.24     1.83     3.16  17490    1
beta01_RR[11]                   2.31    0.00   0.97     0.97     1.67     2.13     2.73     4.72  43073    1
beta01_RR[12]                   1.69    0.00   0.98     0.35     1.05     1.57     2.11     3.98  49158    1
beta01_RR[13]                   5.13    0.04   7.08     1.18     2.01     2.95     5.38    22.63  28183    1
beta02_RR[1]                    2.23    0.01   1.64     0.65     1.26     1.81     2.67     6.34  63380    1
beta02_RR[2]                    2.07    0.00   0.59     1.14     1.68     2.01     2.39     3.40  92645    1
beta02_RR[3]                   10.26    0.81 242.52     0.17     0.94     2.10     5.19    49.12  90529    1
beta02_RR[4]                    2.28    0.01   1.85     0.51     1.17     1.80     2.79     6.91  59541    1
beta02_RR[5]                   20.58    0.12  31.83     1.43     5.37    11.32    23.65    97.17  65233    1
beta02_RR[6]                    8.14    0.03   6.52     1.42     3.96     6.50    10.33    24.60  55467    1
beta02_RR[7]                   18.49    0.60 164.69     0.40     1.71     3.98    10.83   106.84  74992    1
beta02_RR[8]                    2.27    0.01   2.40     0.35     0.96     1.61     2.72     8.18  62697    1
beta02_RR[9]                    0.61    0.00   0.52     0.13     0.30     0.47     0.75     1.95  28379    1
beta02_RR[10]                   0.53    0.00   0.44     0.11     0.26     0.40     0.64     1.68  30841    1
beta02_RR[11]                   0.48    0.00   0.30     0.13     0.28     0.41     0.59     1.25  20538    1
beta02_RR[12]                   0.68    0.00   0.55     0.17     0.36     0.53     0.81     2.09  29546    1
beta02_RR[13]                   1.47    0.01   1.49     0.45     0.87     1.21     1.73     3.92  47452    1
lp__                        -2046.70    0.30  16.02 -2072.83 -2058.03 -2048.78 -2037.35 -2009.98   2764    1

Samples were drawn using NUTS(diag_e) at Fri Jan 31 04:58:31 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
<p>Dealing with results from <strong>Stan</strong> can be very challenging. Let us show you how to extract the desired results. We will first report the overall relative risks and group variations:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="bayesian-hierarchical-regression-models.html#cb68-1" tabindex="-1"></a><span class="co"># print table to reports the relative risk ratios for Cholera</span></span>
<span id="cb68-2"><a href="bayesian-hierarchical-regression-models.html#cb68-2" tabindex="-1"></a><span class="fu">print</span>(bayesian.hierarchical.model, </span>
<span id="cb68-3"><a href="bayesian-hierarchical-regression-models.html#cb68-3" tabindex="-1"></a>    <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>), </span>
<span id="cb68-4"><a href="bayesian-hierarchical-regression-models.html#cb68-4" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;gamma00_RR&quot;</span>, <span class="st">&quot;gamma01_RR&quot;</span>, <span class="st">&quot;gamma02_RR&quot;</span>, <span class="st">&quot;beta3_RR&quot;</span>, <span class="st">&quot;beta4_RR&quot;</span>, <span class="st">&quot;beta5_RR&quot;</span>,</span>
<span id="cb68-5"><a href="bayesian-hierarchical-regression-models.html#cb68-5" tabindex="-1"></a>        <span class="st">&quot;group_intercept_sd&quot;</span>, <span class="st">&quot;group_slope_water_sd&quot;</span>, <span class="st">&quot;group_slope_sanitation_sd&quot;</span>))</span>
<span id="cb68-6"><a href="bayesian-hierarchical-regression-models.html#cb68-6" tabindex="-1"></a></span>
<span id="cb68-7"><a href="bayesian-hierarchical-regression-models.html#cb68-7" tabindex="-1"></a>Inference <span class="cf">for</span> Stan model<span class="sc">:</span> anon_model.</span>
<span id="cb68-8"><a href="bayesian-hierarchical-regression-models.html#cb68-8" tabindex="-1"></a><span class="dv">6</span> chains, each with iter<span class="ot">=</span><span class="dv">40000</span>; warmup<span class="ot">=</span><span class="dv">20000</span>; thin<span class="ot">=</span><span class="dv">1</span>; </span>
<span id="cb68-9"><a href="bayesian-hierarchical-regression-models.html#cb68-9" tabindex="-1"></a>post<span class="sc">-</span>warmup draws per chain<span class="ot">=</span><span class="dv">20000</span>, total post<span class="sc">-</span>warmup draws<span class="ot">=</span><span class="fl">120000.</span></span>
<span id="cb68-10"><a href="bayesian-hierarchical-regression-models.html#cb68-10" tabindex="-1"></a></span>
<span id="cb68-11"><a href="bayesian-hierarchical-regression-models.html#cb68-11" tabindex="-1"></a>                          mean se_mean   sd <span class="fl">2.5</span><span class="sc">% 97.5%</span> n_eff Rhat</span>
<span id="cb68-12"><a href="bayesian-hierarchical-regression-models.html#cb68-12" tabindex="-1"></a>gamma00_RR                <span class="fl">0.94</span>       <span class="dv">0</span> <span class="fl">1.16</span> <span class="fl">0.09</span>  <span class="fl">3.89</span> <span class="dv">80907</span>    <span class="dv">1</span></span>
<span id="cb68-13"><a href="bayesian-hierarchical-regression-models.html#cb68-13" tabindex="-1"></a>gamma01_RR                <span class="fl">1.89</span>       <span class="dv">0</span> <span class="fl">0.58</span> <span class="fl">0.93</span>  <span class="fl">3.22</span> <span class="dv">55395</span>    <span class="dv">1</span></span>
<span id="cb68-14"><a href="bayesian-hierarchical-regression-models.html#cb68-14" tabindex="-1"></a>gamma02_RR                <span class="fl">1.64</span>       <span class="dv">0</span> <span class="fl">0.77</span> <span class="fl">0.67</span>  <span class="fl">3.59</span> <span class="dv">33647</span>    <span class="dv">1</span></span>
<span id="cb68-15"><a href="bayesian-hierarchical-regression-models.html#cb68-15" tabindex="-1"></a>beta3_RR                  <span class="fl">1.33</span>       <span class="dv">0</span> <span class="fl">0.27</span> <span class="fl">0.86</span>  <span class="fl">1.93</span> <span class="dv">33575</span>    <span class="dv">1</span></span>
<span id="cb68-16"><a href="bayesian-hierarchical-regression-models.html#cb68-16" tabindex="-1"></a>beta4_RR                  <span class="fl">0.99</span>       <span class="dv">0</span> <span class="fl">0.01</span> <span class="fl">0.98</span>  <span class="fl">1.00</span> <span class="dv">64589</span>    <span class="dv">1</span></span>
<span id="cb68-17"><a href="bayesian-hierarchical-regression-models.html#cb68-17" tabindex="-1"></a>beta5_RR                  <span class="fl">0.74</span>       <span class="dv">0</span> <span class="fl">0.03</span> <span class="fl">0.68</span>  <span class="fl">0.81</span> <span class="dv">70905</span>    <span class="dv">1</span></span>
<span id="cb68-18"><a href="bayesian-hierarchical-regression-models.html#cb68-18" tabindex="-1"></a>group_intercept_sd        <span class="fl">0.28</span>       <span class="dv">0</span> <span class="fl">0.24</span> <span class="fl">0.01</span>  <span class="fl">0.90</span>  <span class="dv">4267</span>    <span class="dv">1</span></span>
<span id="cb68-19"><a href="bayesian-hierarchical-regression-models.html#cb68-19" tabindex="-1"></a>group_slope_water_sd      <span class="fl">0.57</span>       <span class="dv">0</span> <span class="fl">0.40</span> <span class="fl">0.04</span>  <span class="fl">1.52</span>  <span class="dv">6965</span>    <span class="dv">1</span></span>
<span id="cb68-20"><a href="bayesian-hierarchical-regression-models.html#cb68-20" tabindex="-1"></a>group_slope_sanitation_sd <span class="fl">1.33</span>       <span class="dv">0</span> <span class="fl">0.47</span> <span class="fl">0.54</span>  <span class="fl">2.40</span> <span class="dv">24038</span>    <span class="dv">1</span></span>
<span id="cb68-21"><a href="bayesian-hierarchical-regression-models.html#cb68-21" tabindex="-1"></a></span>
<span id="cb68-22"><a href="bayesian-hierarchical-regression-models.html#cb68-22" tabindex="-1"></a>Samples were drawn using <span class="fu">NUTS</span>(diag_e) at Fri Jan <span class="dv">31</span> <span class="dv">04</span><span class="sc">:</span><span class="dv">58</span><span class="sc">:</span><span class="dv">31</span> <span class="fl">2025.</span></span>
<span id="cb68-23"><a href="bayesian-hierarchical-regression-models.html#cb68-23" tabindex="-1"></a>For each parameter, n_eff is a crude measure of effective sample size,</span>
<span id="cb68-24"><a href="bayesian-hierarchical-regression-models.html#cb68-24" tabindex="-1"></a>and Rhat is the potential scale reduction factor on split <span class="fu">chains</span> (at </span>
<span id="cb68-25"><a href="bayesian-hierarchical-regression-models.html#cb68-25" tabindex="-1"></a>convergence, <span class="at">Rhat=</span><span class="dv">1</span>).</span></code></pre></div>
<p>Here is the <strong>interpretation</strong>:</p>
<ul>
<li><code>gamma00</code> is the overall baseline risk of cholera in sub-Saharan Africa. It is <strong>0.94 (95% CrI from 0.09 to 3.89)</strong> times lower than usual in the population.</li>
<li><code>gamma01</code> is the overall risk of cholera associated with coverage <strong>without basic water services</strong> in sub-Saharan Africa. The risk of cholera is <strong>1.89 (95% CrI: 0.93 to 3.22)</strong> times higher when coverage without such service gets higher.</li>
<li><code>gamma02</code> is the overall risk of cholera associated with coverage <strong>without basic sanitation services</strong> in sub-Saharan Africa. The risk of cholera is <strong>1.64 (95% CrI: 0.67 to 3.59)</strong> times higher when coverage without such service gets higher.</li>
<li><code>group_intercept_sd</code>: The standard deviation is <strong>0.28</strong> - this is the random intercepts across countries, which suggests that WHO-AFRO countries have somewhat low variability in their baseline cholera rates. This can be interpreted as countries don’t differ drastically in baseline cholera risk (this can be eyeballed from the non-exponentiated values from <code>beta00[1]</code>, <code>beta00[2]</code> to <code>beta00[13]</code>).</li>
<li><code>group_slope_water_sd</code>: The standard deviation is <strong>0.57</strong> - this is the random slope for the water service, which suggests that its effect on cholera risk somewhat varies considerably across the countries and not stable unlike the baseline risk (0.57 vs. 0.28)(- this variation can be eyeballed from the exponentiated values of <code>beta01_RR[1]</code> to <code>beta01_RR[13]</code>).</li>
<li><code>group_slope_santitation_sd</code>: The standard deviation is <strong>1.33</strong> - this is the random slope for the sanitation services, which suggests that its effect on cholera risk substantially varies across the countries, more so than the intercept and water (- this variation can be eyeballed from the exponentiated values of <code>beta02_RR[1]</code> to <code>beta02_RR[13]</code>).</li>
</ul>
<p>This portion of the code computes the exceedance probabilities the overall results above:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="bayesian-hierarchical-regression-models.html#cb69-1" tabindex="-1"></a><span class="co"># This portion of the code computes the exceedance probabilities for the intercept &amp; each beta coefficient</span></span>
<span id="cb69-2"><a href="bayesian-hierarchical-regression-models.html#cb69-2" tabindex="-1"></a>threshold.gamma00_RR <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb69-3"><a href="bayesian-hierarchical-regression-models.html#cb69-3" tabindex="-1"></a>gamma00_RR.exc.probs <span class="ot">&lt;-</span> bayesian.hierarchical.model <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(gamma00_RR) <span class="sc">%&gt;%</span> </span>
<span id="cb69-4"><a href="bayesian-hierarchical-regression-models.html#cb69-4" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">gamma00_RR=</span><span class="fu">threshold.gamma00_RR</span>(gamma00_RR)) <span class="sc">%&gt;%</span></span>
<span id="cb69-5"><a href="bayesian-hierarchical-regression-models.html#cb69-5" tabindex="-1"></a>    <span class="fu">pull</span>(gamma00_RR)</span>
<span id="cb69-6"><a href="bayesian-hierarchical-regression-models.html#cb69-6" tabindex="-1"></a></span>
<span id="cb69-7"><a href="bayesian-hierarchical-regression-models.html#cb69-7" tabindex="-1"></a>threshold.gamma01_RR <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb69-8"><a href="bayesian-hierarchical-regression-models.html#cb69-8" tabindex="-1"></a>gamma01_RR.exc.probs <span class="ot">&lt;-</span> bayesian.hierarchical.model <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(gamma01_RR) <span class="sc">%&gt;%</span> </span>
<span id="cb69-9"><a href="bayesian-hierarchical-regression-models.html#cb69-9" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">gamma01_RR=</span><span class="fu">threshold.gamma01_RR</span>(gamma01_RR)) <span class="sc">%&gt;%</span></span>
<span id="cb69-10"><a href="bayesian-hierarchical-regression-models.html#cb69-10" tabindex="-1"></a>    <span class="fu">pull</span>(gamma01_RR)</span>
<span id="cb69-11"><a href="bayesian-hierarchical-regression-models.html#cb69-11" tabindex="-1"></a></span>
<span id="cb69-12"><a href="bayesian-hierarchical-regression-models.html#cb69-12" tabindex="-1"></a>threshold.gamma02_RR <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb69-13"><a href="bayesian-hierarchical-regression-models.html#cb69-13" tabindex="-1"></a>gamma02_RR.exc.probs <span class="ot">&lt;-</span> bayesian.hierarchical.model <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(gamma02_RR) <span class="sc">%&gt;%</span> </span>
<span id="cb69-14"><a href="bayesian-hierarchical-regression-models.html#cb69-14" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">gamma02_RR=</span><span class="fu">threshold.gamma02_RR</span>(gamma02_RR)) <span class="sc">%&gt;%</span></span>
<span id="cb69-15"><a href="bayesian-hierarchical-regression-models.html#cb69-15" tabindex="-1"></a>    <span class="fu">pull</span>(gamma02_RR)</span>
<span id="cb69-16"><a href="bayesian-hierarchical-regression-models.html#cb69-16" tabindex="-1"></a></span>
<span id="cb69-17"><a href="bayesian-hierarchical-regression-models.html#cb69-17" tabindex="-1"></a>threshold.beta3_RR <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb69-18"><a href="bayesian-hierarchical-regression-models.html#cb69-18" tabindex="-1"></a>beta3_RR.exc.probs <span class="ot">&lt;-</span> bayesian.hierarchical.model <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(beta3_RR) <span class="sc">%&gt;%</span> </span>
<span id="cb69-19"><a href="bayesian-hierarchical-regression-models.html#cb69-19" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">beta3_RR=</span><span class="fu">threshold.beta3_RR</span> (beta3_RR)) <span class="sc">%&gt;%</span></span>
<span id="cb69-20"><a href="bayesian-hierarchical-regression-models.html#cb69-20" tabindex="-1"></a>    <span class="fu">pull</span>(beta3_RR)</span>
<span id="cb69-21"><a href="bayesian-hierarchical-regression-models.html#cb69-21" tabindex="-1"></a></span>
<span id="cb69-22"><a href="bayesian-hierarchical-regression-models.html#cb69-22" tabindex="-1"></a>threshold.beta4_RR <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb69-23"><a href="bayesian-hierarchical-regression-models.html#cb69-23" tabindex="-1"></a>beta4_RR.exc.probs <span class="ot">&lt;-</span> bayesian.hierarchical.model <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(beta4_RR) <span class="sc">%&gt;%</span> </span>
<span id="cb69-24"><a href="bayesian-hierarchical-regression-models.html#cb69-24" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">beta4_RR=</span><span class="fu">threshold.beta4_RR</span>(beta4_RR)) <span class="sc">%&gt;%</span></span>
<span id="cb69-25"><a href="bayesian-hierarchical-regression-models.html#cb69-25" tabindex="-1"></a>    <span class="fu">pull</span>(beta4_RR)</span>
<span id="cb69-26"><a href="bayesian-hierarchical-regression-models.html#cb69-26" tabindex="-1"></a></span>
<span id="cb69-27"><a href="bayesian-hierarchical-regression-models.html#cb69-27" tabindex="-1"></a>threshold.beta5_RR <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb69-28"><a href="bayesian-hierarchical-regression-models.html#cb69-28" tabindex="-1"></a>beta5_RR.exc.probs <span class="ot">&lt;-</span> bayesian.hierarchical.model <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(beta5_RR) <span class="sc">%&gt;%</span> </span>
<span id="cb69-29"><a href="bayesian-hierarchical-regression-models.html#cb69-29" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">beta5_RR=</span><span class="fu">threshold.beta5_RR</span>(beta5_RR)) <span class="sc">%&gt;%</span></span>
<span id="cb69-30"><a href="bayesian-hierarchical-regression-models.html#cb69-30" tabindex="-1"></a>    <span class="fu">pull</span>(beta5_RR)</span>
<span id="cb69-31"><a href="bayesian-hierarchical-regression-models.html#cb69-31" tabindex="-1"></a></span>
<span id="cb69-32"><a href="bayesian-hierarchical-regression-models.html#cb69-32" tabindex="-1"></a><span class="co"># report exceedance probability results</span></span>
<span id="cb69-33"><a href="bayesian-hierarchical-regression-models.html#cb69-33" tabindex="-1"></a>gamma00_RR.exc.probs</span>
<span id="cb69-34"><a href="bayesian-hierarchical-regression-models.html#cb69-34" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.296175</span></span>
<span id="cb69-35"><a href="bayesian-hierarchical-regression-models.html#cb69-35" tabindex="-1"></a>gamma01_RR.exc.probs</span>
<span id="cb69-36"><a href="bayesian-hierarchical-regression-models.html#cb69-36" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.963475</span></span>
<span id="cb69-37"><a href="bayesian-hierarchical-regression-models.html#cb69-37" tabindex="-1"></a>gamma02_RR.exc.probs</span>
<span id="cb69-38"><a href="bayesian-hierarchical-regression-models.html#cb69-38" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.84035</span></span>
<span id="cb69-39"><a href="bayesian-hierarchical-regression-models.html#cb69-39" tabindex="-1"></a>beta3_RR.exc.probs</span>
<span id="cb69-40"><a href="bayesian-hierarchical-regression-models.html#cb69-40" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.9022667</span></span>
<span id="cb69-41"><a href="bayesian-hierarchical-regression-models.html#cb69-41" tabindex="-1"></a>beta4_RR.exc.probs</span>
<span id="cb69-42"><a href="bayesian-hierarchical-regression-models.html#cb69-42" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.06706667</span></span>
<span id="cb69-43"><a href="bayesian-hierarchical-regression-models.html#cb69-43" tabindex="-1"></a>beta5_RR.exc.probs</span>
<span id="cb69-44"><a href="bayesian-hierarchical-regression-models.html#cb69-44" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">0</span></span></code></pre></div>
<p>We have presented the overall results. What about those that vary across countries? Let put everything into a table - here, its just a matter of writing codes to extracting the results and presenting them in a manner to be use in a paper or assignment:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="bayesian-hierarchical-regression-models.html#cb70-1" tabindex="-1"></a><span class="co"># Create a vector of names for the results - for overall, and for those that are country-specific</span></span>
<span id="cb70-2"><a href="bayesian-hierarchical-regression-models.html#cb70-2" tabindex="-1"></a><span class="co"># note: any country with &#39;_w&#39; is specific for water service</span></span>
<span id="cb70-3"><a href="bayesian-hierarchical-regression-models.html#cb70-3" tabindex="-1"></a><span class="co"># note: any country with &#39;_s&#39; is specific for sanitation service</span></span>
<span id="cb70-4"><a href="bayesian-hierarchical-regression-models.html#cb70-4" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;baseline&quot;</span>, <span class="st">&quot;water&quot;</span>, <span class="st">&quot;sanitation&quot;</span>, <span class="st">&quot;gdp&quot;</span>, <span class="st">&quot;rainfall&quot;</span>, <span class="st">&quot;temperature&quot;</span>, <span class="st">&quot;ben_w&quot;</span>, <span class="st">&quot;bur_w&quot;</span>, <span class="st">&quot;drc_w&quot;</span>, <span class="st">&quot;gha_w&quot;</span>, <span class="st">&quot;ivc_w&quot;</span>, <span class="st">&quot;ken_w&quot;</span>,</span>
<span id="cb70-5"><a href="bayesian-hierarchical-regression-models.html#cb70-5" tabindex="-1"></a>    <span class="st">&quot;mal_w&quot;</span>, <span class="st">&quot;moz_w&quot;</span>, <span class="st">&quot;ner_w&quot;</span>, <span class="st">&quot;nir_w&quot;</span>, <span class="st">&quot;som_w&quot;</span>, <span class="st">&quot;tan_w&quot;</span>, <span class="st">&quot;tog_w&quot;</span>, <span class="st">&quot;ben_s&quot;</span>, <span class="st">&quot;bur_s&quot;</span>, <span class="st">&quot;drc_s&quot;</span>, <span class="st">&quot;gha_s&quot;</span>, <span class="st">&quot;ivc_s&quot;</span>, <span class="st">&quot;ken_s&quot;</span>,</span>
<span id="cb70-6"><a href="bayesian-hierarchical-regression-models.html#cb70-6" tabindex="-1"></a>    <span class="st">&quot;mal_s&quot;</span>, <span class="st">&quot;moz_s&quot;</span>, <span class="st">&quot;ner_s&quot;</span>, <span class="st">&quot;nir_s&quot;</span>, <span class="st">&quot;som_s&quot;</span>, <span class="st">&quot;tan_s&quot;</span>, <span class="st">&quot;tog_s&quot;</span>)</span></code></pre></div>
<p>Create a data frame with the desired results:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="bayesian-hierarchical-regression-models.html#cb71-1" tabindex="-1"></a><span class="co"># export selected output as a data frame into &#39;result&#39; object</span></span>
<span id="cb71-2"><a href="bayesian-hierarchical-regression-models.html#cb71-2" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(bayesian.hierarchical.model, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>), <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;gamma00_RR&quot;</span> , <span class="st">&quot;gamma01_RR&quot;</span>, <span class="st">&quot;gamma02_RR&quot;</span>, <span class="st">&quot;beta3_RR&quot;</span>, <span class="st">&quot;beta4_RR&quot;</span>, <span class="st">&quot;beta5_RR&quot;</span>, <span class="st">&quot;beta01_RR&quot;</span>, <span class="st">&quot;beta02_RR&quot;</span>))<span class="sc">$</span>summary)</span></code></pre></div>
<p>Align the <code>names</code> to the results in the <code>results</code> object:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="bayesian-hierarchical-regression-models.html#cb72-1" tabindex="-1"></a>results<span class="sc">$</span>variables <span class="ot">&lt;-</span> names</span>
<span id="cb72-2"><a href="bayesian-hierarchical-regression-models.html#cb72-2" tabindex="-1"></a><span class="fu">row.names</span>(results) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)</span></code></pre></div>
<p>Now, we are cleaning the table up, with appropriate renaming and re-positioning of columns, and rounding the estimates down to 2 decimal places.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="bayesian-hierarchical-regression-models.html#cb73-1" tabindex="-1"></a>results <span class="ot">&lt;-</span> results[,<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>)]</span>
<span id="cb73-2"><a href="bayesian-hierarchical-regression-models.html#cb73-2" tabindex="-1"></a>results<span class="sc">$</span>mean <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>mean, <span class="dv">2</span>)</span>
<span id="cb73-3"><a href="bayesian-hierarchical-regression-models.html#cb73-3" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;RelativeRisks&quot;</span></span>
<span id="cb73-4"><a href="bayesian-hierarchical-regression-models.html#cb73-4" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;lower95&quot;</span></span>
<span id="cb73-5"><a href="bayesian-hierarchical-regression-models.html#cb73-5" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&quot;upper95&quot;</span></span>
<span id="cb73-6"><a href="bayesian-hierarchical-regression-models.html#cb73-6" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ess&quot;</span></span>
<span id="cb73-7"><a href="bayesian-hierarchical-regression-models.html#cb73-7" tabindex="-1"></a><span class="fu">colnames</span>(results)[<span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rhat&quot;</span></span>
<span id="cb73-8"><a href="bayesian-hierarchical-regression-models.html#cb73-8" tabindex="-1"></a>results<span class="sc">$</span>lower95<span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>lower95, <span class="dv">2</span>)</span>
<span id="cb73-9"><a href="bayesian-hierarchical-regression-models.html#cb73-9" tabindex="-1"></a>results<span class="sc">$</span>upper95 <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>upper95, <span class="dv">2</span>)</span>
<span id="cb73-10"><a href="bayesian-hierarchical-regression-models.html#cb73-10" tabindex="-1"></a>results<span class="sc">$</span>ess <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>ess, <span class="dv">0</span>)</span>
<span id="cb73-11"><a href="bayesian-hierarchical-regression-models.html#cb73-11" tabindex="-1"></a>results<span class="sc">$</span>rhat <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>rhat, <span class="dv">2</span>)</span></code></pre></div>
<p>We are going to stitch the exceedance probabilities into this table. Note, we have not calculated the exceedance probabilities for the varying slopes! This portion of the code computes that for you:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="bayesian-hierarchical-regression-models.html#cb74-1" tabindex="-1"></a><span class="co"># This portion of the code computes the exceedance probabilities for the varying slope coefficients for each country</span></span>
<span id="cb74-2"><a href="bayesian-hierarchical-regression-models.html#cb74-2" tabindex="-1"></a>threshold.beta01_RR <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb74-3"><a href="bayesian-hierarchical-regression-models.html#cb74-3" tabindex="-1"></a>beta01_RR.exc.probs <span class="ot">&lt;-</span> bayesian.hierarchical.model <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(beta01_RR[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb74-4"><a href="bayesian-hierarchical-regression-models.html#cb74-4" tabindex="-1"></a>    <span class="fu">group_by</span>(i) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">beta01_RR=</span><span class="fu">threshold.beta01_RR</span>(beta01_RR)) <span class="sc">%&gt;%</span></span>
<span id="cb74-5"><a href="bayesian-hierarchical-regression-models.html#cb74-5" tabindex="-1"></a>    <span class="fu">pull</span>(beta01_RR)</span>
<span id="cb74-6"><a href="bayesian-hierarchical-regression-models.html#cb74-6" tabindex="-1"></a></span>
<span id="cb74-7"><a href="bayesian-hierarchical-regression-models.html#cb74-7" tabindex="-1"></a>threshold.beta02_RR <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb74-8"><a href="bayesian-hierarchical-regression-models.html#cb74-8" tabindex="-1"></a>beta02_RR.exc.probs <span class="ot">&lt;-</span> bayesian.hierarchical.model <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(beta02_RR[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb74-9"><a href="bayesian-hierarchical-regression-models.html#cb74-9" tabindex="-1"></a>    <span class="fu">group_by</span>(i) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">beta02_RR=</span><span class="fu">threshold.beta02_RR</span>(beta02_RR)) <span class="sc">%&gt;%</span></span>
<span id="cb74-10"><a href="bayesian-hierarchical-regression-models.html#cb74-10" tabindex="-1"></a>    <span class="fu">pull</span>(beta02_RR)</span>
<span id="cb74-11"><a href="bayesian-hierarchical-regression-models.html#cb74-11" tabindex="-1"></a></span>
<span id="cb74-12"><a href="bayesian-hierarchical-regression-models.html#cb74-12" tabindex="-1"></a>beta01_RR.exc.probs</span>
<span id="cb74-13"><a href="bayesian-hierarchical-regression-models.html#cb74-13" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.9328583</span> <span class="fl">0.9021333</span> <span class="fl">0.9555667</span> <span class="fl">0.7321000</span> <span class="fl">0.9221833</span> <span class="fl">0.8309167</span> <span class="fl">0.9854167</span> <span class="fl">0.8771083</span> <span class="fl">0.7624833</span> <span class="fl">0.6029917</span> <span class="fl">0.9712000</span> <span class="fl">0.7726417</span> <span class="fl">0.9893000</span></span>
<span id="cb74-14"><a href="bayesian-hierarchical-regression-models.html#cb74-14" tabindex="-1"></a></span>
<span id="cb74-15"><a href="bayesian-hierarchical-regression-models.html#cb74-15" tabindex="-1"></a>beta02_RR.exc.probs</span>
<span id="cb74-16"><a href="bayesian-hierarchical-regression-models.html#cb74-16" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.8711167</span> <span class="fl">0.9891167</span> <span class="fl">0.7319250</span> <span class="fl">0.8213667</span> <span class="fl">0.9921333</span> <span class="fl">0.9918500</span> <span class="fl">0.8769833</span> <span class="fl">0.7330500</span> <span class="fl">0.1448750</span> <span class="fl">0.1002167</span> <span class="fl">0.0541000</span> <span class="fl">0.1655333</span> <span class="fl">0.6480667</span></span></code></pre></div>
<p>We create the table output with final results</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="bayesian-hierarchical-regression-models.html#cb75-1" tabindex="-1"></a>table <span class="ot">&lt;-</span> results</span>
<span id="cb75-2"><a href="bayesian-hierarchical-regression-models.html#cb75-2" tabindex="-1"></a>table<span class="sc">$</span>RR_95CrI <span class="ot">&lt;-</span> <span class="fu">paste</span>(table<span class="sc">$</span>RelativeRisks, <span class="st">&quot; (95% CrI: &quot;</span>, table<span class="sc">$</span>lower95, <span class="st">&quot; to &quot;</span>, table<span class="sc">$</span>upper95, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb75-3"><a href="bayesian-hierarchical-regression-models.html#cb75-3" tabindex="-1"></a>probs <span class="ot">&lt;-</span> <span class="fu">c</span>(gamma00_RR.exc.probs, gamma01_RR.exc.probs, gamma02_RR.exc.probs, beta3_RR.exc.probs, beta4_RR.exc.probs, beta5_RR.exc.probs, beta01_RR.exc.probs, beta01_RR.exc.probs)</span>
<span id="cb75-4"><a href="bayesian-hierarchical-regression-models.html#cb75-4" tabindex="-1"></a>table<span class="sc">$</span>ExceedProbs <span class="ot">&lt;-</span> <span class="fu">round</span>(probs, <span class="dv">2</span>)</span>
<span id="cb75-5"><a href="bayesian-hierarchical-regression-models.html#cb75-5" tabindex="-1"></a>table<span class="sc">$</span>ESS_Rhat <span class="ot">&lt;-</span> <span class="fu">paste</span>(table<span class="sc">$</span>ess, <span class="st">&quot; (Rhat = &quot;</span>, table<span class="sc">$</span>rhat, <span class="st">&quot; &lt; 1.05)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb75-6"><a href="bayesian-hierarchical-regression-models.html#cb75-6" tabindex="-1"></a>finaltable <span class="ot">&lt;-</span> table[,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>)]</span></code></pre></div>
<p>We have the full results in the <code>finaltable</code> object.</p>
<p>Let us use an example for <code>gha_w</code> which refers to the estimate random slope for limited water services and it effect on cholera risk in Ghana. The risk in relation to this variable is <strong>1.49 (95% CrI: 0.42 to 3.11)</strong> times higher. Such chance of risk being greater than 1 in relation to this variable is <strong>0.73 (73%)</strong>. This result; however, is not significant.</p>
</div>
</div>
<div id="task" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> Task<a href="bayesian-hierarchical-regression-models.html#task" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Try your hand on this problem in Stan</strong>: Build a random intercept logit model using data on 1060 births to 501 mothers. The outcome of interest is whether the <code>birth</code> was delivered in a hospital or elsewhere. The predictors include the log of income <code>loginc</code>, the <code>distance</code> to the nearest hospital distance, and two indicators of mothers’s education: <code>dropout</code> for less than high school and college for college <code>graduate</code>, so high school or some college is the reference cell.</p>
<p>Have ago at building this model.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian-generalised-linear-models-glms.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/UCLPG-MSC-SGDS/GEOG0125/edit/main/Intro_to_Bayesian_Hierarchicals.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
