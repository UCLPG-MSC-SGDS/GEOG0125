<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Bayesian Spatial Modelling for Areal Data in Stan | GEOG0125: Advanced Topics in Social Geographic Data Science</title>
  <meta name="description" content="6 Bayesian Spatial Modelling for Areal Data in Stan | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Bayesian Spatial Modelling for Areal Data in Stan | GEOG0125: Advanced Topics in Social Geographic Data Science" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="6 Bayesian Spatial Modelling for Areal Data in Stan | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  <meta name="github-repo" content="UCLPG-MSC-SGDS/GEOG0125" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Bayesian Spatial Modelling for Areal Data in Stan | GEOG0125: Advanced Topics in Social Geographic Data Science" />
  
  <meta name="twitter:description" content="6 Bayesian Spatial Modelling for Areal Data in Stan | GEOG0125: Advanced Topics in Social Geographic Data Science Handbook" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian-hierarchical-regression-models.html"/>
<link rel="next" href="bayesian-updating-spatial-temporal-modelling.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/vembedr-0.1.5/css/vembedr.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="assets/custom.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo">
<a href="https://www.ucl.ac.uk/module-catalogue/modules/advanced-topics-in-social-and-geographic-data-science-GEOG0125"><img src="images/general/ucl_logo.png">
</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#description"><i class="fa fa-check"></i>Description</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#timetable-and-key-locations"><i class="fa fa-check"></i>Timetable and key locations</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contact-details"><i class="fa fa-check"></i>Contact details</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html"><i class="fa fa-check"></i>Reading List for GEOG0125</a>
<ul>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-1-introduction-to-bayesian-inference"><i class="fa fa-check"></i>Week 1: Introduction to Bayesian Inference</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-2-bayesian-generalised-linear-models-glms"><i class="fa fa-check"></i>Week 2: Bayesian Generalised Linear Models (GLMs)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-3-bayesian-hierarchical-models"><i class="fa fa-check"></i>Week 3: Bayesian Hierarchical Models</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-4-spatial-risk-models-part-i"><i class="fa fa-check"></i>Week 4: Spatial Risk Models (Part I)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#week-5-spatiotemproal-risk-models-bayesian-updating-part-ii"><i class="fa fa-check"></i>Week 5: Spatiotemproal Risk Models &amp; Bayesian Updating (Part II)</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#an-excellent-incredibly-useful-set-of-tutorial-videos-for-learning-stan-code"><i class="fa fa-check"></i>An Excellent &amp; Incredibly Useful Set of Tutorial Videos for Learning Stan Code</a></li>
<li class="chapter" data-level="" data-path="reading-list-for-geog0125.html"><a href="reading-list-for-geog0125.html#day-summer-workshop-introduction-to-bayesian-inference-and-modelling-202223"><i class="fa fa-check"></i>4-Day Summer Workshop: Introduction to Bayesian Inference and Modelling [2022/23]</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>1</b> Getting started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="getting-started.html"><a href="getting-started.html#what-is-stan"><i class="fa fa-check"></i><b>1.1</b> What is Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="getting-started.html"><a href="getting-started.html#installation-of-r-rstudio"><i class="fa fa-check"></i><b>1.2</b> Installation of R &amp; RStudio</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="getting-started.html"><a href="getting-started.html#installation-process-for-mac-users"><i class="fa fa-check"></i><b>1.2.1</b> Installation process for MAC users</a></li>
<li class="chapter" data-level="1.2.2" data-path="getting-started.html"><a href="getting-started.html#installation-process-for-windows-users"><i class="fa fa-check"></i><b>1.2.2</b> Installation process for Windows users</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="getting-started.html"><a href="getting-started.html#installation-of-rstan-or-stan"><i class="fa fa-check"></i><b>1.3</b> Installation of <code>rstan</code> (or Stan)</a></li>
<li class="chapter" data-level="1.4" data-path="getting-started.html"><a href="getting-started.html#installation-of-other-relevant-r-packages"><i class="fa fa-check"></i><b>1.4</b> Installation of other relevant R-packages</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html"><i class="fa fa-check"></i><b>2</b> Introduction to Bayesian Statistics</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#lecture-recording-length-5950-minutes"><i class="fa fa-check"></i><b>2.1</b> Lecture recording (Length: 59:50 minutes)</a></li>
<li class="chapter" data-level="2.2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#introduction"><i class="fa fa-check"></i><b>2.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#learning-outcomes"><i class="fa fa-check"></i><b>2.2.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#demonstration-recording-length-3823-minutes"><i class="fa fa-check"></i><b>2.2.2</b> Demonstration recording (Length: 38:23 minutes)</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#datasets-setting-up-the-work-directory"><i class="fa fa-check"></i><b>2.2.3</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="2.2.4" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#loading-and-installing-packages"><i class="fa fa-check"></i><b>2.2.4</b> Loading and installing packages</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-i-about-stan-programming"><i class="fa fa-check"></i><b>2.3</b> Basic building blocks I: About Stan Programming</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#opening-a-stan-script-in-rstudio"><i class="fa fa-check"></i><b>2.3.1</b> Opening a Stan Script in RStudio</a></li>
<li class="chapter" data-level="2.3.2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-structure-of-a-stan-script-in-rstudio"><i class="fa fa-check"></i><b>2.3.2</b> Basic structure of a Stan script in RStudio</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-ii-data-types-and-constraint-declarations"><i class="fa fa-check"></i><b>2.4</b> Basic building blocks II: Data types and constraint declarations</a></li>
<li class="chapter" data-level="2.5" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-iii-developing-our-model"><i class="fa fa-check"></i><b>2.5</b> Basic building blocks III: Developing our model</a></li>
<li class="chapter" data-level="2.6" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-iv-compiling-our-stan-code-in-rstudio"><i class="fa fa-check"></i><b>2.6</b> Basic building blocks IV: Compiling our Stan code in RStudio</a></li>
<li class="chapter" data-level="2.7" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-v-extract-posterior-samples-and-interpretation"><i class="fa fa-check"></i><b>2.7</b> Basic building blocks V: Extract posterior samples and interpretation</a></li>
<li class="chapter" data-level="2.8" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#basic-building-blocks-vi-updating-our-prediction-with-new-information"><i class="fa fa-check"></i><b>2.8</b> Basic building blocks VI: Updating our prediction with new information</a></li>
<li class="chapter" data-level="2.9" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#tasks"><i class="fa fa-check"></i><b>2.9</b> Tasks</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#task-1---low-level-arsenic-poisoning-in-cornwall-uk"><i class="fa fa-check"></i><b>2.9.1</b> Task 1 - Low-level arsenic poisoning in Cornwall, UK</a></li>
<li class="chapter" data-level="2.9.2" data-path="introduction-to-bayesian-statistics.html"><a href="introduction-to-bayesian-statistics.html#task-2---body-mass-index-bmi-problem"><i class="fa fa-check"></i><b>2.9.2</b> Task 2 - Body mass index (BMI) problem</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html"><i class="fa fa-check"></i><b>3</b> Bayesian Generalised Linear Models (GLMs)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#lecture-recording-length-4546-minutes"><i class="fa fa-check"></i><b>3.1</b> Lecture recording (Length: 45:46 minutes)</a></li>
<li class="chapter" data-level="3.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#introduction-1"><i class="fa fa-check"></i><b>3.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#learning-outcomes-1"><i class="fa fa-check"></i><b>3.2.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="3.2.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#demonstration-recording-length-5252-minutes"><i class="fa fa-check"></i><b>3.2.2</b> Demonstration recording (Length: 52:52 minutes)</a></li>
<li class="chapter" data-level="3.2.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#datasets-setting-up-the-work-directory-1"><i class="fa fa-check"></i><b>3.2.3</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="3.2.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#loading-and-installing-packages-1"><i class="fa fa-check"></i><b>3.2.4</b> Loading and installing packages</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#poisson-regression-modelling"><i class="fa fa-check"></i><b>3.3</b> Poisson Regression Modelling</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#selecting-the-appropriate-poisson-model"><i class="fa fa-check"></i><b>3.3.1</b> Selecting the appropriate Poisson model</a></li>
<li class="chapter" data-level="3.3.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan"><i class="fa fa-check"></i><b>3.3.2</b> Data preparation and set-up for Bayesian analysis in Stan</a></li>
<li class="chapter" data-level="3.3.3" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#creating-a-script-to-run-a-negative-binomial-poisson-regression-in-stan"><i class="fa fa-check"></i><b>3.3.3</b> Creating a script to run a Negative Binomial Poisson regression in Stan</a></li>
<li class="chapter" data-level="3.3.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#compiling-our-stan-code-in-rstudio"><i class="fa fa-check"></i><b>3.3.4</b> Compiling our Stan code in RStudio</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#logistic-regression-modelling"><i class="fa fa-check"></i><b>3.4</b> Logistic Regression Modelling</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan-1"><i class="fa fa-check"></i><b>3.4.1</b> Data preparation and set-up for Bayesian analysis in Stan</a></li>
<li class="chapter" data-level="3.4.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#creating-a-script-to-run-a-logistic-regression-in-stan"><i class="fa fa-check"></i><b>3.4.2</b> Creating a script to run a logistic regression in Stan</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#tasks-1"><i class="fa fa-check"></i><b>3.5</b> Tasks</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#task-1---obesity-and-fastfoods-in-london"><i class="fa fa-check"></i><b>3.5.1</b> Task 1 - Obesity and Fastfoods in London</a></li>
<li class="chapter" data-level="3.5.2" data-path="bayesian-generalised-linear-models-glms.html"><a href="bayesian-generalised-linear-models-glms.html#task-2---factors-affecting-house-prices-in-london-2015"><i class="fa fa-check"></i><b>3.5.2</b> Task 2 - Factors affecting house prices in London (2015)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html"><i class="fa fa-check"></i><b>4</b> Bayesian Generalised Additive Models (GAMs)</a>
<ul>
<li class="chapter" data-level="4.1" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#lecture-recording-length-3812-minutes"><i class="fa fa-check"></i><b>4.1</b> Lecture recording (Length: 38:12 minutes)</a></li>
<li class="chapter" data-level="4.2" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#introduction-2"><i class="fa fa-check"></i><b>4.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#datasets-setting-up-the-work-directory-2"><i class="fa fa-check"></i><b>4.2.1</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="4.2.2" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#loading-and-installing-packages-2"><i class="fa fa-check"></i><b>4.2.2</b> Loading and installing packages</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#implementing-a-bayesian-generalised-additive-model"><i class="fa fa-check"></i><b>4.3</b> Implementing a Bayesian Generalised Additive Model</a></li>
<li class="chapter" data-level="4.4" data-path="bayesian-generalised-additive-models-gams.html"><a href="bayesian-generalised-additive-models-gams.html#printing-stan-code-from-brmsstancode"><i class="fa fa-check"></i><b>4.4</b> Printing Stan code from <code>brms::stancode()</code></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html"><i class="fa fa-check"></i><b>5</b> Bayesian Hierarchical Regression Models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#lecture-recording-length-4825-minutes"><i class="fa fa-check"></i><b>5.1</b> Lecture recording (Length: 48:25 minutes)</a></li>
<li class="chapter" data-level="5.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#introduction-3"><i class="fa fa-check"></i><b>5.2</b> Introduction</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#datasets-setting-up-the-work-directory-3"><i class="fa fa-check"></i><b>5.2.1</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="5.2.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#loading-packages"><i class="fa fa-check"></i><b>5.2.2</b> Loading packages</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#data-preparation-and-set-up-for-bayesian-analysis-in-stan-2"><i class="fa fa-check"></i><b>5.3</b> Data preparation and set-up for Bayesian analysis in Stan</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#creating-a-script-to-run-a-2-level-multilevel-linear-regression-in-stan"><i class="fa fa-check"></i><b>5.3.1</b> Creating a script to run a 2-level Multilevel linear regression in Stan</a></li>
<li class="chapter" data-level="5.3.2" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#compiling-our-stan-code-for-hierarchical-modelling"><i class="fa fa-check"></i><b>5.3.2</b> Compiling our Stan code for Hierarchical Modelling</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="bayesian-hierarchical-regression-models.html"><a href="bayesian-hierarchical-regression-models.html#task"><i class="fa fa-check"></i><b>5.4</b> Task</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html"><i class="fa fa-check"></i><b>6</b> Bayesian Spatial Modelling for Areal Data in Stan</a>
<ul>
<li class="chapter" data-level="6.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#introduction-4"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#learning-outcomes-2"><i class="fa fa-check"></i><b>6.2</b> Learning outcomes</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#loading-and-installing-packages-3"><i class="fa fa-check"></i><b>6.2.1</b> Loading and installing packages</a></li>
<li class="chapter" data-level="6.2.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#datasets-setting-up-the-work-directory-4"><i class="fa fa-check"></i><b>6.2.2</b> Datasets &amp; setting up the work directory</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#data-preparation-in-rstudio"><i class="fa fa-check"></i><b>6.3</b> Data preparation in RStudio</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#calculation-for-expected-numbers"><i class="fa fa-check"></i><b>6.3.1</b> Calculation for expected numbers</a></li>
<li class="chapter" data-level="6.3.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#converting-the-spatial-adjacency-matrix-to-nodes-edges"><i class="fa fa-check"></i><b>6.3.2</b> Converting the spatial adjacency matrix to nodes &amp; edges</a></li>
<li class="chapter" data-level="6.3.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#create-the-dataset-to-be-compiled-in-stan"><i class="fa fa-check"></i><b>6.3.3</b> Create the dataset to be compiled in Stan</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#creating-the-script-for-the-spatial-icar-model"><i class="fa fa-check"></i><b>6.4</b> Creating the script for the Spatial ICAR model</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#data-block"><i class="fa fa-check"></i><b>6.4.1</b> Data block</a></li>
<li class="chapter" data-level="6.4.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#transformed-data-block"><i class="fa fa-check"></i><b>6.4.2</b> Transformed data block</a></li>
<li class="chapter" data-level="6.4.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#parameters-block"><i class="fa fa-check"></i><b>6.4.3</b> Parameters block</a></li>
<li class="chapter" data-level="6.4.4" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#transformed-parameters-block"><i class="fa fa-check"></i><b>6.4.4</b> Transformed parameters block</a></li>
<li class="chapter" data-level="6.4.5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#model-block"><i class="fa fa-check"></i><b>6.4.5</b> Model block</a></li>
<li class="chapter" data-level="6.4.6" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#generated-quantities-block"><i class="fa fa-check"></i><b>6.4.6</b> Generated quantities block</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#compiling-stan-code-for-the-spatial-icar-risk-modelling"><i class="fa fa-check"></i><b>6.5</b> Compiling Stan code for the Spatial ICAR risk modelling</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#printing-of-the-global-results"><i class="fa fa-check"></i><b>6.5.1</b> Printing of the global results</a></li>
<li class="chapter" data-level="6.5.2" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#rapid-diagnostics-of-the-rhats"><i class="fa fa-check"></i><b>6.5.2</b> Rapid diagnostics of the rHATs</a></li>
<li class="chapter" data-level="6.5.3" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#extraction-of-the-area-specific-relative-risks"><i class="fa fa-check"></i><b>6.5.3</b> Extraction of the area-specific relative risks</a></li>
<li class="chapter" data-level="6.5.4" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#mapping-of-rr-and-significance"><i class="fa fa-check"></i><b>6.5.4</b> Mapping of RR and significance</a></li>
<li class="chapter" data-level="6.5.5" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#extracting-and-mapping-of-the-exceedance-probabilities"><i class="fa fa-check"></i><b>6.5.5</b> Extracting and mapping of the exceedance probabilities</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="bayesian-spatial-modelling-for-areal-data-in-stan.html"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#task-1"><i class="fa fa-check"></i><b>6.6</b> Task</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html"><i class="fa fa-check"></i><b>7</b> Bayesian Updating &amp; Spatial Temporal Modelling</a>
<ul>
<li class="chapter" data-level="7.1" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#introduction-5"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#part-1-bayesian-updating"><i class="fa fa-check"></i><b>7.2</b> Part 1: Bayesian Updating</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#loading-and-installing-packages-4"><i class="fa fa-check"></i><b>7.2.1</b> Loading and installing packages</a></li>
<li class="chapter" data-level="7.2.2" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#datasets-setting-up-the-work-directory-5"><i class="fa fa-check"></i><b>7.2.2</b> Datasets &amp; setting up the work directory</a></li>
<li class="chapter" data-level="7.2.3" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#data-preparation-in-rstudio-1"><i class="fa fa-check"></i><b>7.2.3</b> Data preparation in RStudio</a></li>
<li class="chapter" data-level="7.2.4" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#full-stan-script-for-the-spatial-icar-model"><i class="fa fa-check"></i><b>7.2.4</b> Full Stan script for the Spatial ICAR model</a></li>
<li class="chapter" data-level="7.2.5" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#compiling-stan-code-for-the-baseline-icar-model"><i class="fa fa-check"></i><b>7.2.5</b> Compiling Stan code for the Baseline ICAR model</a></li>
<li class="chapter" data-level="7.2.6" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#apply-the-bayesian-updating-on-subsequent-data-sets"><i class="fa fa-check"></i><b>7.2.6</b> Apply the Bayesian updating on subsequent data sets</a></li>
<li class="chapter" data-level="7.2.7" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#list-of-key-outputs"><i class="fa fa-check"></i><b>7.2.7</b> List of key outputs</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#part-2-spatial-temporal-bayesian-modelling"><i class="fa fa-check"></i><b>7.3</b> Part 2: Spatial Temporal Bayesian Modelling</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#data-preparation"><i class="fa fa-check"></i><b>7.3.1</b> Data preparation</a></li>
<li class="chapter" data-level="7.3.2" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#creating-an-adjacency-matrix"><i class="fa fa-check"></i><b>7.3.2</b> Creating an adjacency matrix</a></li>
<li class="chapter" data-level="7.3.3" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#model-formation-inference-with-inla"><i class="fa fa-check"></i><b>7.3.3</b> Model formation &amp; inference with INLA</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="bayesian-updating-spatial-temporal-modelling.html"><a href="bayesian-updating-spatial-temporal-modelling.html#finished"><i class="fa fa-check"></i><b>7.4</b> Finished!</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="research-methods-study-design-and-revision.html"><a href="research-methods-study-design-and-revision.html"><i class="fa fa-check"></i><b>8</b> Research Methods, Study Design and Revision</a>
<ul>
<li class="chapter" data-level="8.1" data-path="research-methods-study-design-and-revision.html"><a href="research-methods-study-design-and-revision.html#lecture-length-5103-minutes"><i class="fa fa-check"></i><b>8.1</b> Lecture (Length: 51:03 minutes)</a></li>
<li class="chapter" data-level="8.2" data-path="research-methods-study-design-and-revision.html"><a href="research-methods-study-design-and-revision.html#revision-length-1756-minutes"><i class="fa fa-check"></i><b>8.2</b> Revision (Length: 17:56 minutes)</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">GEOG0125: Advanced Topics in Social Geographic Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="bayesian-spatial-modelling-for-areal-data-in-stan" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">6</span> Bayesian Spatial Modelling for Areal Data in Stan<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#bayesian-spatial-modelling-for-areal-data-in-stan" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-4" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Introduction<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#introduction-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This week’s practical you will be introduced to applying spatial Bayesian models for risk assessments for areal-level discrete outcomes. This a powerful tool used often in many applications e.g., spatial epidemiology, disaster risk reduction and environmental criminology and many more.</p>
<p>This exercise will focus on casualty data resulting from road accidents by car users (and/or occupants) in the UK. Road traffic accidents &amp; injuries are a serious problem worldwide. In fact, it is one of the leading causes of death attributed to significant life-years lost and as a consequence is associated with considerable economic losses to impacted individuals and families. There are many individual, environmental and geographical risk factors for road-related casualties. Here, we will use a series of spatial models from a Bayesian framework to estimate the <strong>area-specific relative risks (RR)</strong> of casualties due to road accidents in local authority areas across the England; and we will quantify the levels of uncertainty using a device called <strong>exceedance probabilities</strong>.</p>
</div>
<div id="learning-outcomes-2" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Learning outcomes<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#learning-outcomes-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>You will learn how to:</p>
<ul>
<li>Implement the <strong>Spatial intrinsic conditional autoregressive model (ICAR)</strong> to areal data in <strong>RStan</strong>;</li>
<li>How to use the ICAR model to predict the <strong>area-specific relative risks (RR)</strong> for areal units and how to determine whether the levels of such risk are <strong>statistically significant or not</strong> through 95% credible intervals (95% CrI);</li>
<li>How to determine the <strong>Exceedance Probability</strong> i.e., the probability that an area has an excess risk of an outcome that exceeds a given risk threshold (e.g., RR &gt; 1 (null value));</li>
</ul>
<div id="loading-and-installing-packages-3" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Loading and installing packages<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#loading-and-installing-packages-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will need to install the following new packages:</p>
<ul>
<li><code>SpatialEpi</code>: grants access to function <code>expected()</code> to calculated expected numbers</li>
<li><code>tidybayes</code>: grants access to further functions for managing posterior estimates. We will need it calculating the exceedance probabilities. Load this alongside <code>tidyverse</code> package</li>
<li><code>geostan</code>: grants access to further functions that we need to compute the adjacency matrix that can be handled in Stan. We will use the two functions <code>shape2mat()</code> and <code>prep_icar_data()</code> to create the adjacency matrix as nodes and edges.</li>
</ul>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb88-1" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;geostan&quot;</span>)</span>
<span id="cb88-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb88-2" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;SpatialEpi&quot;</span>)</span>
<span id="cb88-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb88-3" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidybayes&quot;</span>)</span></code></pre></div>
<p>Now, lets load all packages need specifically for this computer practical:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-1" tabindex="-1"></a><span class="co"># Load the packages with library()</span></span>
<span id="cb89-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;sf&quot;</span>)</span>
<span id="cb89-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-3" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tmap&quot;</span>)</span>
<span id="cb89-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;spdep&quot;</span>)</span>
<span id="cb89-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-5" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;rstan&quot;</span>)</span>
<span id="cb89-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-6" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;geostan&quot;</span>)</span>
<span id="cb89-7"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-7" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;SpatialEpi&quot;</span>)</span>
<span id="cb89-8"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-8" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidybayes&quot;</span>)</span>
<span id="cb89-9"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb89-9" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</span></code></pre></div>
<p>Upon loading the <code>rstan</code> package, we highly recommend using this code to configure it with RStudio:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb90-1" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb90-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb90-2" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>This tells RStudio to use the multiple cores in your computer for parallel processing whenever Stan is being implemented. Every time you want to use Stan - make sure to load <code>parallel::detectCores()</code> and <code>rstan_options</code> code.</p>
</div>
<div id="datasets-setting-up-the-work-directory-4" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Datasets &amp; setting up the work directory<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#datasets-setting-up-the-work-directory-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Go to your folder <strong>GEOG0125</strong> and create a sub folder called “<strong>Week 8</strong>” within the <strong>GEOG0125</strong> folder. Here, we will store all our R &amp; Stan scripts as well as datasets. Set your work directory to <strong>Week 8’s</strong> folder.</p>
<p>For Windows, the code for setting the work directory will be:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb91-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/Users/AccountName/Desktop/GEOG0125/Week 8&quot;</span>)</span></code></pre></div>
<p>For MAC, the code for setting the work directory will be:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb92-1" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;/Users/AccountName/Desktop/GEOG0125/Week 8&quot;</span>)</span></code></pre></div>
<p>The dataset for this practical are:</p>
<ul>
<li><code>Road Casualties Data 2015-2020.csv</code></li>
<li><code>England Local Authority Shapefile.shp</code></li>
<li><code>England Regions Shapefile.shp</code></li>
</ul>
<p>The dataset were going to start of with is the <code>Road Casualties Data 2015-2020.csv</code>. This data file contains the following information:</p>
<ul>
<li>It contains the 307 local authority areas that operate in England. The names and codes are defined under the columns <code>LAD21NM</code> and <code>LAD21CD</code> respectively;</li>
<li>It contains the following variables: <code>Population</code>, <code>Casualties</code> and <code>IMDScore</code>. The <code>Casualties</code> is the dependent variable, and <code>IMDScore</code> is the independent variable. We will need <code>Population</code> column to derive the <strong>expected number of road casualties</strong> to be used as an offset in the Bayesian model.</li>
</ul>
<p>The shapefile <code>England Local Authority Shapefile.shp</code> contains the boundaries for all 307 local authorities in England. The <code>England Regions Shapefile.shp</code> contains the boundaries for all 10 regions that make up England.</p>
<p>Let us load these dataset to memory:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb93-1" tabindex="-1"></a><span class="co"># load the shape files</span></span>
<span id="cb93-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb93-2" tabindex="-1"></a>england_LA_shp <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;England Local Authority Shapefile.shp&quot;</span>)</span>
<span id="cb93-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb93-3" tabindex="-1"></a>england_Region_shp <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;England Regions Shapefile.shp&quot;</span>)</span>
<span id="cb93-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb93-4" tabindex="-1"></a></span>
<span id="cb93-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb93-5" tabindex="-1"></a><span class="co"># load in the cross-sectional road accident dataset</span></span>
<span id="cb93-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb93-6" tabindex="-1"></a>road_accidents <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;Road Casualties Data 2015-2020.csv&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="data-preparation-in-rstudio" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Data preparation in RStudio<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#data-preparation-in-rstudio" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="calculation-for-expected-numbers" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> Calculation for expected numbers<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#calculation-for-expected-numbers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In order to estimate the risk of casualties due to road accidents at an LA-level in England, we will need to first obtain a column that contains estimates from expected number of road casualties. This is derived from the <code>Population</code> column which as <strong>denominators</strong> or <strong>reference population size</strong> which is multiplied to the overall incidence rates of road accidents to get the number of expected casualties for each LA area.</p>
<p>You can use the <code>expected()</code> function to compute this column into the <code>road_accident</code> data frame</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb94-1" tabindex="-1"></a><span class="co"># calculate the expected number of cases</span></span>
<span id="cb94-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb94-2" tabindex="-1"></a>road_accidents<span class="sc">$</span>ExpectedNum <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">expected</span>(<span class="at">population =</span> road_accidents<span class="sc">$</span>Population, <span class="at">cases =</span> road_accidents<span class="sc">$</span>Casualties, <span class="at">n.strata =</span> <span class="dv">1</span>), <span class="dv">0</span>)</span></code></pre></div>
<p>This particular column <code>ExpectedNum</code> is important, it must be computed and used as an offset in our spatial model.</p>
</div>
<div id="converting-the-spatial-adjacency-matrix-to-nodes-edges" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> Converting the spatial adjacency matrix to nodes &amp; edges<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#converting-the-spatial-adjacency-matrix-to-nodes-edges" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will need to transform the image below into a list of nodes and edges accordingly as Stan can only identify adjacency with a set of paired nodes with edges that connect them. For instance, <code>node1</code> is the index region and <code>node2</code> is the list of neighbouring regions connected to the index region in <code>node1</code></p>
<p><img src="images/general/Nodes_Edges.png" width="60%" style="display: block; margin: auto;" /></p>
<p>We can perform this by first merging in the road accident data to the LA-level shapefile. Once this action is completed, we will then need to coerce the spatial object to be from a simple features (i.e., <code>sf</code>) object to the spatial object (i.e., <code>sp</code>).</p>
<p>Here is the code:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb95-1" tabindex="-1"></a><span class="co"># merge the attribute table to the shapefile</span></span>
<span id="cb95-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb95-2" tabindex="-1"></a>spatial.data <span class="ot">&lt;-</span> <span class="fu">merge</span>(england_LA_shp, road_accidents, <span class="at">by.x =</span> <span class="fu">c</span>(<span class="st">&quot;LAD21CD&quot;</span>, <span class="st">&quot;LAD21NM&quot;</span>), <span class="at">by.y =</span> <span class="fu">c</span>(<span class="st">&quot;LAD21CD&quot;</span>, <span class="st">&quot;LAD21NM&quot;</span>), <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb95-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb95-3" tabindex="-1"></a><span class="co"># reordering the columns</span></span>
<span id="cb95-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb95-4" tabindex="-1"></a>spatial.data <span class="ot">&lt;-</span> spatial.data[, <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">6</span>)]</span>
<span id="cb95-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb95-5" tabindex="-1"></a><span class="co"># need to be coerced into a spatial object</span></span>
<span id="cb95-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb95-6" tabindex="-1"></a>sp.object <span class="ot">&lt;-</span> <span class="fu">as</span>(spatial.data, <span class="st">&quot;Spatial&quot;</span>)</span></code></pre></div>
<p>Now, we are going to need the <strong>nodes</strong> and <strong>edges</strong> from the <code>sp.object</code> using the <code>shape2mat()</code> function - this changes it into a matrix object. From the matrix object, we will be able to prepare the data from spatial ICAR model using the <code>prep_icar_data()</code> function. Here, is the code:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb96-1" tabindex="-1"></a><span class="co"># needs to be coerced into a matrix object</span></span>
<span id="cb96-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb96-2" tabindex="-1"></a>adjacencyMatrix <span class="ot">&lt;-</span> <span class="fu">shape2mat</span>(sp.object)</span>
<span id="cb96-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb96-3" tabindex="-1"></a><span class="co"># we extract the components for the ICAR model</span></span>
<span id="cb96-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb96-4" tabindex="-1"></a>extractComponents <span class="ot">&lt;-</span> <span class="fu">prep_icar_data</span>(adjacencyMatrix)</span></code></pre></div>
<p>From the <code>extractComponents</code> object, we will need to extract the following contents:</p>
<ul>
<li><code>$group_size</code> this is the number of areal units under observation listed in the shapefile (should be the same in the road accidents dataset)</li>
<li><code>$node1</code> are index regions of interest</li>
<li><code>$node2</code> are the other neighbouring regions that are connected to the index region of interest listed in <code>node1</code></li>
<li><code>$n_edges</code> creates the network as show area is connected to what neighbourhood. It’s still an adjacency matrix using the queen contiguity matrix but as a network.</li>
</ul>
<p>Here is the code for performing the extraction:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb97-1" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(extractComponents<span class="sc">$</span>group_size)</span>
<span id="cb97-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb97-2" tabindex="-1"></a>nod1 <span class="ot">&lt;-</span> extractComponents<span class="sc">$</span>node1</span>
<span id="cb97-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb97-3" tabindex="-1"></a>nod2 <span class="ot">&lt;-</span> extractComponents<span class="sc">$</span>node2</span>
<span id="cb97-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb97-4" tabindex="-1"></a>n_edges <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(extractComponents<span class="sc">$</span>n_edges)</span></code></pre></div>
<p>Note that the information needed are stored in <code>n</code>, <code>nod1</code>, <code>nod2</code> and <code>n_edges</code>.</p>
</div>
<div id="create-the-dataset-to-be-compiled-in-stan" class="section level3 hasAnchor" number="6.3.3">
<h3><span class="header-section-number">6.3.3</span> Create the dataset to be compiled in Stan<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#create-the-dataset-to-be-compiled-in-stan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For the list step in the data preparation, we need to define the variables needed to be compiled in Stan. The outcome <code>Casualties</code>, independent variable <code>IMDScore</code> and offset variable <code>ExpectedNum</code> needs to be extracted into separate vectors. The data needs to be aligned with the areas in shapefile as the result will be churned to that order. So make sure the data is already linked in to the geometries!</p>
<p>Here is the code:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb98-1" tabindex="-1"></a>y <span class="ot">&lt;-</span> spatial.data<span class="sc">$</span>Casualties</span>
<span id="cb98-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb98-2" tabindex="-1"></a>x <span class="ot">&lt;-</span> spatial.data<span class="sc">$</span>IMDScore</span>
<span id="cb98-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb98-3" tabindex="-1"></a>e <span class="ot">&lt;-</span> spatial.data<span class="sc">$</span>ExpectedNum</span></code></pre></div>
<p>Now, we create our dataset for Stan:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb99-1" tabindex="-1"></a><span class="co"># put all components into a list object</span></span>
<span id="cb99-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb99-2" tabindex="-1"></a>stan.spatial.dataset <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N=</span>n, <span class="at">N_edges=</span>n_edges, <span class="at">node1=</span>nod1, <span class="at">node2=</span>nod2, <span class="at">Y=</span>y, <span class="at">X=</span>x, <span class="at">Offset=</span>e)</span></code></pre></div>
<p>The above information is going to be passed to Stan in the <code>data block</code>. Now, we are in the position to develop our <strong>spatial intrinsic conditional autoregressive (ICAR) model</strong>. Now open your Stan script and we begin.</p>
</div>
</div>
<div id="creating-the-script-for-the-spatial-icar-model" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Creating the script for the Spatial ICAR model<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#creating-the-script-for-the-spatial-icar-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="data-block" class="section level3 hasAnchor" number="6.4.1">
<h3><span class="header-section-number">6.4.1</span> Data block<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#data-block" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the <code>data block</code>, we specify the following:</p>
<ul>
<li>The total number of areal unit observations <code>N</code> as an integer (i.e., <code>307</code>), this corresponds to <code>n</code>;</li>
<li>The total number edges <code>N_edges</code> as an integer (i.e., <code>823</code>), this corresponds to <code>n_edges</code>;</li>
<li>The <code>nodes1</code> based on the size of <code>N_edges</code> (i.e., <code>823</code>) must be specified as an array to connect with <code>nodes2</code>, this corresponds to <code>nod1</code>;</li>
<li>The <code>nodes2</code> based on the size of <code>N_edges</code> (i.e., <code>823</code>) must be specified as an array to connect with <code>nodes1</code>, this corresponds to <code>nod2</code>;</li>
<li>We define our <code>Y</code> outcome (i.e., road accidents) as an <code>array</code> of size <code>N</code> (i.e., <code>307</code>) which is an <code>integer</code>, this corresponds to <code>y</code>;</li>
<li>We define our independent variables <code>X</code> as a <code>vector</code> of size <code>N</code> (i.e., <code>307</code>), this corresponds to <code>x</code>;</li>
<li>We must define our offset for the expected numbers <code>Offset</code> as a vector of size <code>N</code> (i.e., <code>307</code>), this corresponds to <code>e</code>;</li>
</ul>
<p>Here is what our <code>model</code>data block` would look like:</p>
<pre class="text"><code>data {
  int&lt;lower=0&gt; N;                                                        // number of spatial units or neighbourhoods
  int&lt;lower=0&gt; N_edges;                                                  // number of edges connecting adjacent areas using Queens contiguity
  array[N_edges] int&lt;lower=1, upper=N&gt; node1;                            // list of index areas showing which spatial units are neighbours
  array[N_edges] int&lt;lower=1, upper=N&gt; node2;                            // list of neighbouring areas showing the connection to index spatial unit
  array[N] int&lt;lower=0&gt; Y;                                               // dependent variable
  vector&lt;lower=0&gt;[N] X;                                                  // Single independent variable
  vector&lt;lower=0&gt;[N] Offset;                                             // offset variable
}</code></pre>
</div>
<div id="transformed-data-block" class="section level3 hasAnchor" number="6.4.2">
<h3><span class="header-section-number">6.4.2</span> Transformed data block<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#transformed-data-block" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We are going to include a transformed data block. Here, we are simply changing the expected numbers by taking its <code>log()</code> and creating another vector called log_offset. This will be added to the <code>poisson_log()</code> sampling statement in our likelihood function of the spatial model to account for the reference population in England.</p>
<p>Here, we specify it as follows:</p>
<pre class="text"><code>data {
  int&lt;lower=0&gt; N;                                                        // number of spatial units or neighbourhoods
  int&lt;lower=0&gt; N_edges;                                                  // number of edges connecting adjacent areas using Queens contiguity
  array[N_edges] int&lt;lower=1, upper=N&gt; node1;                            // list of index areas showing which spatial units are neighbours
  array[N_edges] int&lt;lower=1, upper=N&gt; node2;                            // list of neighbouring areas showing the connection to index spatial unit
  array[N] int&lt;lower=0&gt; Y;                                               // dependent variable
  vector&lt;lower=0&gt;[N] X;                                                  // Single independent variable
  vector&lt;lower=0&gt;[N] Offset;                                             // offset variable
}

transformed data {
    vector[N] log_Offset = log(Offset);                                  // use the expected cases as an offset and add to the regression model
}</code></pre>
</div>
<div id="parameters-block" class="section level3 hasAnchor" number="6.4.3">
<h3><span class="header-section-number">6.4.3</span> Parameters block<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#parameters-block" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For the <code>parameters block</code>, we will need to specify the following:</p>
<ul>
<li>The global intercept i.e., <code>alpha</code> for the entire study area (i.e., average risk of road accidents on a population-level);</li>
<li>The coefficient <code>beta</code> for our independent variable <code>X</code> which is the <code>IMDScore</code>;</li>
<li>We also specify <code>sigma</code> as a <code>real</code> value which is some error or standard deviation that is multiplied to the combined effects of our structured and unstructured random effects;</li>
<li>We define the <strong>structured</strong> spatial random effects <code>phi</code> to be vector of size <code>N</code>;</li>
<li>We define the <strong>unstructured</strong> spatial random effects <code>theta</code> to be vector of size <code>N</code>;</li>
<li>We define <code>rho</code> as the proportion of the variation coming from the structured spatial random effects;</li>
</ul>
<p>We add the <code>parameters block</code> as follows:</p>
<pre class="text"><code>data {
  int&lt;lower=0&gt; N;                                                        // number of spatial units or neighbourhoods
  int&lt;lower=0&gt; N_edges;                                                  // number of edges connecting adjacent areas using Queens contiguity
  array[N_edges] int&lt;lower=1, upper=N&gt; node1;                            // list of index areas showing which spatial units are neighbours
  array[N_edges] int&lt;lower=1, upper=N&gt; node2;                            // list of neighbouring areas showing the connection to index spatial unit
  array[N] int&lt;lower=0&gt; Y;                                               // dependent variable
  vector&lt;lower=0&gt;[N] X;                                                  // Single independent variable
  vector&lt;lower=0&gt;[N] Offset;                                             // offset variable
}

transformed data {
    vector[N] log_Offset = log(Offset);                                  // use the expected cases as an offset and add to the regression model
}

parameters {
  real alpha;                                                            // intercept
  real beta;                                                             // covariates
  real&lt;lower=0&gt; sigma;                                                   // overall standard deviation
  real&lt;lower=0, upper=1&gt; rho;                                            // proportion unstructured vs. spatially structured variance
  vector[N] theta;                                                       // unstructured random effects
  vector[N] phi;                                                         // structured spatial random effects
}</code></pre>
</div>
<div id="transformed-parameters-block" class="section level3 hasAnchor" number="6.4.4">
<h3><span class="header-section-number">6.4.4</span> Transformed parameters block<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#transformed-parameters-block" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here, we calculate the combined random effects from the structured and unstructured component for our model:</p>
<pre class="text"><code>data {
  int&lt;lower=0&gt; N;                                                        // number of spatial units or neighbourhoods
  int&lt;lower=0&gt; N_edges;                                                  // number of edges connecting adjacent areas using Queens contiguity
  array[N_edges] int&lt;lower=1, upper=N&gt; node1;                            // list of index areas showing which spatial units are neighbours
  array[N_edges] int&lt;lower=1, upper=N&gt; node2;                            // list of neighbouring areas showing the connection to index spatial unit
  array[N] int&lt;lower=0&gt; Y;                                               // dependent variable
  vector&lt;lower=0&gt;[N] X;                                                  // Single independent variable
  vector&lt;lower=0&gt;[N] Offset;                                             // offset variable
}

transformed data {
    vector[N] log_Offset = log(Offset);                                  // use the expected cases as an offset and add to the regression model
}

parameters {
  real alpha;                                                            // intercept
  real beta;                                                             // covariates
  real&lt;lower=0&gt; sigma;                                                   // overall standard deviation
  real&lt;lower=0, upper=1&gt; rho;                                            // proportion unstructured vs. spatially structured variance
  vector[N] theta;                                                       // unstructured random effects
  vector[N] phi;                                                         // structured spatial random effects
}

transformed parameters {
  vector[N] combined;                                                    // values derived from adding the unstructure and structured effect of each area
  combined = sqrt(1 - rho) * theta + sqrt(rho) * phi;                    // formulation for the combined random effect
}</code></pre>
</div>
<div id="model-block" class="section level3 hasAnchor" number="6.4.5">
<h3><span class="header-section-number">6.4.5</span> Model block<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#model-block" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We build our likelihood function and specify the priors for each parameter under the <code>model block</code>. We are using a typical Poisson model with a log link function as we are assuming there’s some linear relationship between the road accident counts and IMD score, but here we are also taking into account the combined spatial and non-spatial random effects:</p>
<pre class="text"><code>data {
  int&lt;lower=0&gt; N;                                                        // number of spatial units or neighbourhoods
  int&lt;lower=0&gt; N_edges;                                                  // number of edges connecting adjacent areas using Queens contiguity
  array[N_edges] int&lt;lower=1, upper=N&gt; node1;                            // list of index areas showing which spatial units are neighbours
  array[N_edges] int&lt;lower=1, upper=N&gt; node2;                            // list of neighbouring areas showing the connection to index spatial unit
  array[N] int&lt;lower=0&gt; Y;                                               // dependent variable
  vector&lt;lower=0&gt;[N] X;                                                  // Single independent variable
  vector&lt;lower=0&gt;[N] Offset;                                             // offset variable
}

transformed data {
    vector[N] log_Offset = log(Offset);                                  // use the expected cases as an offset and add to the regression model
}

parameters {
  real alpha;                                                            // intercept
  real beta;                                                             // covariates
  real&lt;lower=0&gt; sigma;                                                   // overall standard deviation
  real&lt;lower=0, upper=1&gt; rho;                                            // proportion unstructured vs. spatially structured variance
  vector[N] theta;                                                       // unstructured random effects
  vector[N] phi;                                                         // structured spatial random effects
}

transformed parameters {
  vector[N] combined;                                                    // values derived from adding the unstructure and structured effect of each area
  combined = sqrt(1 - rho) * theta + sqrt(rho) * phi;                    // formulation for the combined random effect
}

model {
  Y ~ poisson_log(log_Offset + alpha + X * beta + combined * sigma);    // likelihood function: multivariable Poisson ICAR regression model
                                                                        // setting priors
  alpha ~ normal(0.0, 1.0);                                             // prior for alpha: weakly informative
  beta ~ normal(0.0, 1.0);                                              // prior for betas: weakly informative
  theta ~ normal(0.0, 1.0);                                             // prior for theta: weakly informative
  sigma ~ normal(0.0, 1.0);                                             // prior for sigma: weakly informative
  rho ~ beta(0.5, 0.5);                                                 // prior for rho
  target += -0.5 * dot_self(phi[node1] - phi[node2]);                   // calculates the spatial weights
  sum(phi) ~ normal(0, 0.001 * N);                                      // priors for phi
}</code></pre>
</div>
<div id="generated-quantities-block" class="section level3 hasAnchor" number="6.4.6">
<h3><span class="header-section-number">6.4.6</span> Generated quantities block<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#generated-quantities-block" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Lastly, we instruct Stan on the parameters we want to report. We want them as <strong>relative risk ratio (RR)</strong>. We can use the <code>generated quantities block</code> to obtain these estimates by exponentiation of the ICAR regression model:</p>
<pre class="text"><code>data {
  int&lt;lower=0&gt; N;                                                        // number of spatial units or neighbourhoods
  int&lt;lower=0&gt; N_edges;                                                  // number of edges connecting adjacent areas using Queens contiguity
  array[N_edges] int&lt;lower=1, upper=N&gt; node1;                            // list of index areas showing which spatial units are neighbours
  array[N_edges] int&lt;lower=1, upper=N&gt; node2;                            // list of neighbouring areas showing the connection to index spatial unit
  array[N] int&lt;lower=0&gt; Y;                                               // dependent variable
  vector&lt;lower=0&gt;[N] X;                                                  // Single independent variable
  vector&lt;lower=0&gt;[N] Offset;                                             // offset variable
}

transformed data {
    vector[N] log_Offset = log(Offset);                                  // use the expected cases as an offset and add to the regression model
}

parameters {
  real alpha;                                                            // intercept
  real beta;                                                             // covariates
  real&lt;lower=0&gt; sigma;                                                   // overall standard deviation
  real&lt;lower=0, upper=1&gt; rho;                                            // proportion unstructured vs. spatially structured variance
  vector[N] theta;                                                       // unstructured random effects
  vector[N] phi;                                                         // structured spatial random effects
}

transformed parameters {
  vector[N] combined;                                                    // values derived from adding the unstructure and structured effect of each area
  combined = sqrt(1 - rho) * theta + sqrt(rho) * phi;                    // formulation for the combined random effect
}

model {
  Y ~ poisson_log(log_Offset + alpha + X * beta + combined * sigma);    // likelihood function: multivariable Poisson ICAR regression model
                                                                        // setting priors
  alpha ~ normal(0.0, 1.0);                                             // prior for alpha: weakly informative
  beta ~ normal(0.0, 1.0);                                              // prior for betas: weakly informative
  theta ~ normal(0.0, 1.0);                                             // prior for theta: weakly informative
  sigma ~ normal(0.0, 1.0);                                             // prior for sigma: weakly informative
  rho ~ beta(0.5, 0.5);                                                 // prior for rho
  target += -0.5 * dot_self(phi[node1] - phi[node2]);                   // calculates the spatial weights
  sum(phi) ~ normal(0, 0.001 * N);                                      // priors for phi
}

generated quantities {
  vector[N] eta = alpha + X * beta + combined * sigma;                  // compute eta and exponentiate into mu                   
  vector[N] rr_mu = exp(eta);                                           // output the neighbourhood-specific relative risks in mu
  real rr_beta = exp(beta);                                             // output the risk ratios for each coefficient
  real rr_alpha = exp(alpha);                                           // output the risk ratios for the intercept
}</code></pre>
<div class="note">
<p>Well done! You have coded your first spatial risk model. Alright, let us save the script as <code>icar_poisson_model.stan</code>. We can now compile and run it through RStudio to get our posterior estimates as <strong>risk ratios (RR)</strong> for each areas. We can also get the <strong>exceedance probabilities</strong>. The next steps are easy from this point onwards.</p>
</div>
</div>
</div>
<div id="compiling-stan-code-for-the-spatial-icar-risk-modelling" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Compiling Stan code for the Spatial ICAR risk modelling<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#compiling-stan-code-for-the-spatial-icar-risk-modelling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="printing-of-the-global-results" class="section level3 hasAnchor" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> Printing of the global results<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#printing-of-the-global-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now, let us turn our attention to RStudio. Using the <code>stan()</code> to compile the saved script to obtain the posterior estimation of the parameters from our model:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb106-1" tabindex="-1"></a>icar_poisson_fit <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">&quot;icar_poisson_model.stan&quot;</span>, <span class="at">data=</span>stan.spatial.dataset, <span class="at">iter=</span><span class="dv">20000</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_treedepth =</span> <span class="dv">12</span>), <span class="at">chains=</span><span class="dv">6</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>We can see our estimated results for <code>alpha</code>, <code>beta</code> and <code>sigma</code>:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb107-1" tabindex="-1"></a><span class="co"># remove that annoying scientific notation</span></span>
<span id="cb107-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb107-2" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb107-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb107-3" tabindex="-1"></a><span class="fu">summary</span>(icar_poisson_fit, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary</span></code></pre></div>
<p><strong>Output from summary()$summary function:</strong></p>
<pre class="text"><code>              mean       se_mean          sd         2.5%       97.5%     n_eff     Rhat
alpha  0.162965832 0.00052694848 0.084071562 -0.001856892  0.32898381 25454.344 1.000094
beta  -0.009775948 0.00002545072 0.004085887 -0.017779845 -0.00177424 25773.456 1.000076
sigma  0.627153399 0.00078449468 0.052970350  0.538581209  0.74606811  4559.169 1.001467</code></pre>
<p>Here is the <strong>interpretation</strong>:</p>
<ul>
<li><code>alpha</code> is the global mean (or average) in the population under study. It means on average the road accident occurrence in England for the period 2015 to 2020 is <strong>0.1629 (95% CrI: -0.00185 to 0.3289)</strong>. If we take the exponent of this value i.e., <code>exp(0.162965832)</code> - we get the relative risks of road accidents which is 1.17 times higher in England <strong>(95% CrI: 0.998 to 1.38)</strong>. The result is not significant as the null value of 1 exists between its lower and upper limits.</li>
<li><code>beta</code> is the coefficient for <code>IMDScore</code>. This means that its yields a decrease on average for road accidents throughout England for more deprived areas <strong>-0.0097 (95% CI: -0.0177 to -0.00177424)</strong>. This is negligible negative relationship that is statistically significant; while it is significant, if we exponentiate these values its really close to the null value (1), so we can rule out this relationship!</li>
<li><code>sigma</code> is the overall standard deviation or global error.</li>
</ul>
<p>Note, we can view the <strong>spatial effects</strong> i.e., <code>phi</code> for each area using this code:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb109-1" tabindex="-1"></a><span class="co"># show first 6 rows only instead of the full 307</span></span>
<span id="cb109-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb109-2" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">summary</span>(icar_poisson_fit, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span></code></pre></div>
<p>Alternatively, you can use the <code>print()</code> function to get a detailed output:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb110-1" tabindex="-1"></a><span class="fu">print</span>(icar_poisson_fit, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code></pre></div>
<p><strong>Output from print() function:</strong></p>
<pre class="text"><code>Inference for Stan model: anon_model.
6 chains, each with iter=20000; warmup=10000; thin=1; 
post-warmup draws per chain=10000, total post-warmup draws=60000.

       mean se_mean   sd  2.5% 97.5% n_eff Rhat
alpha  0.16       0 0.08  0.00  0.33 25454    1
beta  -0.01       0 0.00 -0.02  0.00 25773    1
sigma  0.63       0 0.05  0.54  0.75  4559    1

Samples were drawn using NUTS(diag_e) at Fri Mar  8 07:41:39 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<div id="rapid-diagnostics-of-the-rhats" class="section level3 hasAnchor" number="6.5.2">
<h3><span class="header-section-number">6.5.2</span> Rapid diagnostics of the rHATs<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#rapid-diagnostics-of-the-rhats" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before mapping the relative risks, we must check if the any of the estimates i.e., <code>alpha</code>, <code>beta</code>, <code>sigma</code> and all <code>phi</code> exceed the <strong>rHAT</strong> value of 1.1. This is an indication that iterations did not perform well if an <code>rHAT</code> for a parameter is above <code>1.1</code>. We can do a rapid checks to see which parameter is valid or not by creating a binary variable of <code>1</code>’s (Valid) and <code>0</code>’s (Not valid). We can tabulate it to see the numbers:</p>
<pre class="text"><code># diagnostic check on the rHats - put everything into a data frame
diagnostic.checks &lt;- as.data.frame(summary(icar_poisson_fit, pars=c(&quot;alpha&quot;, &quot;beta&quot;, &quot;sigma&quot;, &quot;phi&quot;, &quot;lp__&quot;), probs=c(0.025, 0.5, 0.975))$summary)
# create binary variable
diagnostic.checks$valid &lt;- ifelse(diagnostic.checks$Rhat &lt; 1.1, 1, 0)
# tabulate it
table(diagnostic.checks$valid)</code></pre>
<p>Everything is okay - all outputted parameters have an <code>rHAT &lt; 1.1</code>. We are free to generate maps.</p>
<div class="note">
<p><strong>NOTES</strong>: To avoid such complications, it is always to best to run about <code>10000</code>, <code>15000</code> or more iterations. Usually, shorter iterations yield low effective sample sizes after thinning/warm-up samples are discarded, which in turn, may lead to complications that may cause the rHAT to be above 1.1.</p>
</div>
</div>
<div id="extraction-of-the-area-specific-relative-risks" class="section level3 hasAnchor" number="6.5.3">
<h3><span class="header-section-number">6.5.3</span> Extraction of the area-specific relative risks<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#extraction-of-the-area-specific-relative-risks" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you run the following code:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb113-1" tabindex="-1"></a><span class="co"># show first 6 rows only instead of the full 307</span></span>
<span id="cb113-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb113-2" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">summary</span>(icar_poisson_fit, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;rr_mu&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span></code></pre></div>
<p>We see the relative risk (RR) estimates for the first areas under the column <code>mu</code> with their corresponding credibility limits under the <code>2.5%</code> and <code>97.5%</code> column. We are going to extract this information into a data frame and applying the cleaning and renaming of columns accordingly:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-1" tabindex="-1"></a><span class="co"># extraction key posterior results for the generated quantities </span></span>
<span id="cb114-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-2" tabindex="-1"></a>relativeRisk.results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(icar_poisson_fit, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;rr_mu&quot;</span>), <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))<span class="sc">$</span>summary)</span>
<span id="cb114-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-3" tabindex="-1"></a><span class="co"># now cleaning up this table up</span></span>
<span id="cb114-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-4" tabindex="-1"></a><span class="co"># first, insert clean row numbers to new data frame</span></span>
<span id="cb114-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-5" tabindex="-1"></a><span class="fu">row.names</span>(relativeRisk.results) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(relativeRisk.results)</span>
<span id="cb114-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-6" tabindex="-1"></a><span class="co"># second, rearrange the columns into order</span></span>
<span id="cb114-7"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-7" tabindex="-1"></a>relativeRisk.results <span class="ot">&lt;-</span> relativeRisk.results[, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>)]</span>
<span id="cb114-8"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-8" tabindex="-1"></a><span class="co"># third, rename the columns appropriately</span></span>
<span id="cb114-9"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-9" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rr&quot;</span></span>
<span id="cb114-10"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-10" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rrlower&quot;</span></span>
<span id="cb114-11"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-11" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rrupper&quot;</span></span>
<span id="cb114-12"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-12" tabindex="-1"></a><span class="fu">colnames</span>(relativeRisk.results)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&quot;rHAT&quot;</span></span>
<span id="cb114-13"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-13" tabindex="-1"></a></span>
<span id="cb114-14"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-14" tabindex="-1"></a><span class="co"># view clean table </span></span>
<span id="cb114-15"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb114-15" tabindex="-1"></a><span class="fu">head</span>(relativeRisk.results)</span></code></pre></div>
<p>See clean table:</p>
<pre class="text"><code>         rr   rrlower   rrupper      rHAT valid
1 0.6295692 0.5759348 0.6859993 0.9999354     1
2 0.8043656 0.7550300 0.8555160 0.9999809     1
3 0.6518326 0.6068501 0.6991145 0.9999186     1
4 0.6292392 0.5920648 0.6674334 0.9999475     1
5 0.8885551 0.8284516 0.9505547 1.0000141     1
6 0.7971718 0.7451160 0.8513495 0.9999757     1</code></pre>
<p>Insert these columns into the <code>spatial.data</code> object as follow:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb116-1" tabindex="-1"></a><span class="co"># now, we proceed to generate our risk maps</span></span>
<span id="cb116-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb116-2" tabindex="-1"></a><span class="co"># align the results to the areas in shapefile</span></span>
<span id="cb116-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb116-3" tabindex="-1"></a>spatial.data<span class="sc">$</span>rr <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rr&quot;</span>]</span>
<span id="cb116-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb116-4" tabindex="-1"></a>spatial.data<span class="sc">$</span>rrlower <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rrlower&quot;</span>]</span>
<span id="cb116-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb116-5" tabindex="-1"></a>spatial.data<span class="sc">$</span>rrupper <span class="ot">&lt;-</span> relativeRisk.results[, <span class="st">&quot;rrupper&quot;</span>]</span></code></pre></div>
<p>These relative will allow us to see the mapped risks of road accidents across local authorities in England. We also want a supporting map indicate whether the risks are significant or not. Here, we create an extra column in the <code>spatial.data</code> called <code>Significance</code>.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb117-1" tabindex="-1"></a><span class="co"># create categories to define if an area has significant increase or decrease in risk, or nothing all </span></span>
<span id="cb117-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb117-2" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb117-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb117-3" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&gt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>    <span class="co"># NOT SIGNIFICANT</span></span>
<span id="cb117-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb117-4" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># NOT SIGNIFICANT</span></span>
<span id="cb117-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb117-5" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&gt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>    <span class="co"># SIGNIFICANT INCREASE</span></span>
<span id="cb117-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb117-6" tabindex="-1"></a>spatial.data<span class="sc">$</span>Significance[spatial.data<span class="sc">$</span>rrlower<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rrupper<span class="sc">&lt;</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span>   <span class="co"># SIGNIFICANT DECREASE</span></span></code></pre></div>
</div>
<div id="mapping-of-rr-and-significance" class="section level3 hasAnchor" number="6.5.4">
<h3><span class="header-section-number">6.5.4</span> Mapping of RR and significance<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#mapping-of-rr-and-significance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next set of codes are all cosmetics for the creating our risk map for road accidents. Here is the code:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-1" tabindex="-1"></a><span class="co"># For map design for the relative risk -- you want to understand or get a handle on what the distribution for risks look like</span></span>
<span id="cb118-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-2" tabindex="-1"></a><span class="co"># this would inform you of how to create the labelling for the legends when make a map in tmap</span></span>
<span id="cb118-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-3" tabindex="-1"></a><span class="fu">summary</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb118-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-4" tabindex="-1"></a><span class="fu">hist</span>(spatial.data<span class="sc">$</span>rr)</span>
<span id="cb118-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-5" tabindex="-1"></a></span>
<span id="cb118-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-6" tabindex="-1"></a><span class="co"># creating the labels</span></span>
<span id="cb118-7"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-7" tabindex="-1"></a>RiskCategorylist <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;&gt;0.0 to 0.25&quot;</span>, <span class="st">&quot;0.26 to 0.50&quot;</span>, <span class="st">&quot;0.51 to 0.75&quot;</span>, <span class="st">&quot;0.76 to 0.99&quot;</span>, <span class="st">&quot;1.00 &amp; &lt;1.01&quot;</span>,</span>
<span id="cb118-8"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-8" tabindex="-1"></a>    <span class="st">&quot;1.01 to 1.10&quot;</span>, <span class="st">&quot;1.11 to 1.25&quot;</span>, <span class="st">&quot;1.26 to 1.50&quot;</span>, <span class="st">&quot;1.51 to 1.75&quot;</span>, <span class="st">&quot;1.76 to 2.00&quot;</span>, <span class="st">&quot;2.01 to 3.00&quot;</span>)</span>
<span id="cb118-9"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-9" tabindex="-1"></a></span>
<span id="cb118-10"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-10" tabindex="-1"></a><span class="co"># next, we are creating the discrete colour changes for my legends and want to use a divergent colour scheme</span></span>
<span id="cb118-11"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-11" tabindex="-1"></a><span class="co"># scheme ranges from extreme dark blues to light blues to white to light reds to extreme dark reds</span></span>
<span id="cb118-12"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-12" tabindex="-1"></a><span class="co"># you can pick your own colour choices by checking out this link [https://colorbrewer2.org]</span></span>
<span id="cb118-13"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-13" tabindex="-1"></a></span>
<span id="cb118-14"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-14" tabindex="-1"></a>RRPalette <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;#65bafe&quot;</span>,<span class="st">&quot;#98cffe&quot;</span>,<span class="st">&quot;#cbe6fe&quot;</span>,<span class="st">&quot;#dfeffe&quot;</span>,<span class="st">&quot;white&quot;</span>,<span class="st">&quot;#fed5d5&quot;</span>,<span class="st">&quot;#fcbba1&quot;</span>,<span class="st">&quot;#fc9272&quot;</span>,<span class="st">&quot;#fb6a4a&quot;</span>,<span class="st">&quot;#de2d26&quot;</span>,<span class="st">&quot;#a50f15&quot;</span>)</span>
<span id="cb118-15"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-15" tabindex="-1"></a></span>
<span id="cb118-16"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-16" tabindex="-1"></a><span class="co"># categorising the risk values to match the labelling in RiskCategorylist object</span></span>
<span id="cb118-17"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-17" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb118-18"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-18" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="fl">0.25</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">4</span></span>
<span id="cb118-19"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-19" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;</span> <span class="fl">0.25</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="fl">0.50</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">3</span></span>
<span id="cb118-20"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-20" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;</span> <span class="fl">0.50</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="fl">0.75</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span></span>
<span id="cb118-21"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-21" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;</span> <span class="fl">0.75</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb118-22"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-22" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;=</span> <span class="fl">1.00</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;</span> <span class="fl">1.01</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb118-23"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-23" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;=</span> <span class="fl">1.01</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="fl">1.10</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb118-24"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-24" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;</span> <span class="fl">1.10</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="fl">1.25</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb118-25"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-25" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;</span> <span class="fl">1.25</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="fl">1.50</span>] <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb118-26"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-26" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;</span> <span class="fl">1.50</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="fl">1.75</span>] <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb118-27"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-27" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;</span> <span class="fl">1.75</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="fl">2.00</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb118-28"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-28" tabindex="-1"></a>spatial.data<span class="sc">$</span>RelativeRiskCat[spatial.data<span class="sc">$</span>rr<span class="sc">&gt;</span> <span class="fl">2.00</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>rr <span class="sc">&lt;=</span> <span class="dv">10</span>] <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb118-29"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-29" tabindex="-1"></a></span>
<span id="cb118-30"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-30" tabindex="-1"></a><span class="co"># check to see if legend scheme is balanced - if a number is missing that categorisation is wrong!</span></span>
<span id="cb118-31"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb118-31" tabindex="-1"></a><span class="fu">table</span>(spatial.data<span class="sc">$</span>RelativeRiskCat)</span></code></pre></div>
<p>Generating the maps as a paneled output:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-1" tabindex="-1"></a><span class="co"># map of relative risk</span></span>
<span id="cb119-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-2" tabindex="-1"></a>rr_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb119-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-3" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;RelativeRiskCat&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cat&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Relavtive Risk&quot;</span>, <span class="at">palette =</span> RRPalette, <span class="at">labels =</span> RiskCategorylist) <span class="sc">+</span></span>
<span id="cb119-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-4" tabindex="-1"></a>    <span class="fu">tm_shape</span>(england_Region_shp) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;name&quot;</span>, <span class="at">size =</span> <span class="st">&quot;AREA&quot;</span>) <span class="sc">+</span></span>
<span id="cb119-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-5" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">0.8</span>, <span class="at">legend.text.size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb119-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-6" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb119-7"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-7" tabindex="-1"></a></span>
<span id="cb119-8"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-8" tabindex="-1"></a><span class="co"># map of significance regions</span></span>
<span id="cb119-9"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-9" tabindex="-1"></a>sg_map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb119-10"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-10" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;Significance&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cat&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Significance Categories&quot;</span>, </span>
<span id="cb119-11"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-11" tabindex="-1"></a>        <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&quot;#33a6fe&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;#fe0000&quot;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Significantly low&quot;</span>, <span class="st">&quot;Not Significant&quot;</span>, <span class="st">&quot;Significantly high&quot;</span>)) <span class="sc">+</span></span>
<span id="cb119-12"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-12" tabindex="-1"></a>    <span class="fu">tm_shape</span>(england_Region_shp) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.10</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;name&quot;</span>, <span class="at">size =</span> <span class="st">&quot;AREA&quot;</span>) <span class="sc">+</span></span>
<span id="cb119-13"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-13" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">0.8</span>, <span class="at">legend.text.size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb119-14"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-14" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb119-15"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-15" tabindex="-1"></a></span>
<span id="cb119-16"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-16" tabindex="-1"></a><span class="co"># create side-by-side plot</span></span>
<span id="cb119-17"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb119-17" tabindex="-1"></a><span class="fu">tmap_arrange</span>(rr_map, sg_map, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><strong>Output:</strong></p>
<p><img src="images/general/RR_SG.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="extracting-and-mapping-of-the-exceedance-probabilities" class="section level3 hasAnchor" number="6.5.5">
<h3><span class="header-section-number">6.5.5</span> Extracting and mapping of the exceedance probabilities<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#extracting-and-mapping-of-the-exceedance-probabilities" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Exceedance probabilities</strong> allows the user to quantify the levels of uncertainty surrounding the risks we quantified. We can use a threshold for instance an <code>RR &gt; 1</code> and ask what is the probability that an area has an excess risk of road accidents and visualise this as well.</p>
<p>Just like the RRs, we are going to extract this information into a vector and include it into our <code>spatial.data</code> object. For this extraction, we will need to use functions from the tidybayes and tidyverse packages i.e., <code>spread_draws()</code>, <code>group_by()</code>, <code>summarise()</code> and <code>pull()</code>:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-1" tabindex="-1"></a><span class="co"># extract the exceedence probabilities from the icar_possion_fit object</span></span>
<span id="cb120-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-2" tabindex="-1"></a><span class="co"># compute the probability that an area has a relative risk ratio &gt; 1.0</span></span>
<span id="cb120-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-3" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x <span class="sc">&gt;</span> <span class="fl">1.00</span>)}</span>
<span id="cb120-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-4" tabindex="-1"></a>excProbrr <span class="ot">&lt;-</span> icar_poisson_fit <span class="sc">%&gt;%</span> <span class="fu">spread_draws</span>(rr_mu[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb120-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-5" tabindex="-1"></a>    <span class="fu">group_by</span>(i) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">rr_mu=</span><span class="fu">threshold</span>(rr_mu)) <span class="sc">%&gt;%</span></span>
<span id="cb120-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-6" tabindex="-1"></a>    <span class="fu">pull</span>(rr_mu)</span>
<span id="cb120-7"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-7" tabindex="-1"></a></span>
<span id="cb120-8"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-8" tabindex="-1"></a><span class="co"># insert the exceedance values into the spatial data frame</span></span>
<span id="cb120-9"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb120-9" tabindex="-1"></a>spatial.data<span class="sc">$</span>excProb <span class="ot">&lt;-</span> excProbrr</span></code></pre></div>
<p>The next set of codes are all cosmetics for the creating our probability exceedance map for road accidents. Here is the code:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-1" tabindex="-1"></a><span class="co"># create the labels for the probabilities</span></span>
<span id="cb121-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-2" tabindex="-1"></a>ProbCategorylist <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;&lt;0.01&quot;</span>, <span class="st">&quot;0.01-0.09&quot;</span>, <span class="st">&quot;0.10-0.19&quot;</span>, <span class="st">&quot;0.20-0.29&quot;</span>, <span class="st">&quot;0.30-0.39&quot;</span>, <span class="st">&quot;0.40-0.49&quot;</span>,<span class="st">&quot;0.50-0.59&quot;</span>, <span class="st">&quot;0.60-0.69&quot;</span>, <span class="st">&quot;0.70-0.79&quot;</span>, <span class="st">&quot;0.80-0.89&quot;</span>, <span class="st">&quot;0.90-0.99&quot;</span>, <span class="st">&quot;1.00&quot;</span>)</span>
<span id="cb121-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-3" tabindex="-1"></a></span>
<span id="cb121-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-4" tabindex="-1"></a><span class="co"># categorising the probabilities in bands of 10s</span></span>
<span id="cb121-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-5" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb121-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-6" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="dv">0</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.01</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb121-7"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-7" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.01</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.10</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb121-8"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-8" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.10</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.20</span>] <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb121-9"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-9" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.20</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.30</span>] <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb121-10"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-10" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.30</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.40</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb121-11"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-11" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.40</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.50</span>] <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb121-12"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-12" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.50</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.60</span>] <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb121-13"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-13" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.60</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.70</span>] <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb121-14"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-14" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.70</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.80</span>] <span class="ot">&lt;-</span> <span class="dv">9</span></span>
<span id="cb121-15"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-15" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.80</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">0.90</span>] <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb121-16"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-16" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb<span class="sc">&gt;=</span><span class="fl">0.90</span> <span class="sc">&amp;</span> spatial.data<span class="sc">$</span>excProb<span class="sc">&lt;</span> <span class="fl">1.00</span>] <span class="ot">&lt;-</span> <span class="dv">11</span></span>
<span id="cb121-17"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-17" tabindex="-1"></a>spatial.data<span class="sc">$</span>ProbCat[spatial.data<span class="sc">$</span>excProb <span class="sc">==</span> <span class="fl">1.00</span>] <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb121-18"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-18" tabindex="-1"></a></span>
<span id="cb121-19"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-19" tabindex="-1"></a><span class="co"># check to see if legend scheme is balanced</span></span>
<span id="cb121-20"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb121-20" tabindex="-1"></a><span class="fu">table</span>(spatial.data<span class="sc">$</span>ProbCat)</span></code></pre></div>
<p>Generating the probability map output:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb122-1" tabindex="-1"></a><span class="co"># map of exceedance probabilities</span></span>
<span id="cb122-2"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb122-2" tabindex="-1"></a><span class="fu">tm_shape</span>(spatial.data) <span class="sc">+</span> </span>
<span id="cb122-3"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb122-3" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">&quot;ProbCat&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cat&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Probability&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;GnBu&quot;</span>, <span class="at">labels =</span> ProbCategorylist) <span class="sc">+</span></span>
<span id="cb122-4"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb122-4" tabindex="-1"></a>    <span class="fu">tm_shape</span>(england_Region_shp) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">border.col =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> <span class="fu">tm_text</span>(<span class="st">&quot;name&quot;</span>, <span class="at">size =</span> <span class="st">&quot;AREA&quot;</span>) <span class="sc">+</span></span>
<span id="cb122-5"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb122-5" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="at">legend.title.size =</span> <span class="fl">0.8</span>, <span class="at">legend.text.size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb122-6"><a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#cb122-6" tabindex="-1"></a>    <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span></code></pre></div>
<p><strong>Output:</strong></p>
<p><img src="images/general/probability_map.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="note">
<p><strong>Example Interpretation:</strong> We can see that the risk patterns for road accidents across England is quite heterogeneous. While it is quite pronounced in all 10 regions in England, the burden is quite significant in South West region with large numbers of local authorities having an increased risk which are statistically significant. While, there’s significant limitation the models used here - perhaps, the Department for Transport should do an investigation on these patterns starting with the South West area.</p>
</div>
</div>
</div>
<div id="task-1" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> Task<a href="bayesian-spatial-modelling-for-areal-data-in-stan.html#task-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Try your hand on this problem in Stan</strong>: Build a spatial ICAR model using data on counts of low birth weights in Georgia US to create the following maps:</p>
<ol style="list-style-type: decimal">
<li>Map showing the relative risk of low birth weight across the 163 counties in Georgia</li>
<li>Map showing the statistical significance of the relative risk</li>
<li>Map showing the Exceedance Probabilities using the threshold of RR &gt; 1</li>
</ol>
<p>Use the following dataset:</p>
<ul>
<li><code>Low_birth_weights_data.csv</code>: Contains <code>NAME</code>, <code>Lowbirths</code> (Counts) and <code>ExpectedNumber</code><br />
</li>
<li><code>Georgia_Shapefile.shp</code>: Contains <code>NAME</code></li>
</ul>
<p>Try to complete this without consulting the solutions.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian-hierarchical-regression-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="bayesian-updating-spatial-temporal-modelling.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/UCLPG-MSC-SGDS/GEOG0125/edit/main/Intro_to_Bayesian_ICAR_Regression.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
